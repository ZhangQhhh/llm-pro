# å¤šè½®å¯¹è¯åŠŸèƒ½è¯¦ç»†ä½¿ç”¨è¯´æ˜

> **ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°æ—¥æœŸ**: 2025-01-20  
> **çŠ¶æ€**: âœ… å·²å®Œæ•´å®ç°å¹¶é›†æˆåˆ°å‘é‡æ•°æ®åº“

---

## ğŸ“‹ åŠŸèƒ½å®ç°çŠ¶æ€

### âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å•

- [x] **å¯¹è¯ç®¡ç†å™¨** (`ConversationManager`) - å®Œæ•´å®ç°
- [x] **å‘é‡æ•°æ®åº“å­˜å‚¨** - Qdranté›†åˆ `conversations`
- [x] **ä¼šè¯éš”ç¦»** - ç‹¬ç«‹çš„ session_id æœºåˆ¶
- [x] **å‘é‡å¬å›** - åŸºäºè¯­ä¹‰çš„å†å²å¯¹è¯æ£€ç´¢
- [x] **æ»‘åŠ¨çª—å£** - ä¿ç•™æœ€è¿‘Nè½®å¯¹è¯
- [x] **çŸ¥è¯†åº“å¢å¼º** - RAGæ£€ç´¢ç»“åˆå¯¹è¯å†å²
- [x] **æç¤ºè¯ç®¡ç†** - prompts.jsonç»Ÿä¸€é…ç½®
- [x] **APIæ¥å£** - `/api/knowledge_chat_conversation`
- [x] **ä¼šè¯æ¸…ç†** - `/api/conversation/clear`
- [x] **ä¸Šä¸‹æ–‡æ„å»º** - æ™ºèƒ½åˆå¹¶ç›¸å…³å†å²å’Œæœ€è¿‘å¯¹è¯
- [x] **InsertBlocké›†æˆ** - æ”¯æŒæ™ºèƒ½èŠ‚ç‚¹è¿‡æ»¤

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·æé—®
   â†“
[API: /api/knowledge_chat_conversation]
   â†“
[KnowledgeHandler.process_conversation]
   â†“
   â”œâ”€â†’ 1. æ··åˆæ£€ç´¢ï¼ˆçŸ¥è¯†åº“ï¼‰
   â”œâ”€â†’ 2. InsertBlockè¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
   â”œâ”€â†’ 3. å‘é‡å¬å›å†å²å¯¹è¯
   â”œâ”€â†’ 4. è·å–æœ€è¿‘å¯¹è¯
   â”œâ”€â†’ 5. æ„å»ºmessagesæ•°ç»„
   â”œâ”€â†’ 6. è°ƒç”¨LLMç”Ÿæˆå›ç­”
   â”œâ”€â†’ 7. å­˜å‚¨åˆ°Qdrantå‘é‡åº“
   â””â”€â†’ 8. è¿”å›SSEæµ
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. ConversationManagerï¼ˆå¯¹è¯ç®¡ç†å™¨ï¼‰

**ä½ç½®**: `services/conversation_manager.py`

**æ ¸å¿ƒæ–¹æ³•**:

#### `add_conversation_turn(session_id, user_query, assistant_response, context_docs)`
- **åŠŸèƒ½**: å­˜å‚¨ä¸€è½®å¯¹è¯åˆ°Qdrantå‘é‡åº“
- **å­˜å‚¨å†…å®¹**: 
  - å¯¹è¯æ–‡æœ¬å‘é‡
  - ä¼šè¯ID
  - ç”¨æˆ·é—®é¢˜
  - åŠ©æ‰‹å›ç­”
  - æ—¶é—´æˆ³
  - ä½¿ç”¨çš„æ–‡æ¡£åˆ—è¡¨

#### `retrieve_relevant_history(session_id, current_query, top_k=3)`
- **åŠŸèƒ½**: åŸºäºè¯­ä¹‰æ£€ç´¢ç›¸å…³å†å²å¯¹è¯
- **æœºåˆ¶**: å¯¹å½“å‰é—®é¢˜è¿›è¡Œå‘é‡åŒ–ï¼Œæ£€ç´¢æœ€ç›¸ä¼¼çš„å†å²å¯¹è¯
- **èŒƒå›´**: ä»…é™å½“å‰ä¼šè¯å†…

#### `get_recent_history(session_id, limit=5)`
- **åŠŸèƒ½**: è·å–æœ€è¿‘Nè½®å¯¹è¯
- **æ’åº**: æŒ‰æ—¶é—´å‡åºï¼ˆæ—§â†’æ–°ï¼‰

#### `build_context_messages(...)`
- **åŠŸèƒ½**: æ„å»ºå®Œæ•´çš„messagesæ•°ç»„
- **ç­–ç•¥**: 
  1. æ·»åŠ ç³»ç»Ÿæç¤ºè¯
  2. æ’å…¥ç›¸å…³å†å²å¯¹è¯ï¼ˆå‘é‡å¬å›ï¼‰
  3. æ’å…¥æœ€è¿‘å¯¹è¯ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
  4. æ’å…¥çŸ¥è¯†åº“æ£€ç´¢ç»“æœ
  5. æ·»åŠ å½“å‰ç”¨æˆ·é—®é¢˜

---

### 2. å‘é‡æ•°æ®åº“å­˜å‚¨ç»“æ„

**é›†åˆåç§°**: `conversations` (é…ç½®: `Settings.CONVERSATION_COLLECTION`)

**æ•°æ®ç»“æ„**:
```json
{
  "vector": [0.123, 0.456, ...],  // 768ç»´åº¦å‘é‡ï¼ˆæ ¹æ®embeddingæ¨¡å‹ï¼‰
  "payload": {
    "session_id": "uuid-string",
    "user_query": "ç”¨æˆ·çš„åŸå§‹é—®é¢˜",
    "assistant_response": "åŠ©æ‰‹çš„å®Œæ•´å›ç­”",
    "timestamp": "2025-01-20T10:30:00.123456",
    "context_docs": ["æ–‡ä»¶1.pdf", "æ–‡ä»¶2.docx"]
  }
}
```

**è‡ªåŠ¨åˆ›å»º**: ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºé›†åˆï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

---

## ğŸš€ APIæ¥å£è¯¦è§£

### 1. å¤šè½®å¯¹è¯æ¥å£

**ç«¯ç‚¹**: `POST /api/knowledge_chat_conversation`

**è¯·æ±‚å‚æ•°**:
```json
{
  "question": "ç”¨æˆ·é—®é¢˜ï¼ˆå¿…å¡«ï¼‰",
  "session_id": "ä¼šè¯IDï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰",
  "thinking": true,
  "model_id": "qwen3-32b",
  "rerank_top_n": 10,
  "use_insert_block": false,
  "insert_block_llm_id": null
}
```

**å‚æ•°è¯´æ˜**:
- `question`: ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œä¸èƒ½ä¸ºç©ºï¼‰
- `session_id`: ä¼šè¯æ ‡è¯†ç¬¦
  - é¦–æ¬¡å¯¹è¯ï¼šä¸æä¾›ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”ŸæˆUUID
  - åç»­å¯¹è¯ï¼šä½¿ç”¨é¦–æ¬¡è¿”å›çš„session_id
- `thinking`: æ˜¯å¦å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆtrue/falseï¼‰
- `model_id`: ä½¿ç”¨çš„LLMæ¨¡å‹IDï¼ˆé»˜è®¤: qwen3-32bï¼‰
- `rerank_top_n`: é‡æ’åºåè¿”å›çš„æ–‡æ¡£æ•°é‡ï¼ˆ1-15ï¼Œé»˜è®¤10ï¼‰
- `use_insert_block`: æ˜¯å¦å¯ç”¨InsertBlockæ™ºèƒ½è¿‡æ»¤ï¼ˆtrue/falseï¼‰
- `insert_block_llm_id`: InsertBlockä½¿ç”¨çš„æ¨¡å‹IDï¼ˆå¯é€‰ï¼‰

**å“åº”æ ¼å¼ï¼ˆSSEæµï¼‰**:
```
data: SESSION:abc123-def456-ghi789  // ä¼šè¯IDï¼ˆé¦–æ¬¡ä¼šè¿”å›ï¼‰
data: CONTENT:æ­£åœ¨è¿›è¡Œæ··åˆæ£€ç´¢...
data: CONTENT:å·²æ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œæ­£åœ¨ç”Ÿæˆå›ç­”...
data: CONTENT:æ ¹æ®ä¸šåŠ¡è§„å®š...ï¼ˆå®é™…å›ç­”å†…å®¹ï¼‰
data: SOURCE:{"id":1,"fileName":"è§„å®š.pdf",...}
data: DONE:
```

**SSEæ¶ˆæ¯ç±»å‹**:
- `SESSION:` - ä¼šè¯IDï¼ˆä»…é¦–æ¬¡æˆ–æ–°ä¼šè¯æ—¶è¿”å›ï¼‰
- `CONTENT:` - æ–‡æœ¬å†…å®¹ï¼ˆçŠ¶æ€ä¿¡æ¯æˆ–å›ç­”å†…å®¹ï¼‰
- `SOURCE:` - å‚è€ƒæ¥æºï¼ˆJSONæ ¼å¼ï¼‰
- `ERROR:` - é”™è¯¯ä¿¡æ¯
- `DONE:` - æµç»“æŸæ ‡è®°

---

### 2. æ¸…ç©ºä¼šè¯æ¥å£

**ç«¯ç‚¹**: `POST /api/conversation/clear`

**è¯·æ±‚å‚æ•°**:
```json
{
  "session_id": "è¦æ¸…ç©ºçš„ä¼šè¯ID"
}
```

**å“åº”**:
```json
{
  "type": "success",
  "message": "ä¼šè¯ abc123... å·²æ¸…ç©º"
}
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### 1. config/settings.py

```python
# å¯¹è¯ç®¡ç†é…ç½®
CONVERSATION_COLLECTION = "conversations"  # Qdrantå¯¹è¯é›†åˆå
MAX_RECENT_TURNS = 3                       # ä¿ç•™æœ€è¿‘Nè½®å¯¹è¯ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
MAX_RELEVANT_TURNS = 2                     # å‘é‡æ£€ç´¢ç›¸å…³å¯¹è¯æ•°é‡
```

**è°ƒä¼˜å»ºè®®**:
- `MAX_RECENT_TURNS`: 3-5è½®é€‚åˆå¤§å¤šæ•°åœºæ™¯
- `MAX_RELEVANT_TURNS`: 2-3æ¡é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿
- æ€»Tokenæ•° â‰ˆ (MAX_RECENT_TURNS + MAX_RELEVANT_TURNS) Ã— å¹³å‡å¯¹è¯é•¿åº¦

---

### 2. prompts.json é…ç½®

**å¯¹è¯æç¤ºè¯é…ç½®** (`conversation` èŠ‚ç‚¹):

```json
{
  "conversation": {
    "system": {
      "rag_with_history": [
        "ä½ æ˜¯ä¸€åèµ„æ·±è¾¹æ£€ä¸šåŠ¡ä¸“å®¶ã€‚è¯·æ ¹æ®ä¸‹æ–¹æä¾›çš„ä¸šåŠ¡è§„å®šå’Œå¯¹è¯å†å²ï¼Œå›ç­”ç”¨æˆ·çš„ä¸šåŠ¡å’¨è¯¢ã€‚",
        "# è§„åˆ™",
        "1. ä½ çš„å›ç­”å¿…é¡»ä¸¥æ ¼ä¾æ®ä¸šåŠ¡è§„å®šã€‚",
        "2. åœ¨å›ç­”ä¸­å¼•ç”¨è§„å®šè¦ç‚¹æ—¶ï¼Œè¯·åœ¨å¥æœ«ç”¨ [æ¥æº N] æ ‡æ³¨å‡ºå¤„ã€‚",
        "3. å¦‚æœè§„å®šæœªèƒ½è¦†ç›–é—®é¢˜ï¼Œè¯·æ˜ç¡®æŒ‡å‡º\"æ ¹æ®ç°æœ‰è§„å®šæ— æ³•å›ç­”æ­¤é—®é¢˜\"ã€‚",
        "4. å¦‚æœç”¨æˆ·æåˆ°\"å®ƒ\"ã€\"è¿™ä¸ª\"ç­‰ä»£è¯ï¼Œè¯·ç»“åˆå¯¹è¯å†å²ç†è§£æŒ‡ä»£å†…å®¹ã€‚",
        "5. ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œä¸Šä¸‹æ–‡ç†è§£ã€‚"
      ],
      "general_with_history": [
        "ä½ æ˜¯ä¸€åèµ„æ·±è¾¹æ£€ä¸šåŠ¡ä¸“å®¶ã€‚è¯·ç»“åˆå¯¹è¯å†å²ï¼Œå›ç­”ç”¨æˆ·çš„ä¸šåŠ¡å’¨è¯¢ã€‚",
        "# è§„åˆ™",
        "1. å¦‚æœç”¨æˆ·æåˆ°\"å®ƒ\"ã€\"è¿™ä¸ª\"ã€\"é‚£ä¸ª\"ç­‰ä»£è¯ï¼Œè¯·ç»“åˆå¯¹è¯å†å²ç†è§£æŒ‡ä»£å†…å®¹ã€‚",
        "2. ä¿æŒå¯¹è¯çš„è¿è´¯æ€§ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿½é—®ï¼Œè¯·åŸºäºä¹‹å‰çš„å›ç­”ç»§ç»­è§£é‡Šã€‚",
        "3. å¦‚æœé—®é¢˜ä¸ä¹‹å‰è®¨è®ºçš„å†…å®¹ç›¸å…³ï¼Œè¯·ä¸»åŠ¨å…³è”è¯´æ˜ã€‚"
      ]
    },
    "context_prefix": {
      "relevant_history": "ä»¥ä¸‹æ˜¯ç›¸å…³çš„å†å²å¯¹è¯ï¼Œå¯ä½œä¸ºèƒŒæ™¯å‚è€ƒï¼š\n",
      "recent_history": "ä»¥ä¸‹æ˜¯æœ€è¿‘çš„å¯¹è¯å†å²ï¼š\n",
      "regulations": "ä¸šåŠ¡è§„å®šå¦‚ä¸‹ï¼š\n"
    }
  }
}
```

**æç¤ºè¯é€‰æ‹©é€»è¾‘**:
- æœ‰çŸ¥è¯†åº“æ£€ç´¢ç»“æœ â†’ `rag_with_history`
- æ— çŸ¥è¯†åº“æ£€ç´¢ç»“æœ â†’ `general_with_history`

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### Python å®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import json

BASE_URL = "http://localhost:5000"

def chat_with_history():
    """æ¼”ç¤ºå¤šè½®å¯¹è¯åŠŸèƒ½"""
    
    session_id = None  # é¦–æ¬¡å¯¹è¯ä¸éœ€è¦æä¾›
    
    # ç¬¬ä¸€è½®å¯¹è¯
    print("=== ç¬¬ä¸€è½®å¯¹è¯ ===")
    response1 = requests.post(
        f"{BASE_URL}/api/knowledge_chat_conversation",
        json={
            "question": "ä»€ä¹ˆæ˜¯è¾¹æ£€ä¸šåŠ¡ï¼Ÿ",
            "thinking": False,
            "model_id": "qwen3-32b",
            "rerank_top_n": 10
        },
        stream=True
    )
    
    for line in response1.iter_lines():
        if line:
            decoded = line.decode('utf-8')
            if decoded.startswith('data: SESSION:'):
                session_id = decoded.split('SESSION:')[1].strip()
                print(f"ä¼šè¯ID: {session_id}")
            elif decoded.startswith('data: CONTENT:'):
                content = decoded.split('CONTENT:', 1)[1]
                print(content, end='', flush=True)
    
    print("\n\n")
    
    # ç¬¬äºŒè½®å¯¹è¯ï¼ˆè¿½é—®ï¼‰
    print("=== ç¬¬äºŒè½®å¯¹è¯ï¼ˆä½¿ç”¨ä»£è¯è¿½é—®ï¼‰===")
    response2 = requests.post(
        f"{BASE_URL}/api/knowledge_chat_conversation",
        json={
            "question": "å®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ",  # "å®ƒ"ä¼šè‡ªåŠ¨å…³è”ä¸Šæ–‡çš„"è¾¹æ£€ä¸šåŠ¡"
            "session_id": session_id,  # ä½¿ç”¨åŒä¸€ä¼šè¯ID
            "thinking": False,
            "model_id": "qwen3-32b"
        },
        stream=True
    )
    
    for line in response2.iter_lines():
        if line:
            decoded = line.decode('utf-8')
            if decoded.startswith('data: CONTENT:'):
                content = decoded.split('CONTENT:', 1)[1]
                print(content, end='', flush=True)
    
    print("\n\n")
    
    # ç¬¬ä¸‰è½®å¯¹è¯ï¼ˆç»§ç»­è¿½é—®ï¼‰
    print("=== ç¬¬ä¸‰è½®å¯¹è¯ï¼ˆæ·±å…¥è¿½é—®ï¼‰===")
    response3 = requests.post(
        f"{BASE_URL}/api/knowledge_chat_conversation",
        json={
            "question": "å…·ä½“æœ‰å“ªäº›æ‰§æ³•æƒé™ï¼Ÿ",
            "session_id": session_id,
            "thinking": False
        },
        stream=True
    )
    
    for line in response3.iter_lines():
        if line:
            decoded = line.decode('utf-8')
            if decoded.startswith('data: CONTENT:'):
                content = decoded.split('CONTENT:', 1)[1]
                print(content, end='', flush=True)
    
    print("\n\n")
    
    # æ¸…ç©ºä¼šè¯
    print("=== æ¸…ç©ºä¼šè¯ ===")
    clear_response = requests.post(
        f"{BASE_URL}/api/conversation/clear",
        json={"session_id": session_id}
    )
    print(clear_response.json())

if __name__ == "__main__":
    chat_with_history()
```

---

### JavaScript (Fetch API) ç¤ºä¾‹

```javascript
// å¤šè½®å¯¹è¯ç®¡ç†ç±»
class ConversationClient {
    constructor(baseUrl = 'http://localhost:5000') {
        this.baseUrl = baseUrl;
        this.sessionId = null;
    }

    async chat(question, options = {}) {
        const payload = {
            question: question,
            session_id: this.sessionId,
            thinking: options.thinking || false,
            model_id: options.modelId || 'qwen3-32b',
            rerank_top_n: options.rerankTopN || 10,
            use_insert_block: options.useInsertBlock || false
        };

        const response = await fetch(`${this.baseUrl}/api/knowledge_chat_conversation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        let fullResponse = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: SESSION:')) {
                    this.sessionId = line.split('SESSION:')[1].trim();
                    console.log('ä¼šè¯ID:', this.sessionId);
                } else if (line.startsWith('data: CONTENT:')) {
                    const content = line.split('CONTENT:')[1];
                    fullResponse += content;
                    console.log(content); // å®æ—¶è¾“å‡º
                } else if (line.startsWith('data: SOURCE:')) {
                    const sourceData = JSON.parse(line.split('SOURCE:')[1]);
                    console.log('æ¥æº:', sourceData.fileName);
                } else if (line.startsWith('data: DONE:')) {
                    break;
                }
            }
        }

        return fullResponse;
    }

    async clearSession() {
        if (!this.sessionId) return;

        const response = await fetch(`${this.baseUrl}/api/conversation/clear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ session_id: this.sessionId })
        });

        return await response.json();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
async function demo() {
    const client = new ConversationClient();

    // ç¬¬ä¸€è½®
    console.log('=== ç¬¬ä¸€è½® ===');
    await client.chat('ä»€ä¹ˆæ˜¯è¾¹æ£€ä¸šåŠ¡ï¼Ÿ');

    // ç¬¬äºŒè½®ï¼ˆè¿½é—®ï¼‰
    console.log('\n=== ç¬¬äºŒè½® ===');
    await client.chat('å®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ');

    // æ¸…ç©º
    console.log('\n=== æ¸…ç©ºä¼šè¯ ===');
    await client.clearSession();
}

demo();
```

---

## ğŸ” å·¥ä½œæµç¨‹è¯¦è§£

### 1. ä¸Šä¸‹æ–‡æ„å»ºç­–ç•¥

å½“ç”¨æˆ·å‘èµ·ç¬¬Nè½®å¯¹è¯æ—¶ï¼Œç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæ„å»º `messages` æ•°ç»„ï¼š

```python
messages = [
    # 1. ç³»ç»Ÿæç¤ºè¯
    {"role": "system", "content": "ä½ æ˜¯ä¸€åèµ„æ·±è¾¹æ£€ä¸šåŠ¡ä¸“å®¶..."},
    
    # 2. ç›¸å…³å†å²å¯¹è¯ï¼ˆå‘é‡å¬å›ï¼Œå»é‡åï¼‰
    {"role": "system", "content": "ä»¥ä¸‹æ˜¯ç›¸å…³çš„å†å²å¯¹è¯ï¼Œå¯ä½œä¸ºèƒŒæ™¯å‚è€ƒï¼š\n"},
    {"role": "user", "content": "å†å²é—®é¢˜1"},
    {"role": "assistant", "content": "å†å²å›ç­”1"},
    
    # 3. æœ€è¿‘å¯¹è¯å†å²ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
    {"role": "system", "content": "ä»¥ä¸‹æ˜¯æœ€è¿‘çš„å¯¹è¯å†å²ï¼š\n"},
    {"role": "user", "content": "ä¸Šä¸€è½®é—®é¢˜"},
    {"role": "assistant", "content": "ä¸Šä¸€è½®å›ç­”"},
    
    # 4. çŸ¥è¯†åº“æ£€ç´¢ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
    {"role": "system", "content": "ä¸šåŠ¡è§„å®šå¦‚ä¸‹ï¼š\n### æ¥æº1...\n### æ¥æº2..."},
    
    # 5. å½“å‰é—®é¢˜
    {"role": "user", "content": "å½“å‰ç”¨æˆ·é—®é¢˜"}
]
```

### 2. å»é‡é€»è¾‘

- **ä¼˜å…ˆä¿ç•™**: æœ€è¿‘å¯¹è¯ï¼ˆæ—¶é—´æ›´è¿‘ï¼Œæ›´ç›¸å…³ï¼‰
- **å»é‡ä¾æ®**: ç”¨æˆ·é—®é¢˜æ–‡æœ¬ï¼ˆ`user_query`ï¼‰
- **æ•ˆæœ**: é¿å…é‡å¤çš„å¯¹è¯å†å²å ç”¨Token

### 3. Tokenæ§åˆ¶

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹å‚æ•°æ§åˆ¶æ€»Tokenæ•°ï¼š

```
æ€»Token â‰ˆ ç³»ç»Ÿæç¤ºè¯(500) 
        + ç›¸å…³å†å²(MAX_RELEVANT_TURNS Ã— 300)
        + æœ€è¿‘å†å²(MAX_RECENT_TURNS Ã— 300)
        + çŸ¥è¯†åº“ä¸Šä¸‹æ–‡(rerank_top_n Ã— 400)
        + å½“å‰é—®é¢˜(100)
```

**ç¤ºä¾‹é…ç½®**ï¼ˆ32Kæ¨¡å‹ï¼‰:
- `MAX_RELEVANT_TURNS = 2`
- `MAX_RECENT_TURNS = 3`
- `rerank_top_n = 10`
- é¢„ä¼°æ€»Token: 500 + 600 + 900 + 4000 + 100 â‰ˆ 6100 Token

---

## ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: ä»£è¯ç†è§£

```
ç”¨æˆ·: ä»€ä¹ˆæ˜¯è¾¹æ£€ï¼Ÿ
åŠ©æ‰‹: è¾¹æ£€æ˜¯æŒ‡å‡ºå…¥å¢ƒè¾¹é˜²æ£€æŸ¥ï¼Œè´Ÿè´£...

ç”¨æˆ·: å®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ  â† "å®ƒ"æŒ‡ä»£"è¾¹æ£€"
åŠ©æ‰‹: è¾¹æ£€çš„ä¸»è¦èŒè´£åŒ…æ‹¬...  â† æ­£ç¡®ç†è§£æŒ‡ä»£å…³ç³»
```

### åœºæ™¯2: è¿½é—®æ·±åŒ–

```
ç”¨æˆ·: å‡ºå¢ƒéœ€è¦å“ªäº›è¯ä»¶ï¼Ÿ
åŠ©æ‰‹: å‡ºå¢ƒéœ€è¦æŠ¤ç…§ã€ç­¾è¯...

ç”¨æˆ·: ç­¾è¯æœ‰å“ªäº›ç±»å‹ï¼Ÿ  â† è¿½é—®ä¸Šä¸€è½®æåˆ°çš„"ç­¾è¯"
åŠ©æ‰‹: ç­¾è¯ä¸»è¦åˆ†ä¸ºæ—…æ¸¸ç­¾è¯ã€å•†åŠ¡ç­¾è¯...
```

### åœºæ™¯3: è·¨è½®å…³è”

```
ç”¨æˆ·: å„¿ç«¥å‡ºå¢ƒéœ€è¦ä»€ä¹ˆï¼Ÿ
åŠ©æ‰‹: å„¿ç«¥å‡ºå¢ƒéœ€è¦...

[éš”3è½®å¯¹è¯]

ç”¨æˆ·: åˆšæ‰è¯´çš„å„¿ç«¥è¯ä»¶è¦æ±‚èƒ½è¯¦ç»†è¯´æ˜å—ï¼Ÿ  â† å¬å›æ—©æœŸå¯¹è¯
åŠ©æ‰‹: æ ¹æ®ä¹‹å‰è®¨è®ºçš„å„¿ç«¥å‡ºå¢ƒè¦æ±‚...  â† é€šè¿‡å‘é‡å¬å›æ‰¾åˆ°ç›¸å…³å†å²
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¼šè¯ç®¡ç†

**å‰ç«¯è´£ä»»**:
- ç”Ÿæˆæˆ–æ¥æ”¶ `session_id` åï¼Œå­˜å‚¨åœ¨ `localStorage` æˆ– `sessionStorage`
- åŒä¸€ç”¨æˆ·çš„è¿ç»­å¯¹è¯ä½¿ç”¨åŒä¸€ `session_id`
- ä¸åŒç”¨æˆ·å¿…é¡»ä½¿ç”¨ä¸åŒ `session_id`

**ç¤ºä¾‹ (JavaScript)**:
```javascript
// é¦–æ¬¡å¯¹è¯åä¿å­˜
localStorage.setItem('conversation_session_id', sessionId);

// åç»­å¯¹è¯è·å–
const sessionId = localStorage.getItem('conversation_session_id');
```

### 2. éšç§å’Œå®‰å…¨

- âœ… ä¼šè¯éš”ç¦»ï¼šä¸åŒ `session_id` çš„å¯¹è¯å®Œå…¨éš”ç¦»
- âœ… å‘é‡æ£€ç´¢ï¼šä»…åœ¨å½“å‰ä¼šè¯å†…æ£€ç´¢å†å²
- âš ï¸ æ•°æ®æŒä¹…åŒ–ï¼šå¯¹è¯æ°¸ä¹…å­˜å‚¨åœ¨Qdrantï¼Œæ•æ„Ÿåœºæ™¯éœ€å®šæœŸæ¸…ç†
- âš ï¸ æ— è‡ªåŠ¨è¿‡æœŸï¼šéœ€æ‰‹åŠ¨è°ƒç”¨æ¸…ç©ºæ¥å£æˆ–å®ç°å®šæ—¶æ¸…ç†

### 3. æ€§èƒ½ä¼˜åŒ–

**å‘é‡æ£€ç´¢ä¼˜åŒ–**:
- å¯¹è¯æ–‡æœ¬è¾ƒçŸ­ï¼Œå‘é‡åŒ–é€Ÿåº¦å¿«ï¼ˆ<50msï¼‰
- Qdrantä½¿ç”¨è¿‡æ»¤å™¨é™å®šä¼šè¯ï¼Œæ£€ç´¢æ•ˆç‡é«˜
- å•ä¼šè¯å¯¹è¯æ•°å»ºè®® <100è½®

**Tokenä¼˜åŒ–**:
- ä½¿ç”¨æ»‘åŠ¨çª—å£ä¸¢å¼ƒæ—©æœŸå¯¹è¯
- å‘é‡å¬å›ä»…è¿”å›é«˜ç›¸å…³æ€§å†å²
- åˆå¹¶å»é‡é¿å…é‡å¤ä¸Šä¸‹æ–‡

### 4. é”™è¯¯å¤„ç†

**å¯¹è¯ç®¡ç†å™¨æœªåˆå§‹åŒ–**:
```python
# æ£€æŸ¥ app.py æ˜¯å¦åŒ…å«ä»¥ä¸‹ä»£ç 
knowledge_service.initialize_conversation_manager()
```

**Qdrantè¿æ¥å¤±è´¥**:
```bash
# æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€
docker ps | findstr qdrant

# å¯åŠ¨å®¹å™¨
docker start qdrant
```

**ä¼šè¯ä¸å­˜åœ¨**:
- é¦–æ¬¡å¯¹è¯ä¸æä¾› `session_id`
- ä½¿ç”¨ä¸å­˜åœ¨çš„ `session_id` ä¼šåˆ›å»ºæ–°ä¼šè¯

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—æŸ¥çœ‹

**å¯¹è¯å­˜å‚¨æ—¥å¿—**:
```
[INFO] ä¼šè¯ abc123-def456-ghi789 å¯¹è¯å·²å­˜å‚¨
```

**å†å²æ£€ç´¢æ—¥å¿—**:
```
[INFO] æ£€ç´¢åˆ° 2 æ¡ç›¸å…³å†å²
[INFO] è·å–åˆ° 3 æ¡æœ€è¿‘å¯¹è¯
```

**æ¶ˆæ¯æ„å»ºæ—¥å¿—**:
```
[INFO] ä½¿ç”¨å¤šè½®å¯¹è¯æ¨¡å¼è°ƒç”¨ LLM, æ¶ˆæ¯æ•°: 12
```

### 2. Qdrantç®¡ç†ç•Œé¢

è®¿é—®: `http://localhost:6333/dashboard`

- æŸ¥çœ‹ `conversations` é›†åˆ
- æ£€æŸ¥å‘é‡æ•°é‡
- æŸ¥çœ‹å•ä¸ªå¯¹è¯payload

### 3. è°ƒè¯•æŠ€å·§

**æ‰“å°messagesæ•°ç»„**ï¼ˆä¸´æ—¶è°ƒè¯•ï¼‰:
```python
# åœ¨ knowledge_handler.py ä¸­æ·»åŠ 
logger.debug(f"æ„å»ºçš„messages: {json.dumps(messages, ensure_ascii=False, indent=2)}")
```

---

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„å…³ç³»

### å¤šè½®å¯¹è¯ vs å•è½®å¯¹è¯

| ç‰¹æ€§ | å•è½®å¯¹è¯ (`/api/knowledge_chat`) | å¤šè½®å¯¹è¯ (`/api/knowledge_chat_conversation`) |
|------|----------------------------------|----------------------------------------------|
| ä¼šè¯è®°å¿† | âŒ æ—  | âœ… æœ‰ |
| å†å²å¬å› | âŒ æ—  | âœ… å‘é‡æ£€ç´¢ |
| ä»£è¯ç†è§£ | âŒ æ— æ³•ç†è§£ | âœ… è‡ªåŠ¨å…³è” |
| è¿½é—®èƒ½åŠ› | âŒ æ—  | âœ… ä¸Šä¸‹æ–‡è¿è´¯ |
| å­˜å‚¨ | âŒ ä¸å­˜å‚¨ | âœ… å­˜å…¥Qdrant |
| ä½¿ç”¨åœºæ™¯ | ç‹¬ç«‹é—®ç­” | è¿ç»­å¯¹è¯ |

### InsertBlocké›†æˆ

å¤šè½®å¯¹è¯å®Œå…¨æ”¯æŒInsertBlockæ™ºèƒ½è¿‡æ»¤ï¼š

```json
{
  "question": "å®ƒçš„èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿ",
  "session_id": "abc123...",
  "use_insert_block": true,
  "insert_block_llm_id": "qwen3-32b"
}
```

- InsertBlockè¿‡æ»¤ä»…ä½œç”¨äºçŸ¥è¯†åº“æ£€ç´¢
- å¯¹è¯å†å²ä¸å—InsertBlockå½±å“
- è¿‡æ»¤ç»“æœç…§å¸¸å­˜å‚¨åˆ°å‘é‡åº“

---

## ğŸš€ æœªæ¥æ‰©å±•æ–¹å‘

### 1. å¯¹è¯æ‘˜è¦ï¼ˆå¯é€‰ï¼‰

å½“å¯¹è¯å†å²è¶…é•¿æ—¶ï¼Œå¯å®ç°æ‘˜è¦åŠŸèƒ½ï¼š

```python
def summarize_history(self, session_id: str) -> str:
    """ç”Ÿæˆå¯¹è¯æ‘˜è¦ï¼Œå‹ç¼©å†å²ä¿¡æ¯"""
    history = self.get_recent_history(session_id, limit=10)
    # è°ƒç”¨LLMç”Ÿæˆæ‘˜è¦
    summary = llm.complete(f"è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒå†…å®¹ï¼š\n{history}")
    return summary
```

### 2. å¯¹è¯å¯¼å‡º

```python
def export_conversation(self, session_id: str, format='json'):
    """å¯¼å‡ºå®Œæ•´å¯¹è¯è®°å½•"""
    history = self.get_recent_history(session_id, limit=1000)
    if format == 'json':
        return json.dumps(history, ensure_ascii=False, indent=2)
    elif format == 'markdown':
        # æ ¼å¼åŒ–ä¸ºMarkdown
        pass
```

### 3. å®šæ—¶æ¸…ç†

```python
def cleanup_old_conversations(self, days=30):
    """æ¸…ç†Nå¤©å‰çš„å¯¹è¯"""
    cutoff_time = datetime.now() - timedelta(days=days)
    # åˆ é™¤æ—§å¯¹è¯
```

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### ç³»ç»Ÿå¯åŠ¨æ£€æŸ¥

- [ ] QdrantæœåŠ¡è¿è¡Œæ­£å¸¸ (`docker ps`)
- [ ] å¯¹è¯é›†åˆè‡ªåŠ¨åˆ›å»º (`conversations`)
- [ ] å¯¹è¯ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸï¼ˆæ—¥å¿—ï¼‰

### åŠŸèƒ½æµ‹è¯•

- [ ] é¦–æ¬¡å¯¹è¯è¿”å› `SESSION:xxx`
- [ ] ä½¿ç”¨session_idè¿›è¡Œç¬¬äºŒè½®å¯¹è¯
- [ ] ä»£è¯"å®ƒ"ã€"è¿™ä¸ª"æ­£ç¡®ç†è§£
- [ ] è¿½é—®é—®é¢˜èƒ½å…³è”ä¸Šæ–‡
- [ ] æ¸…ç©ºä¼šè¯æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] Qdrantä¸­çœ‹åˆ°å­˜å‚¨çš„å¯¹è¯è®°å½•

### æ€§èƒ½æµ‹è¯•

- [ ] å•è½®å¯¹è¯å»¶è¿Ÿ <2ç§’
- [ ] å‘é‡æ£€ç´¢å»¶è¿Ÿ <100ms
- [ ] 10è½®å¯¹è¯åå“åº”é€Ÿåº¦æ­£å¸¸
- [ ] å¹¶å‘5ä¸ªä¼šè¯æ— å¼‚å¸¸

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

**Q1: å¯¹è¯å†å²æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ**
- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ `session_id`
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯¹è¯æ˜¯å¦å­˜å‚¨æˆåŠŸ
- éªŒè¯Qdrantä¸­æ˜¯å¦æœ‰æ•°æ®

**Q2: Tokenè¶…é™é”™è¯¯ï¼Ÿ**
- å‡å°‘ `MAX_RECENT_TURNS` å’Œ `MAX_RELEVANT_TURNS`
- é™ä½ `rerank_top_n` å€¼
- ä½¿ç”¨æ›´å¤§ä¸Šä¸‹æ–‡çª—å£çš„æ¨¡å‹

**Q3: ä»£è¯ç†è§£ä¸å‡†ç¡®ï¼Ÿ**
- æ£€æŸ¥å‘é‡å¬å›æ˜¯å¦æ‰¾åˆ°ç›¸å…³å†å²
- è°ƒæ•´ `MAX_RELEVANT_TURNS` å¢åŠ å¬å›æ•°é‡
- ä¼˜åŒ–æç¤ºè¯ä¸­çš„ä»£è¯ç†è§£è§„åˆ™

**Q4: å¦‚ä½•é‡ç½®æŸä¸ªä¼šè¯ï¼Ÿ**
```bash
curl -X POST http://localhost:5000/api/conversation/clear \
  -H "Content-Type: application/json" \
  -d '{"session_id": "your-session-id"}'
```

---

## ğŸ‰ æ€»ç»“

å¤šè½®å¯¹è¯åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶é›†æˆåˆ°RAGç³»ç»Ÿä¸­ï¼ŒåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„å¯¹è¯ç®¡ç†å™¨** - å­˜å‚¨ã€æ£€ç´¢ã€ä¸Šä¸‹æ–‡æ„å»º  
âœ… **å‘é‡æ•°æ®åº“é›†æˆ** - Qdrantå­˜å‚¨æ‰€æœ‰å¯¹è¯  
âœ… **æ™ºèƒ½å¬å›æœºåˆ¶** - å‘é‡æ£€ç´¢ + æ»‘åŠ¨çª—å£  
âœ… **ç»Ÿä¸€æç¤ºè¯ç®¡ç†** - prompts.jsoné…ç½®  
âœ… **å®Œå–„çš„APIæ¥å£** - SSEæµå¼å“åº”  
âœ… **ä¼šè¯éš”ç¦»** - å¤šç”¨æˆ·ç‹¬ç«‹å¯¹è¯  
âœ… **çŸ¥è¯†åº“å¢å¼º** - RAG + å¯¹è¯å†å²  
âœ… **InsertBlockå…¼å®¹** - æ™ºèƒ½èŠ‚ç‚¹è¿‡æ»¤  

**ç«‹å³å¼€å§‹ä½¿ç”¨**: `POST /api/knowledge_chat_conversation`

---

**ç‰ˆæœ¬å†å²**:
- v1.0 (2025-01-20): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´åŠŸèƒ½å®ç°

