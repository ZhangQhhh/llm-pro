# 航司知识库策略更新说明

## 更新时间
2025-01-31

## 更新内容

### 核心变更
将航司问题的检索策略从"只查航司库"改为**"航司库 + 通用库保底"**。

### 变更原因
用户需求：即使问题是航司相关的，通用库也要至少返回5条内容。

### 实现方式

#### 修改前
```python
def retrieve_airline_only(self, query: str):
    """只从航司库检索"""
    airline_nodes = self.airline_retriever.retrieve(query)
    return airline_nodes
```

#### 修改后
```python
def retrieve_airline_only(self, query: str):
    """航司库 + 通用库保底检索"""
    # 1. 检索航司库
    airline_nodes = self.airline_retriever.retrieve(query)
    
    # 2. 检索通用库（保底）
    general_nodes = self.general_retriever.retrieve(query)
    
    # 3. 合并策略（15条总计）
    airline_top = airline_nodes[:5]      # 前5条：航司库最高分
    general_top = general_nodes[:5]      # 中5条：通用库最高分（保底）
    remaining_top = remaining_all[:5]    # 后5条：综合比较
    
    # 4. 合并并按分数排序
    merged = airline_top + general_top + remaining_top
    merged.sort(key=lambda x: x.score, reverse=True)
    
    return merged
```

## 检索策略详解

### 15条结果分配

| 位置 | 来源 | 数量 | 说明 |
|------|------|------|------|
| 前5条 | 航司库 | 5条 | 专业航司协议内容，优先展示 |
| 中5条 | 通用库 | 5条 | **保底策略**，确保基础知识覆盖 |
| 后5条 | 综合比较 | 5条 | 从两库剩余文档中取最高分 |

### 优势分析

#### 1. 专业内容优先
- 航司库的前5条最高分内容优先展示
- 确保专业民航协议信息不被稀释

#### 2. 通用知识保底
- 通用库强制返回5条内容
- 避免航司库内容过于专业导致信息缺失
- 提供边检业务的基础知识和流程

#### 3. 灵活综合
- 后5条从两库剩余内容中综合比较
- 根据实际得分灵活分配
- 确保最相关内容不遗漏

#### 4. 质量保证
- 最终按得分重新排序
- 高质量内容自然排在前面
- 用户获得最相关的答案

## 实际效果示例

### 问题: "执行中美航班的机组人员需要签证吗？"

#### 返回结果分布（预期）
```
[1] 航司库 - 中国与美国民航协议（得分: 0.92）
[2] 航司库 - 执行协议航班机组人员规定（得分: 0.89）
[3] 通用库 - 签证办理基本流程（得分: 0.85）
[4] 航司库 - 机组人员免签条件（得分: 0.83）
[5] 通用库 - 出入境证件要求（得分: 0.81）
[6] 航司库 - 替班机组人员规定（得分: 0.79）
[7] 通用库 - 边检查验程序（得分: 0.77）
[8] 航司库 - 包机机组人员规定（得分: 0.75）
[9] 通用库 - 签证类型说明（得分: 0.73）
[10] 综合 - 相关补充内容（得分: 0.71）
...
[15] 综合 - 相关补充内容（得分: 0.62）
```

#### 内容覆盖
- ✅ 专业民航协议（航司库）
- ✅ 签证办理流程（通用库）
- ✅ 边检查验程序（通用库）
- ✅ 证件要求说明（通用库）
- ✅ 相关补充信息（综合）

## 日志输出示例

```
[INFO] [航司检索] 查询: 执行中美航班的机组人员需要签证吗？
[INFO] [航司检索] 策略: 航司库 + 通用库（保底5条）
[INFO] [航司检索] 航司库返回 30 条
[INFO] [航司检索] 通用库返回 30 条（保底）
[INFO] [航司检索] 合并完成 | 最终返回 15 条 (航司8条 + 通用7条)
```

## 影响范围

### 修改文件
- ✅ `core/multi_kb_retriever.py` - 修改 `retrieve_airline_only()` 方法

### 更新文档
- ✅ `docs/AIRLINE_KB_README.md` - 更新检索策略说明
- ✅ `AIRLINE_KB_IMPLEMENTATION_SUMMARY.md` - 更新实现总结
- ✅ `AIRLINE_KB_UPDATE_NOTES.md` - 本变更说明（新增）

### 无需修改
- ⊘ 配置文件（`config/settings.py`）
- ⊘ 意图分类器（`core/intent_classifier.py`）
- ⊘ 提示词（`prompts.py`）
- ⊘ 知识问答处理器（`api/knowledge_handler.py`）

## 兼容性

### 向后兼容
- ✅ 完全兼容现有代码
- ✅ 不影响免签库和通用库的检索
- ✅ 不改变意图分类逻辑
- ✅ 不影响其他检索策略

### 升级步骤
无需特殊升级步骤，代码更新后自动生效。

## 测试建议

### 1. 功能测试
```bash
# 测试航司问题
python tests/test_airline_intent.py
```

### 2. 检索测试
测试问题：
- "执行中美航班的机组人员需要签证吗？"
- "民航办事处常驻人员如何办理签证？"
- "飞往日本的机组人员入境要求是什么？"

验证点：
- ✅ 返回15条结果
- ✅ 至少包含5条通用库内容
- ✅ 航司内容优先排序
- ✅ 日志显示"保底"策略

### 3. 日志验证
检查日志中是否出现：
```
[航司检索] 策略: 航司库 + 通用库（保底5条）
[航司检索] 通用库返回 X 条（保底）
[航司检索] 合并完成 | 最终返回 15 条 (航司X条 + 通用X条)
```

## 总结

这次更新确保了航司问题的回答更加全面：
- ✅ 保留航司专业内容的优先级
- ✅ 强制包含通用知识库的基础信息
- ✅ 灵活分配剩余内容
- ✅ 按得分排序保证质量

用户将获得更完整、更全面的答案，既有专业的民航协议内容，也有基础的边检业务知识。
