# 多轮对话流程详解

##  配置参数说明

在 `config/settings.py` 中，有以下对话管理配置：

```python
# 对话管理配置
MAX_RECENT_TURNS = 5      # 最近对话轮数：保留最近N轮完整对话
MAX_RELEVANT_TURNS = 3    # 相关对话轮数：通过向量检索找到的相关历史对话数量
CONVERSATION_EXPIRE_DAYS = 7  # 对话过期天数
```

### 参数作用

- **MAX_RECENT_TURNS (默认5)**: 
  - 保留时间上最近的N轮对话
  - 用于保持对话的连贯性和上下文
  - 这些对话会完整展示给LLM

- **MAX_RELEVANT_TURNS (默认3)**:
  - 通过向量检索找到与当前问题最相关的历史对话
  - 即使这些对话不在最近3轮内，也会被检索出来
  - 用于处理跨轮次的主题回溯

- **历史摘要**:
  - 超过 MAX_RECENT_TURNS 的旧对话会被自动总结
  - 摘要会注入到上下文中，避免丢失重要信息

---

##  完整工作流程

### 阶段1：检索知识库文档
```
用户问题 → 混合检索 → 重排序 → 阈值过滤 → 最终文档
```
- 与单次知识问答完全相同
- 可选：InsertBlock智能过滤

### 阶段2：获取历史对话（三路并行）

#### 2.1 最近对话（Recent History）
```python
recent_history = get_recent_history(session_id, limit=MAX_RECENT_TURNS)
# 示例：获取最近3轮对话
```
- **目的**：保持对话连贯性
- **数据来源**：按时间降序排序的最近N轮
- **作用**：理解上下文、代词指代

#### 2.2 相关对话（Relevant History）
```python
relevant_history = retrieve_relevant_history(
    session_id=session_id,
    current_query=question,
    top_k=MAX_RELEVANT_TURNS
)
# 示例：检索2轮相关历史
```
- **目的**：找到与当前问题最相关的历史对话
- **数据来源**：通过向量相似度检索
- **去重**：自动过滤掉已在最近对话中的轮次
- **作用**：跨轮次主题回溯

#### 2.3 历史摘要（Summary）
```python
if 总对话轮数 > MAX_RECENT_TURNS:
    old_history = all_history[:-MAX_RECENT_TURNS]
    history_summary = llm.complete(summary_prompt + old_history)
```
- **目的**：压缩旧对话，避免上下文过长
- **触发条件**：对话轮数超过 MAX_RECENT_TURNS
- **作用**：保留旧对话的关键信息

### 阶段3：构建上下文

上下文组成顺序（从上到下注入）：

```
┌─────────────────────────────────────┐
│ 1. 系统提示词                        │
│    (知识问答的分析提示词)             │
├─────────────────────────────────────┤
│ 2. 历史对话摘要                      │
│    "以下是之前对话的摘要："          │
│    [总结内容]                        │
├─────────────────────────────────────┤
│ 3. 最近对话历史                      │
│    "以下是最近的对话历史："          │
│    用户: xxx                         │
│    助手: xxx                         │
│    用户: yyy                         │
│    助手: yyy                         │
├─────────────────────────────────────┤
│ 4. 相关历史对话                      │
│    "以下是与当前问题相关的历史对话：" │
│    用户: aaa                         │
│    助手: bbb                         │
├─────────────────────────────────────┤
│ 5. 业务规定（检索结果）              │
│    "业务规定如下："                  │
│    ### 来源 1 - 文件A:               │
│    > [内容A]                         │
│    ### 来源 2 - 文件B:               │
│    > [内容B]                         │
├─────────────────────────────────────┤
│ 6. 用户当前问题                      │
│    "业务咨询："                      │
│    {question}                        │
└─────────────────────────────────────┘
```

### 阶段4：LLM生成回答

- 使用知识问答的提示词格式
- 支持思考模式（启用时进行完整分析）
- 每次回答都会：
  - 解析关键实体和核心动作
  - 结合历史对话理解代词和追问
  - 依据业务规定+历史上下文给出回答

### 阶段5：存储本轮对话

```python
conversation_manager.add_conversation_turn(
    session_id=session_id,
    user_query=question,
    assistant_response=assistant_response,
    context_docs=context_doc_names,
    turn_id=current_turn_id,
    parent_turn_id=parent_turn_id
)
```
- 存储到 Qdrant 向量数据库
- 记录使用的上下文文档
- 建立对话链（parent_turn_id）

---

##  实际场景示例

### 场景1：连续追问（最近对话发挥作用）

```
第1轮：
用户: "什么是边检？"
助手: "边检是边防检查的简称..."

第2轮：
用户: "它的主要职责是什么？"  ← 代词"它"指代"边检"
助手: [从最近对话中理解"它"指代边检] "边检的主要职责是..."

第3轮：
用户: "需要准备哪些材料？"  ← 延续上下文
助手: [理解是在问边检需要的材料] "需要准备..."
```

### 场景2：跨轮次回溯（相关对话发挥作用）

```
第1轮：用户问了关于"签证类型"的详细问题
第2轮：用户问了关于"入境流程"
第3轮：用户问了关于"海关申报"
第4轮：用户问了关于"检疫要求"

第5轮：用户: "刚才说的那几种签证类型，哪种最适合旅游？"
助手: [通过向量检索找到第1轮关于签证的对话]
      "根据之前讨论的签证类型，旅游签最适合..."
```

### 场景3：长对话摘要（历史摘要发挥作用）

```
第1-10轮：关于出境流程的详细讨论
第11轮（当前）：用户: "总结一下刚才说的要点"

上下文构成：
- 历史摘要：[第1-7轮的总结]
- 最近3轮：[第8、9、10轮完整对话]
- 业务规定：[相关检索结果]
```

---

##  如何调整参数

### 修改方式1：环境变量（推荐）

创建或编辑 `.env` 文件：
```bash
MAX_RECENT_TURNS=5       # 改为保留最近5轮
MAX_RELEVANT_TURNS=3     # 改为检索3轮相关对话
```

### 修改方式2：直接修改配置文件

编辑 `config/settings.py`：
```python
MAX_RECENT_TURNS = int(os.getenv("MAX_RECENT_TURNS", 5))   # 默认改为5
MAX_RELEVANT_TURNS = int(os.getenv("MAX_RELEVANT_TURNS", 3)) # 默认改为3
```

### 参数选择建议

| 场景 | MAX_RECENT_TURNS | MAX_RELEVANT_TURNS | 说明 |
|------|-----------------|-------------------|------|
| 短对话 | 3 | 2 | 默认配置，适合大多数场景 |
| 深度咨询 | 5-7 | 3-4 | 需要更多上下文 |
| 快速问答 | 2 | 1 | 节省token，提高速度 |
| 长期跟踪 | 3 | 5 | 强化历史关联 |

---

##  调试技巧

查看日志中的对话检索信息：
```
INFO - 获取到 3 条最近对话
INFO - 检索到 1 条相关历史对话（排除最近对话后）
INFO - 生成历史摘要 (覆盖 15 轮): 用户主要询问了关于签证、入境、...
```

---

## 对比：优化前 vs 优化后

### 优化前
```
- 只使用最近N轮对话
- 无法处理跨轮次主题回溯
- MAX_RELEVANT_TURNS 参数未启用
```

### 优化后
```
 最近对话：保持连贯性
相关对话：跨轮次回溯
 历史摘要：压缩旧对话
三重保障：确保不丢失重要信息
```

---

##  总结

现在的多轮对话系统：
1. **使用知识问答的提示词** - 每次都进行完整分析
2. **三路历史对话获取** - 最近+相关+摘要
3. **智能去重** - 避免重复展示相同对话
4. **灵活配置** - 通过环境变量轻松调整
5. **向量检索增强** - MAX_RELEVANT_TURNS 参数生效

