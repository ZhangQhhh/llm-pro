# 检索调试指南

## 🎯 问题场景

**症状**: 某些应该被检索到的文件没有出现在结果中

**可能原因**:
1. 文件相关性分数太低，排名在后面
2. 被阈值过滤掉了
3. 文件根本不在知识库中
4. 前端传入的 `rerank_top_n` 太小

## 🔧 调试工具

### 工具 1: `debug_retrieval_scores.py`

查看所有检索到的文档及其分数

#### 基础用法

```bash
# 查看前 50 个检索结果
python debug_retrieval_scores.py "泰国免签政策是什么？"

# 查看前 100 个检索结果
python debug_retrieval_scores.py "泰国免签政策是什么？" --top-k 100
```

#### 搜索特定文件

```bash
# 搜索特定文件在检索结果中的位置
python debug_retrieval_scores.py "泰国免签政策是什么？" --file "林允知识库.docx"

# 搜索前 200 个结果
python debug_retrieval_scores.py "泰国免签政策是什么？" --file "林允知识库.docx" --top-k 200
```

### 输出示例

```
================================================================================
🔍 检索调试工具
问题: 泰国免签政策是什么？
显示前 50 个结果
================================================================================

📊 第一步：向量检索 + BM25 检索（混合检索）
--------------------------------------------------------------------------------
✓ 初始检索到 150 个节点

前 50 个节点的详细信息：

[ 1] 免签政策.md
     RRF融合分数: 0.023456
     检索来源: vector+keyword
       - 向量分数: 0.856700 (排名 #3)
       - BM25分数: 0.723400 (排名 #5)
       - 匹配关键词: 泰国, 免签, 30天
     内容预览: 泰国对中国公民实行免签政策，允许停留不超过30天...

[ 2] 签证规定.md
     RRF融合分数: 0.019876
     检索来源: vector
       - 向量分数: 0.812300 (排名 #5)
     内容预览: 根据最新规定，中国公民前往泰国旅游可以享受免签待遇...

...

📊 第二步：重排序（Reranker）
--------------------------------------------------------------------------------
✓ 取前 30 个节点送入重排序
✓ 重排序完成，得到 30 个节点

前 20 个重排序后的节点：

[ 1] 免签政策.md
     初始分数: 0.023456 → 重排分数: 0.992100
     内容预览: 泰国对中国公民实行免签政策...

[ 2] 签证规定.md
     初始分数: 0.019876 → 重排分数: 0.987600
     内容预览: 根据最新规定...

...

📊 第三步：阈值过滤
--------------------------------------------------------------------------------
阈值设置: 0.3
✓ 经过阈值过滤后剩余 15 个节点

================================================================================
🎯 调试总结
================================================================================
初始检索: 150 个节点
重排序输入: 30 个节点
重排序输出: 30 个节点
阈值过滤后: 15 个节点
================================================================================

📁 文件分布统计
--------------------------------------------------------------------------------
  免签政策.md: 12 个节点
  签证规定.md: 8 个节点
  林允知识库.docx: 5 个节点
  ...
```

## 📊 关键配置参数

### 1. 前端可传入的最大参考文献数

**位置**: `routes/knowledge_routes.py`

```python
MIN_RERANK_N = 1
MAX_RERANK_N = 15  # ⭐ 前端最多可以传 15
```

**前端请求示例**:
```json
{
  "question": "泰国免签政策是什么？",
  "rerank_top_n": 15  // 最大值
}
```

### 2. 检索流程配置

**位置**: `config/settings.py`

```python
# 向量检索参数
RETRIEVAL_TOP_K = 30              # 向量检索取前 30 个
RETRIEVAL_TOP_K_BM25 = 30         # BM25 检索取前 30 个

# 重排序参数
RERANKER_INPUT_TOP_N = 30         # 送入重排序的节点数
RERANK_TOP_N = 10                 # 重排序后默认返回 10 个
RERANK_SCORE_THRESHOLD = 0.3      # ⭐ 重排序分数阈值（低于此值会被过滤）
```

## 🔍 调试步骤

### 步骤 1: 查看所有检索结果

```bash
python debug_retrieval_scores.py "你的问题" --top-k 100
```

**观察**:
- 你期望的文件在第几名？
- 它的分数是多少？
- 它是通过向量检索还是 BM25 检索找到的？

### 步骤 2: 搜索特定文件

```bash
python debug_retrieval_scores.py "你的问题" --file "目标文件名.docx"
```

**观察**:
- 该文件是否被检索到？
- 排名是多少？
- 分数是多少？

### 步骤 3: 分析原因

#### 情况 A: 文件排名很靠后（如第 50 名）

**原因**: 相关性太低

**解决方案**:
1. 调整问题描述，使用文件中的关键词
2. 增加前端传入的 `rerank_top_n`（最大 15）
3. 增加 `RERANKER_INPUT_TOP_N` 配置（如改为 50）

#### 情况 B: 文件重排序分数低于阈值

**原因**: 被阈值过滤掉了

**解决方案**:
降低 `RERANK_SCORE_THRESHOLD`:
```python
# config/settings.py
RERANK_SCORE_THRESHOLD = 0.2  # 从 0.3 降低到 0.2
```

#### 情况 C: 文件根本没被检索到

**原因**: 文件不在知识库中

**解决方案**:
1. 检查文件是否已加载到知识库
2. 重新构建知识库索引

## 🛠️ 常见问题解决

### 问题 1: 前端最多只能显示 15 个文档

**原因**: 路由层限制 `MAX_RERANK_N = 15`

**解决方案**: 修改路由配置

```python
# routes/knowledge_routes.py
MAX_RERANK_N = 20  # 或 30
```

### 问题 2: 某些相关文档被过滤掉了

**原因**: 阈值太高

**解决方案**: 降低阈值

```python
# config/settings.py
RERANK_SCORE_THRESHOLD = 0.2  # 从 0.3 降低
```

### 问题 3: 检索结果太少

**原因**: 初始检索数量太少

**解决方案**: 增加检索数量

```python
# config/settings.py
RETRIEVAL_TOP_K = 50        # 从 30 增加到 50
RETRIEVAL_TOP_K_BM25 = 50   # 从 30 增加到 50
RERANKER_INPUT_TOP_N = 50   # 从 30 增加到 50
```

## 📈 优化建议

### 1. 增加前端可传入的最大值

```python
# routes/knowledge_routes.py (两处)
MAX_RERANK_N = 20  # 从 15 增加到 20
```

### 2. 增加重排序输入数量

```python
# config/settings.py
RERANKER_INPUT_TOP_N = 50  # 从 30 增加到 50
```

这样可以让更多的文档有机会被重排序。

### 3. 降低阈值（谨慎）

```python
# config/settings.py
RERANK_SCORE_THRESHOLD = 0.2  # 从 0.3 降低到 0.2
```

⚠️ **注意**: 阈值太低可能导致不相关的文档也被返回。

## 🎯 推荐配置

### 保守配置（高精度）
```python
RETRIEVAL_TOP_K = 30
RERANKER_INPUT_TOP_N = 30
RERANK_SCORE_THRESHOLD = 0.3
MAX_RERANK_N = 15
```

### 平衡配置（推荐）
```python
RETRIEVAL_TOP_K = 50
RERANKER_INPUT_TOP_N = 50
RERANK_SCORE_THRESHOLD = 0.25
MAX_RERANK_N = 20
```

### 激进配置（高召回）
```python
RETRIEVAL_TOP_K = 100
RERANKER_INPUT_TOP_N = 100
RERANK_SCORE_THRESHOLD = 0.2
MAX_RERANK_N = 30
```

## 📞 技术支持

如有问题，请查看：
- 调试脚本：`debug_retrieval_scores.py`
- 配置文件：`config/settings.py`
- 路由文件：`routes/knowledge_routes.py`
