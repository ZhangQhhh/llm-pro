# 隐藏知识库使用指南

## 概述

隐藏知识库是一个专门设计的功能，用于在不暴露来源的情况下提升 RAG 系统的回答准确率。主要应用场景是**题库内容**的注入，让大模型能够参考正确答案，但用户完全看不到这些题库内容的来源。

## 核心特性

### 1. **完全隐藏**
- ✅ 上下文注入：题库内容会被注入到 LLM 的上下文中
- ✅ 前端不可见：参考来源列表中不会显示隐藏知识库的文件
- ✅ 思考过程隔离：在思考过程中也不会提及隐藏知识库
- ✅ 日志可追踪：后台日志会记录隐藏知识库的检索情况（方便调试）

### 2. **独立检索**
- 与通用知识库、免签知识库、航司知识库并行工作
- 独立的 Qdrant collection
- 独立的检索参数配置
- 不影响其他知识库的检索结果

### 3. **智能过滤**
- 支持最低分数阈值（`HIDDEN_KB_MIN_SCORE`）
- 低于阈值的内容不会被注入
- 避免低质量内容污染上下文

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 启用隐藏知识库功能
ENABLE_HIDDEN_KB_FEATURE=true
```

### 详细配置参数

在 `config/settings.py` 中的配置项：

```python
# 功能开关
ENABLE_HIDDEN_KB_FEATURE = True  # 启用隐藏知识库

# 路径配置
HIDDEN_KB_DIR = "/opt/rag_final_project/hidden_knowledge_base"  # 题库文件目录
HIDDEN_KB_STORAGE_PATH = "/opt/rag_final_project/hidden_storage"  # 索引存储路径
HIDDEN_KB_COLLECTION = "hidden_kb"  # Qdrant collection 名称

# 检索参数
HIDDEN_KB_RETRIEVAL_TOP_K = 30  # 初始检索数量
HIDDEN_KB_RETRIEVAL_TOP_K_BM25 = 30  # BM25 检索数量
HIDDEN_KB_RERANK_TOP_N = 10  # 重排序后返回数量
HIDDEN_KB_RETRIEVAL_COUNT = 5  # 最终注入上下文的数量（默认5条）

# 行为配置
HIDDEN_KB_INJECT_MODE = "silent"  # silent: 完全隐藏 | visible: 显示来源（调试用）
HIDDEN_KB_MIN_SCORE = 0.3  # 最低分数阈值（低于此分数不注入）
```

## 使用步骤

### 1. 准备题库文件

在 `/opt/rag_final_project/hidden_knowledge_base/` 目录下放置题库文件：

```
hidden_knowledge_base/
├── 题库_第一章.txt
├── 题库_第二章.txt
├── 题库_第三章.txt
└── ...
```

**文件格式建议**：

```text
问题：用户询问XXX时应该如何回答？
答案：根据规定，应该回答...

问题：关于YYY的正确解释是什么？
答案：YYY是指...

---

问题：ZZZ的处理流程是什么？
答案：
1. 第一步...
2. 第二步...
3. 第三步...
```

### 2. 启用功能

```bash
# 设置环境变量
export ENABLE_HIDDEN_KB_FEATURE=true

# 启动应用
python app.py
```

### 3. 验证功能

查看启动日志，确认隐藏知识库已成功加载：

```
============================================================
初始化隐藏知识库功能...
============================================================
开始构建/加载隐藏知识库
知识库目录: /opt/rag_final_project/hidden_knowledge_base
Collection: hidden_kb
============================================================
✓ 隐藏知识库实例变量已设置 | 节点数: 150
✓ 隐藏知识库检索器创建成功
============================================================
隐藏知识库功能初始化完成
============================================================
✓ 知识库功能已启用: 多库检索+意图分类, 免签库, 航司库, 子问题分解, 隐藏知识库
```

### 4. 测试效果

发送一个问题，观察：

1. **前端显示**：参考来源中不会出现隐藏知识库的文件
2. **回答质量**：回答内容应该更准确（因为参考了题库）
3. **后台日志**：可以看到隐藏知识库的检索记录

```
[隐藏知识库] 开始并行检索...
[隐藏知识库] 检索成功 | 返回 5 条
[隐藏知识库] 已构建隐藏上下文 | 节点数: 5 | 最高分: 0.8567
```

## 工作原理

### 检索流程

```
用户提问
    ↓
并行检索
    ├─→ 通用知识库检索 → 返回节点A
    ├─→ 免签知识库检索 → 返回节点B
    ├─→ 航司知识库检索 → 返回节点C
    └─→ 隐藏知识库检索 → 返回节点D（隐藏）
    ↓
构建上下文
    ├─→ 隐藏知识库内容（标记为"内部参考资料"）
    ├─→ 通用知识库内容（显示文件名）
    ├─→ 免签知识库内容（显示文件名）
    └─→ 航司知识库内容（显示文件名）
    ↓
注入 LLM Prompt
    ↓
生成回答
    ↓
返回前端
    ├─→ 回答内容（包含隐藏知识库的影响）
    └─→ 参考来源（不包含隐藏知识库）
```

### 上下文格式

隐藏知识库的内容会以以下格式注入：

```
### 内部参考资料 1:
> 问题：用户询问XXX时应该如何回答？
> 答案：根据规定，应该回答...

### 内部参考资料 2:
> 问题：关于YYY的正确解释是什么？
> 答案：YYY是指...
```

**注意**：不会显示文件名，只显示"内部参考资料"。

## 调试模式

如果需要调试隐藏知识库，可以临时修改配置：

```python
# 在 config/settings.py 中
HIDDEN_KB_INJECT_MODE = "visible"  # 显示来源（调试用）
```

此时，隐藏知识库的文件名会显示在参考来源中，方便调试。

## 最佳实践

### 1. 题库内容组织

- **结构化格式**：使用"问题-答案"格式，便于检索
- **分类存储**：按主题或章节分类存储，便于管理
- **定期更新**：题库内容应定期更新，保持准确性

### 2. 参数调优

- **检索数量**：根据题库大小调整 `HIDDEN_KB_RETRIEVAL_COUNT`
  - 题库较小（<100条）：建议 3-5 条
  - 题库中等（100-500条）：建议 5-8 条
  - 题库较大（>500条）：建议 8-10 条

- **分数阈值**：根据检索质量调整 `HIDDEN_KB_MIN_SCORE`
  - 题库质量高：可以设置较低（0.2-0.3）
  - 题库质量一般：建议设置较高（0.4-0.5）

### 3. 性能优化

- **索引缓存**：隐藏知识库使用独立的索引缓存，不影响其他知识库
- **并行检索**：隐藏知识库与其他知识库并行检索，不增加延迟
- **智能过滤**：低分内容自动过滤，避免无效注入

## 常见问题

### Q1: 隐藏知识库会影响回答速度吗？

**A**: 不会。隐藏知识库采用并行检索，与其他知识库同时进行，不会增加额外延迟。

### Q2: 如何确认隐藏知识库是否生效？

**A**: 查看后台日志，搜索 `[隐藏知识库]` 关键词，可以看到检索记录。

### Q3: 隐藏知识库的内容会被用户发现吗？

**A**: 不会。隐藏知识库的内容只会注入到 LLM 的上下文中，不会在前端显示，用户完全看不到。

### Q4: 可以同时使用多个隐藏知识库吗？

**A**: 当前版本只支持一个隐藏知识库。如果需要多个，可以将所有题库文件放在同一个目录下。

### Q5: 隐藏知识库支持哪些文件格式？

**A**: 支持 `.txt`, `.md`, `.pdf`, `.docx` 等常见文档格式，与通用知识库相同。

## 安全建议

1. **访问控制**：隐藏知识库目录应设置严格的访问权限
2. **内容审核**：定期审核题库内容，确保准确性和合规性
3. **日志监控**：定期检查日志，确认隐藏知识库的使用情况
4. **备份策略**：定期备份题库文件和索引

## 技术细节

### 核心文件

- `core/hidden_kb_retriever.py` - 隐藏知识库检索器
- `utils/knowledge_utils/context_builder.py` - 上下文构建器（包含隐藏内容注入）
- `api/knowledge_handler.py` - 知识问答处理器（集成隐藏检索）
- `services/knowledge_service.py` - 知识库服务（构建隐藏索引）

### 数据流

```
HiddenKBRetriever.retrieve()
    ↓
build_hidden_kb_context()  # 构建隐藏上下文
    ↓
build_rag_context()  # 合并到 RAG 上下文
    ↓
build_knowledge_prompt()  # 注入到 prompt
    ↓
LLM 生成回答
```

## 更新日志

- **2025-02-17**: 初始版本发布
  - 支持独立隐藏知识库检索
  - 支持完全隐藏模式
  - 支持智能分数过滤

## 相关文档

- [多知识库检索策略](MULTI_KB_RETRIEVAL_STRATEGY.md)
- [意图分类器使用指南](INTENT_CLASSIFIER_README.md)
- [子问题分解功能](SUBQUESTION_DECOMPOSITION.md)
