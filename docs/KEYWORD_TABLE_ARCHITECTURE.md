# Keyword Table 架构详解

## 🎯 核心概念

### Keyword Table ≠ 向量数据库

**重要**: Keyword Table 索引是**完全独立**的本地文件索引，与 Qdrant 向量数据库无关。

```
┌─────────────────────────────────────────────────────────┐
│ Qdrant 向量数据库 (localhost:6333)                      │
├─────────────────────────────────────────────────────────┤
│ • 存储: 向量 Embedding                                   │
│ • 检索: 语义相似度 (cosine/dot product)                 │
│ • 数据: collection: knowledge_base                      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Keyword Table 索引 (本地文件)                           │
├─────────────────────────────────────────────────────────┤
│ • 存储: storage/vector_store/keyword_table/             │
│ • 检索: 关键词精确匹配 (倒排索引)                       │
│ • 数据: docstore.json, index_store.json                 │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 完整工作流程

### 阶段1: 离线索引构建

```
┌──────────────────────────────────────────────────────────┐
│ 1. 向量索引 (build_knowledge_base.py)                    │
├──────────────────────────────────────────────────────────┤
│ 文档 → Embedding 模型 → Qdrant                           │
│ 存储: Qdrant 数据库                                       │
│ 参数: RETRIEVAL_TOP_K = 30                               │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│ 2. Keyword Table 索引 (build_keyword_index.py)          │
├──────────────────────────────────────────────────────────┤
│ 文档 → 关键词提取 → 倒排索引 → 本地文件                  │
│ 存储: storage/vector_store/keyword_table/                │
│ 参数: RETRIEVAL_TOP_K_KEYWORD = 30                       │
│ ⚠️ 不涉及 Embedding，不写入 Qdrant                       │
└──────────────────────────────────────────────────────────┘
```

### 阶段2: 在线检索流程

```
用户提问
    ↓
┌──────────────────────────────────────────────────────────┐
│ Step 1: Keyword Table 检索 (优先)                         │
├──────────────────────────────────────────────────────────┤
│ • 分词 + 停用词过滤                                       │
│ • 查询本地倒排索引                                        │
│ • 返回: RETRIEVAL_TOP_K_KEYWORD = 30 个节点               │
│ • 数据来源: storage/vector_store/keyword_table/          │
└──────────────────────────────────────────────────────────┘
    ↓ (成功) → 跳到 Step 3
    ↓ (失败) → 进入 Step 2
    
┌──────────────────────────────────────────────────────────┐
│ Step 2: 智能融合 (根据 Keyword Table 结果)               │
├──────────────────────────────────────────────────────────┤
│ 情况A: Keyword Table 成功                                 │
│   ├─ Keyword Table: 30 个节点                            │
│   ├─ 向量检索 (Qdrant): 30 个节点                        │
│   └─ RRF 融合: Keyword Table + 向量 (2路融合)           │
│       • 最多 60 个候选 (去重后更少)                      │
│                                                           │
│ 情况B: Keyword Table 失败 (自动回退)                      │
│   ├─ 向量检索 (Qdrant): 30 个节点                        │
│   ├─ BM25 检索 (内存): 5 个节点                          │
│   └─ RRF 融合: BM25 + 向量 (2路融合)                    │
│       • 最多 35 个候选 (去重后更少)                      │
└──────────────────────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────────────────────┐
│ Step 3: 重排序 (Reranker)                                │
├──────────────────────────────────────────────────────────┤
│ • 输入: 30-35 个候选节点                                  │
│ • 模型: bge-reranker-large                               │
│ • 输出: RERANK_TOP_N = 20 个最相关文档                    │
└──────────────────────────────────────────────────────────┘
    ↓
最终返回 20 个文档用于生成回答
```

---

## 🔢 返回数量对比

### 情况1: Keyword Table 成功 → 与向量融合

```
Keyword Table 检索: 30 个节点
向量检索: 30 个节点
    ↓
RRF 融合: 最多 60 个候选 (去重后约 40-50 个)
    ↓
重排序 (Reranker): 从 40-50 个中选出 20 个
    ↓
最终返回: 20 个文档
```

**优势**: Keyword Table 精确匹配 + 向量语义理解，召回率和准确率双提升！

### 情况2: Keyword Table 失败 → 回退到 BM25+向量

```
向量检索: 30 个节点
BM25 检索: 5 个节点
    ↓
RRF 融合: 最多 35 个候选 (去重后约 30-33 个)
    ↓
重排序 (Reranker): 从 30-33 个中选出 20 个
    ↓
最终返回: 20 个文档
```

**保障**: 即使 Keyword Table 失败，仍有 BM25 兜底，不影响原有功能。

**结论**: 
- ✅ Keyword Table 成功时，候选更多 (40-50 vs 30-33)，质量更高
- ✅ Keyword Table 失败时，自动回退到原有 BM25+向量逻辑
- ✅ 两种情况都能保证最终返回 20 个高质量文档

---

## ⚙️ 配置参数说明

### Keyword Table 参数

```bash
# .env 配置
ENABLE_KEYWORD_TABLE=false                      # 是否启用
RETRIEVAL_TOP_K_KEYWORD=30                      # 返回节点数 (已对齐向量检索)
KEYWORD_TABLE_MIN_SCORE=0.3                     # 最低分数阈值
KEYWORD_TABLE_FALLBACK_MODE=keyword_bm25_vector # 回退模式
```

### 向量检索参数 (settings.py)

```python
RETRIEVAL_TOP_K = 30              # 向量检索数量
RETRIEVAL_TOP_K_BM25 = 5          # BM25 检索数量
RERANK_TOP_N = 20                 # 重排序后返回数量
RERANKER_INPUT_TOP_N = 30         # 送入重排序的数量
```

---

## 📁 存储结构

```
/opt/rag_final_project/
├── storage/
│   └── vector_store/
│       ├── keyword_table/              # Keyword Table 索引 (本地文件)
│       │   ├── docstore.json           # 文档存储
│       │   ├── index_store.json        # 索引元数据
│       │   └── graph_store.json        # 图结构
│       └── (其他向量索引相关文件)
│
└── (Qdrant 数据存储在独立位置或内存中)
```

---

## 🎯 设计优势

### 1. 互补性

- **Keyword Table**: 精确匹配专有名词、术语
- **向量检索**: 语义理解、同义词识别
- **BM25**: 关键词加权、TF-IDF

### 2. 灵活性

- 可独立启用/关闭
- 支持多种回退模式
- 参数可动态调整

### 3. 性能

- Keyword Table 检索速度极快 (O(1) 查表)
- 只在失败时才回退到向量检索
- 减少不必要的 Embedding 计算

---

## 🚀 使用建议

### 适合启用 Keyword Table 的场景

✅ 查询包含大量专有名词 (如: "美国B1/B2签证")  
✅ 需要精确匹配特定术语  
✅ 向量检索召回率不足  

### 不适合的场景

❌ 查询语言口语化、模糊  
❌ 需要理解复杂语义关系  
❌ 文档中关键词提取质量差  

---

## 📝 总结

1. **Keyword Table 是独立的本地文件索引**，不存储在 Qdrant
2. **返回数量已对齐**: RETRIEVAL_TOP_K_KEYWORD = 30
3. **回退机制完善**: 失败时自动切换到向量+BM25混合检索
4. **最终返回 20 个文档**: 经过重排序筛选的高质量结果
