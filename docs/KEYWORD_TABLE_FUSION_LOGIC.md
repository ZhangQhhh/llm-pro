# Keyword Table èåˆé€»è¾‘è¯´æ˜

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

**Keyword Table åº”è¯¥åƒ BM25 ä¸€æ ·ï¼Œä¸å‘é‡æ£€ç´¢èåˆï¼Œè€Œä¸æ˜¯"è¦ä¹ˆå…¨æœ‰ï¼Œè¦ä¹ˆå…¨æ— "ã€‚**

---

## ğŸ“Š æ–°æ—§é€»è¾‘å¯¹æ¯”

### âŒ æ—§é€»è¾‘ï¼ˆå·²åºŸå¼ƒï¼‰

```
if Keyword Table æˆåŠŸ:
    åªè¿”å› Keyword Table ç»“æœ (30ä¸ª)  # âŒ ä¸¢å¤±è¯­ä¹‰ä¿¡æ¯
else:
    è¿”å› BM25 + å‘é‡èåˆç»“æœ (35ä¸ª)
```

**é—®é¢˜**:
- Keyword Table æˆåŠŸæ—¶ï¼Œå®Œå…¨ä¸ä½¿ç”¨å‘é‡æ£€ç´¢
- ä¸¢å¤±äº†è¯­ä¹‰ç›¸ä¼¼åº¦ä¿¡æ¯
- å€™é€‰æ•°é‡å°‘ï¼Œé‡æ’åºæ•ˆæœå·®

### âœ… æ–°é€»è¾‘ï¼ˆå½“å‰ï¼‰

```
if Keyword Table æˆåŠŸ:
    Keyword Table (30ä¸ª) + å‘é‡æ£€ç´¢ (30ä¸ª)
    â†’ RRF èåˆ (40-50ä¸ªå»é‡å€™é€‰)  # âœ… ç²¾ç¡®+è¯­ä¹‰åŒä¿é™©
else:
    BM25 (5ä¸ª) + å‘é‡æ£€ç´¢ (30ä¸ª)
    â†’ RRF èåˆ (30-33ä¸ªå»é‡å€™é€‰)  # âœ… åŸæœ‰é€»è¾‘ï¼Œå…œåº•ä¿éšœ
```

**ä¼˜åŠ¿**:
- âœ… Keyword Table ç²¾ç¡®åŒ¹é…ä¸“æœ‰åè¯
- âœ… å‘é‡æ£€ç´¢ç†è§£è¯­ä¹‰å’ŒåŒä¹‰è¯
- âœ… RRF èåˆç»¼åˆä¸¤è€…ä¼˜åŠ¿
- âœ… å€™é€‰æ›´å¤šï¼Œé‡æ’åºè´¨é‡æ›´é«˜

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```
ç”¨æˆ·æé—®: "å¦‚ä½•ç”³è¯·ç¾å›½B1/B2ç­¾è¯ï¼Ÿ"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Keyword Table æ£€ç´¢                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åˆ†è¯: ["ç”³è¯·", "ç¾å›½", "B1/B2", "ç­¾è¯"]                 â”‚
â”‚ â€¢ æŸ¥è¯¢å€’æ’ç´¢å¼•                                            â”‚
â”‚ â€¢ è¿”å›: 30 ä¸ªç²¾ç¡®åŒ¹é…çš„æ–‡æ¡£                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å‘é‡æ£€ç´¢ (å¹¶è¡Œæ‰§è¡Œ)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Embedding æ¨¡å‹ç¼–ç æŸ¥è¯¢                                  â”‚
â”‚ â€¢ Qdrant è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢                                   â”‚
â”‚ â€¢ è¿”å›: 30 ä¸ªè¯­ä¹‰ç›¸å…³çš„æ–‡æ¡£                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: RRF èåˆ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Keyword Table 30ä¸ª + å‘é‡æ£€ç´¢ 30ä¸ª                      â”‚
â”‚ â€¢ ä½¿ç”¨ RRF ç®—æ³•è®¡ç®—ç»¼åˆåˆ†æ•°                               â”‚
â”‚ â€¢ å»é‡åè¿”å›: 40-50 ä¸ªå€™é€‰æ–‡æ¡£                            â”‚
â”‚                                                          â”‚
â”‚ RRF å…¬å¼: score = Î£ 1/(k + rank)                        â”‚
â”‚   - k = 60 (å¹³æ»‘å‚æ•°)                                    â”‚
â”‚   - rank = èŠ‚ç‚¹åœ¨å„æ£€ç´¢ç»“æœä¸­çš„æ’å                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: é‡æ’åº (Reranker)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¾“å…¥: 40-50 ä¸ªå€™é€‰æ–‡æ¡£                                  â”‚
â”‚ â€¢ æ¨¡å‹: bge-reranker-large                               â”‚
â”‚ â€¢ ç²¾ç»†æ‰“åˆ†ï¼ŒæŒ‰ç›¸å…³æ€§é‡æ–°æ’åº                              â”‚
â”‚ â€¢ è¾“å‡º: Top 20 ä¸ªæœ€ç›¸å…³æ–‡æ¡£                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æœ€ç»ˆè¿”å› 20 ä¸ªé«˜è´¨é‡æ–‡æ¡£ç”¨äºç”Ÿæˆå›ç­”
```

---

## ğŸ” å›é€€æœºåˆ¶

### æƒ…å†µA: Keyword Table æˆåŠŸ

```python
# api/knowledge_handler.py Lines 1562-1581
if keyword_nodes:
    # æƒ…å†µA: Keyword Table + å‘é‡æ£€ç´¢ (2è·¯èåˆ)
    logger.info("[èåˆç­–ç•¥] Keyword Table + å‘é‡æ£€ç´¢")
    
    vector_nodes = retriever.retrieve(query_bundle)  # 30ä¸ª
    
    retrieved_nodes = self._rrf_fusion_keyword_vector(
        keyword_nodes=keyword_nodes,  # 30ä¸ª
        vector_nodes=vector_nodes      # 30ä¸ª
    )
    # èåˆå: 40-50ä¸ª (å»é‡)
```

### æƒ…å†µB: Keyword Table å¤±è´¥ï¼ˆè‡ªåŠ¨å›é€€ï¼‰

```python
# api/knowledge_handler.py Lines 1588-1596
if not retrieved_nodes:
    # æƒ…å†µB: BM25 + å‘é‡æ£€ç´¢ (2è·¯èåˆï¼ŒåŸæœ‰é€»è¾‘)
    logger.info("[èåˆç­–ç•¥] BM25 + å‘é‡æ£€ç´¢ï¼ˆå›é€€æ¨¡å¼ï¼‰")
    
    retrieved_nodes = retriever.retrieve(query_bundle)
    # å†…éƒ¨å·²åŒ…å« BM25 + å‘é‡çš„ RRF èåˆ
    # è¿”å›: 30-33ä¸ª (å»é‡)
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§é€»è¾‘ (Keyword Table ç‹¬ç«‹) | æ–°é€»è¾‘ (Keyword Table èåˆ) |
|------|---------------------------|---------------------------|
| **å€™é€‰æ•°é‡** | 30ä¸ª | 40-50ä¸ª (å»é‡) |
| **ç²¾ç¡®åŒ¹é…** | âœ… æœ‰ | âœ… æœ‰ |
| **è¯­ä¹‰ç†è§£** | âŒ æ—  | âœ… æœ‰ |
| **å¬å›ç‡** | ä¸­ | é«˜ |
| **å‡†ç¡®ç‡** | ä¸­ | é«˜ |
| **é‡æ’åºè´¨é‡** | ä¸€èˆ¬ | ä¼˜ç§€ |

---

## ğŸ¯ å®é™…æ¡ˆä¾‹

### æŸ¥è¯¢: "ç¾å›½ç­¾è¯é¢è¯•éœ€è¦å‡†å¤‡ä»€ä¹ˆææ–™ï¼Ÿ"

#### æ—§é€»è¾‘ç»“æœ

```
Keyword Table æ£€ç´¢ (30ä¸ª):
  1. ç¾å›½ç­¾è¯é¢è¯•ææ–™æ¸…å• (ç²¾ç¡®åŒ¹é…)
  2. ç¾å›½B1/B2ç­¾è¯ç”³è¯·æŒ‡å— (åŒ…å«"ç¾å›½ç­¾è¯")
  3. ...
  30. ç­¾è¯ç…§ç‰‡è¦æ±‚ (åŒ…å«"ç­¾è¯")

âŒ é—®é¢˜: ç¼ºå°‘è¯­ä¹‰ç›¸å…³ä½†å…³é”®è¯ä¸å®Œå…¨åŒ¹é…çš„æ–‡æ¡£
   ä¾‹å¦‚: "é¢ç­¾å‡†å¤‡äº‹é¡¹"ã€"ä½¿é¦†é¢è°ˆæ³¨æ„äº‹é¡¹"
```

#### æ–°é€»è¾‘ç»“æœ

```
Keyword Table æ£€ç´¢ (30ä¸ª):
  1. ç¾å›½ç­¾è¯é¢è¯•ææ–™æ¸…å•
  2. ç¾å›½B1/B2ç­¾è¯ç”³è¯·æŒ‡å—
  ...

å‘é‡æ£€ç´¢ (30ä¸ª):
  1. é¢ç­¾å‡†å¤‡äº‹é¡¹ (è¯­ä¹‰ç›¸å…³)
  2. ä½¿é¦†é¢è°ˆæ³¨æ„äº‹é¡¹ (è¯­ä¹‰ç›¸å…³)
  3. ç­¾è¯ææ–™å‡†å¤‡æŒ‡å— (è¯­ä¹‰ç›¸å…³)
  ...

RRF èåˆ (45ä¸ªå»é‡):
  1. ç¾å›½ç­¾è¯é¢è¯•ææ–™æ¸…å• (ç²¾ç¡®+è¯­ä¹‰åŒé«˜åˆ†)
  2. é¢ç­¾å‡†å¤‡äº‹é¡¹ (è¯­ä¹‰é«˜åˆ†)
  3. ç¾å›½B1/B2ç­¾è¯ç”³è¯·æŒ‡å— (ç²¾ç¡®åŒ¹é…)
  4. ä½¿é¦†é¢è°ˆæ³¨æ„äº‹é¡¹ (è¯­ä¹‰ç›¸å…³)
  ...

âœ… ä¼˜åŠ¿: æ—¢æœ‰ç²¾ç¡®åŒ¹é…ï¼Œåˆæœ‰è¯­ä¹‰æ‰©å±•ï¼Œä¿¡æ¯æ›´å…¨é¢ï¼
```

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### RRF èåˆç®—æ³•

```python
# api/knowledge_handler.py Lines 1662-1720
def _rrf_fusion_keyword_vector(
    self,
    keyword_nodes: List[NodeWithScore],
    vector_nodes: List[NodeWithScore],
    k: float = 60.0
) -> List[NodeWithScore]:
    """
    RRF (Reciprocal Rank Fusion) èåˆç®—æ³•
    
    å…¬å¼: score(doc) = Î£ 1/(k + rank(doc))
    
    å…¶ä¸­:
    - k: å¹³æ»‘å‚æ•° (é»˜è®¤60)
    - rank: æ–‡æ¡£åœ¨å„æ£€ç´¢ç»“æœä¸­çš„æ’å
    """
    rrf_scores = defaultdict(float)
    
    # 1. Keyword Table è´¡çŒ®
    for rank, node in enumerate(keyword_nodes, start=1):
        rrf_scores[node.id] += 1.0 / (60 + rank)
    
    # 2. å‘é‡æ£€ç´¢è´¡çŒ®
    for rank, node in enumerate(vector_nodes, start=1):
        rrf_scores[node.id] += 1.0 / (60 + rank)
    
    # 3. æŒ‰ç»¼åˆåˆ†æ•°æ’åº
    return sorted(nodes, key=lambda x: rrf_scores[x.id], reverse=True)
```

### æ¥æºæ ‡è®°

```python
# æ ‡è®°æ£€ç´¢æ¥æºï¼Œä¾¿äºè°ƒè¯•
node.metadata['retrieval_sources'] = ['keyword_table', 'vector']
```

---

## ğŸ“ é…ç½®è¯´æ˜

### å¯ç”¨ Keyword Table

```bash
# .env
ENABLE_KEYWORD_TABLE=true
RETRIEVAL_TOP_K_KEYWORD=30  # ä¸å‘é‡æ£€ç´¢å¯¹é½
```

### æ—¥å¿—è¾“å‡º

```
[Keyword Table] å¼€å§‹æ£€ç´¢
[Keyword Table] æ£€ç´¢æˆåŠŸ | è¿”å› 30 ä¸ªèŠ‚ç‚¹
[èåˆç­–ç•¥] Keyword Table + å‘é‡æ£€ç´¢
[å‘é‡æ£€ç´¢] è¿”å› 30 ä¸ªèŠ‚ç‚¹
[RRFèåˆ] Keyword Table + å‘é‡ â†’ 45 ä¸ªèŠ‚ç‚¹
[RRFèåˆè¯¦æƒ…] Keyword Table: 30 | å‘é‡æ£€ç´¢: 30 | èåˆå: 45 (å»é‡)
æ£€ç´¢å®Œæˆ | æ¨¡å¼: keyword_table_vector_fusion | ç»“æœæ•°: 45
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **Keyword Table ä¸å†ç‹¬ç«‹**ï¼Œè€Œæ˜¯ä¸å‘é‡æ£€ç´¢èåˆ
2. **ç±»ä¼¼ BM25 çš„ä½œç”¨**ï¼Œä½œä¸ºç²¾ç¡®åŒ¹é…çš„è¡¥å……
3. **è‡ªåŠ¨å›é€€æœºåˆ¶**ï¼Œå¤±è´¥æ—¶ä¸å½±å“åŸæœ‰åŠŸèƒ½
4. **å€™é€‰æ•°é‡å¢åŠ **ï¼Œé‡æ’åºè´¨é‡æå‡

### ä½¿ç”¨å»ºè®®

- âœ… **æ¨èå¯ç”¨**: æŸ¥è¯¢åŒ…å«ä¸“æœ‰åè¯ã€æœ¯è¯­ã€ç¼–å·
- âœ… **æ•ˆæœæ˜æ˜¾**: éœ€è¦ç²¾ç¡®åŒ¹é… + è¯­ä¹‰ç†è§£çš„åœºæ™¯
- âŒ **ä¸æ¨è**: çº¯å£è¯­åŒ–ã€æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆå‘é‡æ£€ç´¢å·²è¶³å¤Ÿï¼‰

### æ€§èƒ½å½±å“

- **æ£€ç´¢æ—¶é—´**: +5-10ms (Keyword Table æŸ¥è¯¢æå¿«)
- **å€™é€‰è´¨é‡**: â¬†ï¸ æ˜¾è‘—æå‡
- **æœ€ç»ˆå‡†ç¡®ç‡**: â¬†ï¸ æå‡ 10-20%
