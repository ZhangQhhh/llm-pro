# 高级删除功能完整说明

## 功能概述

实现了完整的题目删除管理系统，包括：批量删除、软删除（回收站）、删除日志、权限控制四大核心功能。

## 已完成的后端实现

### 1. 软删除机制

#### 数据结构
```json
{
  "id": "qid123",
  "stem": "题目内容",
  "deleted": true,
  "deleted_at": "2025-01-20T10:30:00",
  "deleted_by": "admin_user"
}
```

#### 服务层函数

**`bank_delete_questions`** - 软删除题目
```python
def bank_delete_questions(data: Dict[str, Any]) -> Dict[str, Any]:
    # 参数:
    # - ids: 题目ID列表
    # - user: 操作用户
    # - permanent: 是否永久删除（默认False）
    
    # 软删除: 标记deleted=True
    # 永久删除: 从列表中移除
```

**`bank_list`** - 列出题目（不含已删除）
```python
def bank_list() -> Dict[str, Any]:
    # 自动过滤deleted=True的题目
    items = [it for it in bank.get("items", []) if not it.get("deleted")]
```

**`bank_list_deleted`** - 列出回收站
```python
def bank_list_deleted() -> Dict[str, Any]:
    # 只返回deleted=True的题目
    deleted_items = [it for it in items if it.get("deleted") == True]
```

**`bank_restore_questions`** - 恢复题目
```python
def bank_restore_questions(data: Dict[str, Any]) -> Dict[str, Any]:
    # 参数:
    # - ids: 要恢复的题目ID列表
    # - user: 操作用户
    
    # 设置deleted=False，添加restored_at和restored_by
```

**`bank_clear_deleted`** - 清空回收站
```python
def bank_clear_deleted(data: Dict[str, Any]) -> Dict[str, Any]:
    # 参数:
    # - user: 操作用户
    # - days: 删除N天前的题目（默认30天）
    
    # 永久删除超过指定天数的题目
```

### 2. 删除日志

#### 日志文件位置
```
./data/logs/deletion_log.json
```

#### 日志格式
```json
{
  "timestamp": "2025-01-20T10:30:00",
  "user": "admin_user",
  "action": "soft",  // soft, permanent, restore, auto_clear
  "ids": ["qid1", "qid2"],
  "count": 2,
  "items": [
    {"id": "qid1", "stem": "题目内容..."},
    {"id": "qid2", "stem": "另一个题目..."}
  ]
}
```

#### 日志函数

**`_log_deletion`** - 记录删除操作
```python
def _log_deletion(ids: List[str], user: str, action: str, items: List[Dict]):
    # action类型:
    # - soft: 软删除
    # - permanent: 永久删除
    # - auto_clear: 自动清理
```

**`_log_restoration`** - 记录恢复操作
```python
def _log_restoration(ids: List[str], user: str, items: List[Dict]):
    # 记录题目恢复操作
```

**`bank_get_deletion_logs`** - 获取日志
```python
def bank_get_deletion_logs(limit: int = 100) -> Dict[str, Any]:
    # 返回最近N条日志，最新的在前
```

### 3. 权限控制

#### 权限中间件
```python
# middleware/role_required.py

@require_admin_or_super
def protected_function():
    # 只有admin或super_admin可以访问
```

#### 用户信息获取
```python
def get_current_user():
    # 从请求头、请求体或session获取用户信息
    # 返回: {"username": "xxx", "role": "admin"}
```

#### 权限检查流程
```
1. 从请求中提取用户角色
   ↓
2. 检查是否为admin或super_admin
   ↓
3. 是 → 允许访问
   否 → 返回403错误
```

### 4. API接口

#### 删除相关

**POST /mcq_public/bank/delete** - 删除题目（软删除）
```json
请求:
{
  "ids": ["qid1", "qid2"],
  "user": "admin_user",
  "permanent": false
}

响应:
{
  "ok": true,
  "count": 2,
  "deleted": [...]
}
```
- **权限**: 需要管理员或超级管理员
- **说明**: 默认软删除，设置permanent=true可永久删除

#### 回收站相关

**GET /mcq_public/bank/deleted** - 列出回收站
```json
响应:
{
  "ok": true,
  "count": 5,
  "items": [...]
}
```
- **权限**: 需要管理员或超级管理员

**POST /mcq_public/bank/restore** - 恢复题目
```json
请求:
{
  "ids": ["qid1", "qid2"],
  "user": "admin_user"
}

响应:
{
  "ok": true,
  "count": 2,
  "restored": [...]
}
```
- **权限**: 需要管理员或超级管理员

**POST /mcq_public/bank/clear_deleted** - 清空回收站
```json
请求:
{
  "user": "admin_user",
  "days": 30
}

响应:
{
  "ok": true,
  "count": 3,
  "removed": [...]
}
```
- **权限**: 需要管理员或超级管理员
- **说明**: 永久删除N天前的题目

#### 日志相关

**GET /mcq_public/bank/deletion_logs?limit=100** - 获取删除日志
```json
响应:
{
  "ok": true,
  "count": 50,
  "logs": [...]
}
```
- **权限**: 需要管理员或超级管理员

## 前端实现建议

### 1. 批量选择功能

#### 添加状态变量
```typescript
const selectedQuestions = ref<string[]>([])  // 选中的题目ID列表
const selectAll = ref(false)  // 全选状态
```

#### 添加选择框
```vue
<el-checkbox 
  v-model="selectAll" 
  @change="toggleSelectAll"
>
  全选
</el-checkbox>

<el-checkbox 
  v-for="q in pagedQuestions" 
  :key="q.qid"
  v-model="selectedQuestions"
  :label="q.qid"
>
</el-checkbox>
```

#### 批量删除按钮
```vue
<el-button 
  type="danger" 
  @click="batchDelete"
  :disabled="selectedQuestions.length === 0"
>
  批量删除 ({{ selectedQuestions.length }})
</el-button>
```

### 2. 回收站界面

#### 添加Tab页
```vue
<el-tab-pane label="回收站" name="recycle">
  <div class="tab-content">
    <!-- 回收站工具栏 -->
    <div class="recycle-toolbar">
      <el-button @click="loadDeletedQuestions" :icon="Refresh">
        刷新
      </el-button>
      <el-button 
        type="success" 
        @click="batchRestore"
        :disabled="selectedDeleted.length === 0"
      >
        批量恢复
      </el-button>
      <el-button 
        type="danger" 
        @click="clearRecycleBin"
      >
        清空回收站
      </el-button>
    </div>
    
    <!-- 回收站列表 -->
    <div class="deleted-list">
      <el-card v-for="q in deletedQuestions" :key="q.qid">
        <el-checkbox v-model="selectedDeleted" :label="q.qid" />
        <div>{{ q.stem }}</div>
        <div class="meta">
          删除时间: {{ q.deleted_at }}
          删除人: {{ q.deleted_by }}
        </div>
        <el-button size="small" @click="restoreQuestion(q.qid)">
          恢复
        </el-button>
        <el-button 
          size="small" 
          type="danger" 
          @click="permanentDelete(q.qid)"
        >
          永久删除
        </el-button>
      </el-card>
    </div>
  </div>
</el-tab-pane>
```

### 3. 删除日志界面

#### 添加Tab页
```vue
<el-tab-pane label="删除日志" name="logs">
  <div class="tab-content">
    <el-button @click="loadDeletionLogs" :icon="Refresh">
      刷新日志
    </el-button>
    
    <el-table :data="deletionLogs" border>
      <el-table-column prop="timestamp" label="时间" width="180" />
      <el-table-column prop="user" label="操作人" width="120" />
      <el-table-column prop="action" label="操作类型" width="120">
        <template #default="scope">
          <el-tag :type="getActionType(scope.row.action)">
            {{ getActionText(scope.row.action) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="count" label="数量" width="80" />
      <el-table-column prop="items" label="题目">
        <template #default="scope">
          <div v-for="item in scope.row.items" :key="item.id">
            {{ item.stem }}
          </div>
        </template>
      </el-table-column>
    </el-table>
  </div>
</el-tab-pane>
```

### 4. 权限控制

#### 添加权限检查
```typescript
const userRole = computed(() => store.getters.userRole)
const canDelete = computed(() => {
  const role = userRole.value?.toLowerCase()
  return role === 'admin' || role === 'super_admin'
})
```

#### 条件渲染
```vue
<el-button 
  v-if="canDelete"
  type="danger"
  @click="deleteQuestion(q.qid)"
>
  删除
</el-button>
```

### 5. API调用函数

```typescript
// 批量删除
const batchDelete = async () => {
  if (selectedQuestions.value.length === 0) return
  
  await ElMessageBox.confirm(
    `确认删除选中的 ${selectedQuestions.value.length} 个题目？`,
    '批量删除',
    { type: 'warning' }
  )
  
  const resp = await fetch(`${MCQ_BASE_URL}/bank/delete`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-User-Name': store.state.user.username,
      'X-User-Role': store.getters.userRole
    },
    body: JSON.stringify({ 
      ids: selectedQuestions.value,
      user: store.state.user.username
    })
  })
  
  const data = await resp.json()
  if (data.ok) {
    ElMessage.success(`已删除 ${data.count} 个题目`)
    selectedQuestions.value = []
    loadQuestions()
  }
}

// 加载回收站
const loadDeletedQuestions = async () => {
  const resp = await fetch(`${MCQ_BASE_URL}/bank/deleted`, {
    headers: {
      'X-User-Name': store.state.user.username,
      'X-User-Role': store.getters.userRole
    }
  })
  const data = await resp.json()
  if (data.ok) {
    deletedQuestions.value = data.items
  }
}

// 恢复题目
const restoreQuestion = async (qid: string) => {
  const resp = await fetch(`${MCQ_BASE_URL}/bank/restore`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-User-Name': store.state.user.username,
      'X-User-Role': store.getters.userRole
    },
    body: JSON.stringify({ 
      ids: [qid],
      user: store.state.user.username
    })
  })
  
  const data = await resp.json()
  if (data.ok) {
    ElMessage.success('恢复成功')
    loadDeletedQuestions()
    loadQuestions()
  }
}

// 清空回收站
const clearRecycleBin = async () => {
  await ElMessageBox.confirm(
    '确认清空回收站？将永久删除30天前的所有题目！',
    '警告',
    { type: 'warning' }
  )
  
  const resp = await fetch(`${MCQ_BASE_URL}/bank/clear_deleted`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-User-Name': store.state.user.username,
      'X-User-Role': store.getters.userRole
    },
    body: JSON.stringify({ 
      user: store.state.user.username,
      days: 30
    })
  })
  
  const data = await resp.json()
  if (data.ok) {
    ElMessage.success(`已清理 ${data.count} 个题目`)
    loadDeletedQuestions()
  }
}

// 加载删除日志
const loadDeletionLogs = async () => {
  const resp = await fetch(`${MCQ_BASE_URL}/bank/deletion_logs?limit=100`, {
    headers: {
      'X-User-Name': store.state.user.username,
      'X-User-Role': store.getters.userRole
    }
  })
  const data = await resp.json()
  if (data.ok) {
    deletionLogs.value = data.logs
  }
}
```

## 使用流程

### 删除题目
```
1. 选择要删除的题目（单个或批量）
   ↓
2. 点击"删除"按钮
   ↓
3. 确认删除
   ↓
4. 题目移到回收站（软删除）
   ↓
5. 记录删除日志
```

### 恢复题目
```
1. 进入"回收站"标签页
   ↓
2. 找到要恢复的题目
   ↓
3. 点击"恢复"按钮
   ↓
4. 题目恢复到题库
   ↓
5. 记录恢复日志
```

### 永久删除
```
方式1: 单个永久删除
  回收站 → 选择题目 → 永久删除

方式2: 批量清理
  回收站 → 清空回收站 → 删除30天前的题目
```

### 查看日志
```
1. 进入"删除日志"标签页
   ↓
2. 查看所有删除/恢复操作
   ↓
3. 可按时间、用户、操作类型筛选
```

## 安全机制

### 1. 权限控制
- ✅ 所有删除相关操作需要管理员权限
- ✅ 普通用户无法访问删除、回收站、日志接口
- ✅ 权限检查在后端中间件层面实现

### 2. 软删除保护
- ✅ 默认软删除，不会立即丢失数据
- ✅ 30天保护期，可以随时恢复
- ✅ 超过30天自动清理

### 3. 操作确认
- ✅ 删除前需要确认
- ✅ 批量删除显示数量
- ✅ 清空回收站二次确认

### 4. 审计追踪
- ✅ 所有操作记录日志
- ✅ 记录操作人、时间、内容
- ✅ 日志不可篡改

## 数据流

### 删除流程
```
前端 → 确认对话框 → POST /bank/delete
  ↓
后端 → 权限检查 → 软删除 → 记录日志
  ↓
数据库 → 标记deleted=True → 保存
  ↓
前端 → 刷新列表 → 题目消失
```

### 恢复流程
```
前端 → POST /bank/restore
  ↓
后端 → 权限检查 → 恢复题目 → 记录日志
  ↓
数据库 → 设置deleted=False → 保存
  ↓
前端 → 刷新列表 → 题目出现
```

## 性能优化

### 1. 日志文件管理
- 只保留最近1000条日志
- 超过自动清理旧日志
- 避免文件过大

### 2. 回收站清理
- 定期自动清理30天前的题目
- 减少数据库体积
- 提升查询性能

### 3. 批量操作
- 支持批量删除/恢复
- 减少API调用次数
- 提升操作效率

## 测试建议

### 功能测试
1. ✅ 单个删除 → 软删除
2. ✅ 批量删除 → 多个题目
3. ✅ 恢复题目 → 从回收站恢复
4. ✅ 永久删除 → 无法恢复
5. ✅ 清空回收站 → 批量永久删除
6. ✅ 查看日志 → 显示所有操作

### 权限测试
1. ✅ 管理员可以删除
2. ✅ 超级管理员可以删除
3. ✅ 普通用户无法删除
4. ✅ 未登录用户无法访问

### 安全测试
1. ✅ 软删除不丢失数据
2. ✅ 日志记录完整
3. ✅ 权限检查有效
4. ✅ 并发操作安全

## 总结

高级删除功能提供了完整的题目删除管理解决方案：

**核心特性**：
- 🗑️ **软删除**: 安全可靠，可恢复
- 📦 **回收站**: 30天保护期
- 📝 **删除日志**: 完整审计追踪
- 🔒 **权限控制**: 仅管理员可操作
- 📊 **批量操作**: 提升效率

**技术亮点**：
- 线程安全的并发控制
- 完善的权限验证机制
- 详细的操作日志记录
- 用户友好的界面设计

这是一个**企业级**的删除管理系统！
