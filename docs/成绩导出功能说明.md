# MCQ成绩导出功能优化说明

## 更新时间
2024年11月21日

## 功能概述

本次优化为MCQ系统添加了两个核心的成绩导出功能：

### 1. 导出ZIP - 批量成绩报告
将指定试卷的所有考生成绩报告打包成ZIP文件，每个考生一个独立的DOCX报告。

### 2. 导出DOCX - 成绩汇总表
生成一个包含所有考生答题情况和总得分的汇总表格。

## 新增文件和修改

### 修改的文件

#### 1. `services/exam_service.py`
新增了以下函数：

- **`get_paper_attempts(paper_id: str)`**
  - 获取指定试卷的所有已完成考试会话
  - 返回已完成的考试记录列表

- **`export_paper_reports_zip(paper_id: str)`**
  - 导出所有考生的成绩报告为ZIP压缩包
  - 每个考生一个DOCX文件
  - 包含完整的答题详情和解析
  - 自动清理临时文件

- **`export_paper_summary_docx(paper_id: str)`**
  - 导出成绩汇总表为DOCX
  - 包含表格形式的答题情况
  - 包含统计信息（平均分、最高分、最低分）

#### 2. `routes/mcq_public_routes.py`
新增了以下API路由：

- **`GET /mcq_public/grades/export_zip`**
  - 参数：`paper_id`（试卷ID）
  - 返回：ZIP文件流

- **`GET /mcq_public/grades/export_summary_docx`**
  - 参数：`paper_id`（试卷ID）
  - 返回：DOCX文件流

### 新增的文件

#### 1. `docs/GRADES_EXPORT_API.md`
完整的API文档，包含：
- 功能说明
- API接口定义
- 前端调用示例（JavaScript/Vue）
- 后端实现细节
- 注意事项和优化方向

#### 2. `docs/成绩导出功能说明.md`
本文档，中文说明文档

## 使用方法

### 后端API调用

#### 导出ZIP
```
GET /mcq_public/grades/export_zip?paper_id=测试试卷_1234567890.docx
```

#### 导出汇总DOCX
```
GET /mcq_public/grades/export_summary_docx?paper_id=测试试卷_1234567890.docx
```

### 前端集成示例

```javascript
// 导出ZIP
const exportZip = async (paperId) => {
  const url = `/mcq_public/grades/export_zip?paper_id=${encodeURIComponent(paperId)}`;
  window.open(url, '_blank');
};

// 导出汇总DOCX
const exportSummary = async (paperId) => {
  const url = `/mcq_public/grades/export_summary_docx?paper_id=${encodeURIComponent(paperId)}`;
  window.open(url, '_blank');
};
```

## 导出内容详解

### ZIP压缩包内容

每个DOCX文件包含：
```
考试成绩报告
├── 基本信息
│   ├── 学生ID
│   ├── 试卷名称
│   ├── 开始时间
│   ├── 结束时间
│   └── 总分
└── 答题详情
    └── 每道题
        ├── 题目内容
        ├── 选项
        ├── 标准答案
        ├── 学生答案
        ├── 判定结果
        └── 解析
```

### 汇总DOCX内容

```
考试成绩汇总表
├── 试卷信息
│   ├── 试卷名称
│   └── 考试人数
├── 成绩表格
│   └── 表格列：学生ID | Q1 | Q2 | ... | Qn | 总分
│       └── 每题显示：答案 ✓/✗
└── 统计信息
    ├── 平均分
    ├── 最高分
    └── 最低分
```

## 文件存储位置

- **临时报告**：`./data/reports_temp/`（自动清理）
- **ZIP文件**：`./data/reports_zip/`
- **汇总DOCX**：`./data/reports/`
- **考试记录**：`./data/exam_attempts.json`

## 技术特点

### 1. 线程安全
- 使用锁机制保护考试记录的读写
- 避免并发访问导致的数据不一致

### 2. 自动清理
- ZIP导出后自动删除临时DOCX文件
- 避免磁盘空间浪费

### 3. 错误处理
- 完整的异常捕获和日志记录
- 友好的错误提示信息

### 4. 文件命名规范
- 包含时间戳，避免文件名冲突
- 包含试卷名称，便于识别

## 依赖要求

```bash
pip install python-docx
```

## 测试建议

### 1. 功能测试
- 测试没有考试记录的试卷（应返回404）
- 测试只有一个考生的试卷
- 测试多个考生的试卷
- 测试包含未作答题目的情况

### 2. 性能测试
- 测试大量考生（如100+）的导出性能
- 测试大量题目（如50+）的导出性能

### 3. 边界测试
- 测试特殊字符的学生ID
- 测试超长的题目和解析
- 测试并发导出请求

## 已知限制

1. **同步导出**：当前为同步导出，大量考生时可能耗时较长
2. **无权限控制**：当前未添加权限验证，任何人都可以导出
3. **无缓存机制**：每次请求都重新生成文件

## 未来优化方向

### 短期优化
1. 添加权限验证（教师/管理员才能导出）
2. 添加导出进度提示
3. 优化文件清理策略

### 长期优化
1. 改为异步任务，支持后台导出
2. 添加导出历史记录
3. 支持Excel格式导出
4. 支持自定义导出模板
5. 支持邮件发送成绩报告

## 维护建议

1. **定期清理**：建议每月清理一次 `./data/reports_zip/` 和 `./data/reports/` 目录
2. **日志监控**：关注导出失败的日志，及时发现问题
3. **性能监控**：监控导出接口的响应时间，必要时优化

## 联系方式

如有问题或建议，请联系开发团队。
