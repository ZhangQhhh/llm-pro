# ä»£ç å—ç¬¦å·è¿‡æ»¤ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

### ç°è±¡
LLM è¾“å‡ºçš„æ–‡æœ¬ä¸­å‡ºç° **é»‘è‰²èƒŒæ™¯çš„ä»£ç å—**ï¼Œå¯¼è‡´æ­£å¸¸å›ç­”è¢«æ¸²æŸ“æˆä»£ç æ ·å¼ã€‚

### æˆªå›¾é—®é¢˜
```
æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯å¯æ­£å¸¸å‡ºå›½ä¸Šè¿°è§„æ ¼æŠ¥ä¸šè§„èŒƒç«‹ä¸šåŠ¡è§„å®š1-æŸæ•°ç¬¦å·"Q2ç­¾è¯"...
```
â†‘ è¿™æ®µæ–‡æœ¬è¢«åŒ…è£¹åœ¨é»‘è‰²ä»£ç æ¡†ä¸­

### æ ¹æœ¬åŸå› 
LLM è¾“å‡ºä¸­åŒ…å«äº† ``` ä»£ç å—æ ‡è®°ç¬¦å·ï¼Œå‰ç«¯å°†å…¶è¯†åˆ«ä¸º Markdown ä»£ç å—å¹¶æ¸²æŸ“æˆä»£ç æ ·å¼ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### å¯èƒ½çš„ä»£ç å—ç¬¦å·å˜ä½“

1. **åŠè§’åå¼•å·**ï¼ˆæ ‡å‡†ï¼‰: ` ``` `
2. **å…¨è§’åå¼•å·**ï¼ˆä¸­æ–‡è¾“å…¥æ³•ï¼‰: ` ``` `
3. **æ··åˆåå¼•å·**: ` `` ` æˆ– ` `` `
4. **è¿ç»­åå¼•å·**: ` ````` ` (3ä¸ªæˆ–ä»¥ä¸Š)

### ä¸ºä»€ä¹ˆä¹‹å‰çš„è¿‡æ»¤å¤±æ•ˆï¼Ÿ

æ—§ä»£ç åªè¿‡æ»¤äº†**åŠè§’åå¼•å·**:
```python
# âŒ æ—§é€»è¾‘ï¼šåªè¿‡æ»¤åŠè§’
cleaned = text.replace('```', '')
```

ä½† LLM å¯èƒ½è¾“å‡º**å…¨è§’åå¼•å·**ï¼ˆå°¤å…¶æ˜¯ä¸­æ–‡æ¨¡å‹ï¼‰ï¼Œå¯¼è‡´è¿‡æ»¤å¤±æ•ˆã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºé€šç”¨è¿‡æ»¤å‡½æ•°

**æ–‡ä»¶**: `utils/knowledge_utils/llm_stream_parser.py`

```python
def _remove_code_blocks(text: str) -> str:
    """
    ç§»é™¤æ–‡æœ¬ä¸­çš„æ‰€æœ‰ä»£ç å—ç¬¦å·ï¼ˆåŒ…æ‹¬å„ç§å˜ä½“ï¼‰
    
    å¤„ç†:
    1. åŠè§’åå¼•å·ï¼ˆæ ‡å‡†ï¼‰: ```
    2. å…¨è§’åå¼•å·ï¼ˆä¸­æ–‡è¾“å…¥æ³•ï¼‰: ```
    3. æ··åˆåå¼•å·: ``ã€``
    4. è¿ç»­åå¼•å·: 3ä¸ªæˆ–ä»¥ä¸Šçš„åå¼•å·
    """
    import re
    
    cleaned = text
    
    # 1. åŠè§’åå¼•å·ï¼ˆæ ‡å‡†ï¼‰
    cleaned = cleaned.replace('```', '')
    
    # 2. å…¨è§’åå¼•å·ï¼ˆä¸­æ–‡è¾“å…¥æ³•ï¼‰
    cleaned = cleaned.replace('```', '')
    
    # 3. æ··åˆåå¼•å·
    cleaned = cleaned.replace('``', '')
    cleaned = cleaned.replace('``', '')
    
    # 4. æ­£åˆ™è¡¨è¾¾å¼ï¼š3ä¸ªæˆ–ä»¥ä¸Šçš„åå¼•å·
    cleaned = re.sub(r'`{3,}', '', cleaned)
    
    return cleaned
```

### 2. åœ¨æ‰€æœ‰è¾“å‡ºç‚¹åº”ç”¨è¿‡æ»¤

**ä¿®æ”¹ä½ç½®**: `utils/knowledge_utils/llm_stream_parser.py`

#### æ€è€ƒæ¨¡å¼ (parse_thinking_stream)

```python
# Line 88: æµå¼è¾“å‡ºæ­£æ–‡å†…å®¹
cleaned_content = _remove_code_blocks(content_buffer)

# Line 145: å‰©ä½™æ­£æ–‡å†…å®¹
cleaned_content = _remove_code_blocks(content_buffer)

# Line 160: æ–‡æœ¬æ ‡è®°æ¨¡å¼çš„æ­£æ–‡
cleaned_buffer = _remove_code_blocks(cleaned_buffer)
```

#### æ™®é€šæ¨¡å¼ (parse_normal_stream)

```python
# Line 189: æµå¼è¾“å‡º
cleaned_buffer = _remove_code_blocks(buffer)

# Line 196: å‰©ä½™å†…å®¹
cleaned_buffer = _remove_code_blocks(buffer)
```

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
`tests/test_code_block_filter.py`

### æµ‹è¯•ç”¨ä¾‹

| è¾“å…¥ | æœŸæœ›è¾“å‡º | æè¿° |
|------|---------|------|
| ` ```python\ncode\n``` ` | `python\ncode\n` | æ ‡å‡†ä»£ç å— |
| ` ```python\ncode\n``` ` | `python\ncode\n` | å…¨è§’ä»£ç å— |
| `è¿™æ˜¯```ä»£ç ```ç¤ºä¾‹` | `è¿™æ˜¯ä»£ç ç¤ºä¾‹` | è¡Œå†…ä»£ç å— |
| ` ``æ··åˆ`` ` | `æ··åˆ` | æ··åˆåå¼•å· |
| ` ``````` ` | `` | è¿ç»­åå¼•å· |

### è¿è¡Œæµ‹è¯•

```bash
cd e:\project\code_here\llm_pro
python tests/test_code_block_filter.py
```

**æœŸæœ›è¾“å‡º**:
```
================================================================================
ä»£ç å—ç¬¦å·è¿‡æ»¤æµ‹è¯•
================================================================================

æµ‹è¯• 1: æ ‡å‡†ä»£ç å—
  âœ… PASS

æµ‹è¯• 2: å…¨è§’ä»£ç å—
  âœ… PASS

...

================================================================================
æµ‹è¯•ç»“æœ: 8 é€šè¿‡, 0 å¤±è´¥
================================================================================
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
LLM è¾“å‡º: "æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯```å¯æ­£å¸¸å‡ºå›½```ä¸Šè¿°è§„æ ¼..."
    â†“
å‰ç«¯æ¸²æŸ“: [é»‘è‰²ä»£ç æ¡†] æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯```å¯æ­£å¸¸å‡ºå›½```ä¸Šè¿°è§„æ ¼...
```

### ä¿®å¤å
```
LLM è¾“å‡º: "æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯```å¯æ­£å¸¸å‡ºå›½```ä¸Šè¿°è§„æ ¼..."
    â†“
è¿‡æ»¤å¤„ç†: "æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯å¯æ­£å¸¸å‡ºå›½ä¸Šè¿°è§„æ ¼..."
    â†“
å‰ç«¯æ¸²æŸ“: æ ¸éªŒ1ç²¾ç®€æ”¹è¿™äº›è¯å¯æ­£å¸¸å‡ºå›½ä¸Šè¿°è§„æ ¼...ï¼ˆæ­£å¸¸æ–‡æœ¬ï¼‰
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### è¿‡æ»¤æ—¶æœº
åœ¨ **SSE æµå¼è¾“å‡ºä¹‹å‰** è¿‡æ»¤ï¼Œç¡®ä¿å‰ç«¯æ”¶åˆ°çš„æ–‡æœ¬å·²ç»æ˜¯å¹²å‡€çš„ã€‚

### è¿‡æ»¤ä½ç½®
æ‰€æœ‰ `yield ('CONTENT', ...)` ä¹‹å‰éƒ½ä¼šè°ƒç”¨ `_remove_code_blocks()`ã€‚

### æ€§èƒ½å½±å“
- æ­£åˆ™è¡¨è¾¾å¼: `re.sub(r'`{3,}', '', text)` æ€§èƒ½å¼€é”€ < 1ms
- å­—ç¬¦ä¸²æ›¿æ¢: 4æ¬¡ `replace()` è°ƒç”¨ï¼Œæ€§èƒ½å¼€é”€ < 0.1ms
- **æ€»å¼€é”€**: < 2msï¼Œå¯å¿½ç•¥ä¸è®¡

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `utils/knowledge_utils/llm_stream_parser.py`
   - æ–°å¢ `_remove_code_blocks()` å‡½æ•°
   - åœ¨æ‰€æœ‰è¾“å‡ºç‚¹åº”ç”¨è¿‡æ»¤

### æ–°å¢çš„æ–‡ä»¶
1. `tests/test_code_block_filter.py` - æµ‹è¯•è„šæœ¬
2. `docs/CODE_BLOCK_FILTER_FIX.md` - æœ¬æ–‡æ¡£

---

## âœ… éªŒè¯æ¸…å•

- [x] åˆ›å»º `_remove_code_blocks()` å‡½æ•°
- [x] åœ¨æ€è€ƒæ¨¡å¼çš„æ‰€æœ‰è¾“å‡ºç‚¹åº”ç”¨è¿‡æ»¤
- [x] åœ¨æ™®é€šæ¨¡å¼çš„æ‰€æœ‰è¾“å‡ºç‚¹åº”ç”¨è¿‡æ»¤
- [x] åˆ›å»ºæµ‹è¯•è„šæœ¬
- [x] ç¼–å†™æ–‡æ¡£

---

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **é‡å¯åº”ç”¨**: ä¿®æ”¹ç”Ÿæ•ˆéœ€è¦é‡å¯ FastAPI åº”ç”¨
2. **è§‚å¯Ÿæ—¥å¿—**: æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä»£ç å—ç¬¦å·è¾“å‡º
3. **å‰ç«¯éªŒè¯**: ç¡®è®¤å‰ç«¯ä¸å†å‡ºç°é»‘è‰²ä»£ç æ¡†
4. **å›å½’æµ‹è¯•**: ç¡®ä¿æ­£å¸¸çš„ä»£ç ç¤ºä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰ä¸å—å½±å“

---

## ğŸ“ ç»éªŒæ€»ç»“

### é—®é¢˜æ ¹æº
- LLM è¾“å‡ºçš„ä¸ç¡®å®šæ€§ï¼ˆå¯èƒ½è¾“å‡ºå…¨è§’/åŠè§’ç¬¦å·ï¼‰
- å‰ç«¯ Markdown æ¸²æŸ“çš„æ•æ„Ÿæ€§ï¼ˆè¯†åˆ« ``` ä¸ºä»£ç å—ï¼‰

### è§£å†³æ€è·¯
1. **å…¨é¢è¿‡æ»¤**: è¦†ç›–æ‰€æœ‰å¯èƒ½çš„ä»£ç å—ç¬¦å·å˜ä½“
2. **ç»Ÿä¸€å¤„ç†**: åœ¨æµå¼è¾“å‡ºçš„ç»Ÿä¸€ä½ç½®è¿‡æ»¤
3. **å……åˆ†æµ‹è¯•**: è¦†ç›–å„ç§è¾¹ç•Œæƒ…å†µ

### æœ€ä½³å®è·µ
- âœ… åœ¨æ•°æ®æºå¤´è¿‡æ»¤ï¼ˆSSE è¾“å‡ºå‰ï¼‰
- âœ… ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å¤æ‚æ¨¡å¼
- âœ… æä¾›æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœ
- âœ… æ–‡æ¡£åŒ–ä¿®å¤è¿‡ç¨‹å’ŒåŸç†
