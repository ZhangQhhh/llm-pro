# 规则注入策略 - 基于相关性的动态注入

## 策略概述

规则知识库采用**基于相关性的动态注入策略**，根据检索结果的相关性分数智能决定注入规则的数量。

## 注入逻辑

```
检索规则库
    ↓
计算相关性分数
    ↓
┌─────────────────────────────────────┐
│ 判断1: 是否有高相关性规则？          │
│ (分数 >= 0.7)                       │
└─────────────────────────────────────┘
    ↓ 是                    ↓ 否
注入1-8条高相关性规则    ┌─────────────────────────────────────┐
                        │ 判断2: 最高分是否 >= 0.5？          │
                        └─────────────────────────────────────┘
                            ↓ 是              ↓ 否
                        至少注入1条        不注入规则
                        中等相关性规则
```

## 配置参数

```python
# config/settings.py

# 高相关性阈值
RULES_HIGH_RELEVANCE_THRESHOLD = 0.7

# 最低相关性阈值（至少注入1条的门槛）
RULES_MIN_RELEVANCE_THRESHOLD = 0.5

# 最多注入规则数量
RULES_MAX_INJECT_COUNT = 8

# 最少注入规则数量（当分数 >= 0.5 时）
RULES_MIN_INJECT_COUNT = 1
```

## 三种场景

### 场景1：高相关性（分数 >= 0.7）

**示例**：用户问 "JS0 在什么时候扣减次数？"

```
检索结果：
- 规则1: JS计数器规则 (分数: 0.85)
- 规则2: 港澳通行证管理 (分数: 0.78)
- 规则3: 签注扣减规则 (分数: 0.72)
- 规则4: 出入境手续 (分数: 0.68)
- 规则5: 其他规则 (分数: 0.55)

注入策略：
✓ 发现 3 条高相关性规则（>=0.7）
✓ 注入前 3 条规则
```

**日志输出**：
```
[规则注入] 检索到 5 条规则，Top3分数: 0.850, 0.780, 0.720
[规则注入] 发现 3 条高相关性规则（>=0.7），注入前 3 条
[规则注入] ✓ 已注入 3 条规则，总节点数: 23
```

---

### 场景2：中等相关性（0.5 <= 分数 < 0.7）

**示例**：用户问 "护照有效期不足6个月可以出境吗？"

```
检索结果：
- 规则1: 出入境手续办理规则 (分数: 0.62)
- 规则2: 其他规则 (分数: 0.45)
- 规则3: 其他规则 (分数: 0.38)

注入策略：
✓ 无高相关性规则
✓ 但最高分 0.62 >= 0.5
✓ 至少注入 1 条中等相关性规则
```

**日志输出**：
```
[规则注入] 检索到 3 条规则，Top3分数: 0.620, 0.450, 0.380
[规则注入] 无高相关性规则，但最高分 0.620 >= 0.5，注入 1 条中等相关性规则
[规则注入] ✓ 已注入 1 条规则，总节点数: 21
```

---

### 场景3：低相关性（分数 < 0.5）

**示例**：用户问 "北京今天天气怎么样？"

```
检索结果：
- 规则1: 某规则 (分数: 0.35)
- 规则2: 某规则 (分数: 0.28)
- 规则3: 某规则 (分数: 0.22)

注入策略：
✗ 无高相关性规则
✗ 最高分 0.35 < 0.5
✗ 相关性过低，不注入规则
```

**日志输出**：
```
[规则注入] 检索到 3 条规则，Top3分数: 0.350, 0.280, 0.220
[规则注入] 最高分 0.350 < 0.5，相关性过低，跳过注入
```

---

## 注入后的分数调整

注入的规则会被赋予固定高分，确保排在业务规定前面：

```python
# 第1条规则: 1.00
# 第2条规则: 0.99
# 第3条规则: 0.98
# 第4条规则: 0.97
# ...
# 第8条规则: 0.93

for i, rule_node in enumerate(rules_to_inject):
    rule_node.score = 1.0 - (i * 0.01)
```

**最终上下文排序**：
```
规则1 (1.00) ← 注入的规则
规则2 (0.99) ← 注入的规则
规则3 (0.98) ← 注入的规则
────────────────────────
业务规定1 (0.85)
业务规定2 (0.82)
业务规定3 (0.78)
...
```

## 优势

### 1. **智能动态调整**
- 高相关性问题：注入更多规则（1-8条）
- 中等相关性问题：注入少量规则（1条）
- 低相关性问题：不注入规则，避免噪音

### 2. **避免上下文污染**
- 只注入真正相关的规则
- 节省上下文空间
- 减少 LLM 干扰

### 3. **保证覆盖**
- 即使没有高相关性规则，也会注入1条中等相关性规则
- 避免完全遗漏可能有用的规则

### 4. **可调整性**
- 通过配置参数灵活调整阈值
- 适应不同业务场景

## 调整建议

### 如果规则注入太多

```python
# 降低高相关性阈值
RULES_HIGH_RELEVANCE_THRESHOLD = 0.75  # 从 0.7 提高到 0.75

# 或减少最大注入数量
RULES_MAX_INJECT_COUNT = 5  # 从 8 减少到 5
```

### 如果规则注入太少

```python
# 降低高相关性阈值
RULES_HIGH_RELEVANCE_THRESHOLD = 0.65  # 从 0.7 降低到 0.65

# 或降低最低相关性阈值
RULES_MIN_RELEVANCE_THRESHOLD = 0.4  # 从 0.5 降低到 0.4
```

### 如果想禁用中等相关性注入

```python
# 设置最低阈值等于高阈值
RULES_MIN_RELEVANCE_THRESHOLD = 0.7  # 与高阈值相同
```

## 监控与调试

### 查看注入日志

```bash
tail -f /opt/rag_final_project/qa_logs/app.log | grep "规则注入"
```

### 统计注入情况

```bash
# 统计注入了多少条规则的次数
grep "已注入" app.log | awk '{print $NF}' | sort | uniq -c

# 示例输出：
#  45 1条规则
#  23 2条规则
#  12 3条规则
#   5 4条规则
```

### 分析相关性分布

```bash
# 查看规则检索的分数分布
grep "Top3分数" app.log | tail -20
```

## 实现细节

### 核心代码位置

`api/knowledge_handler.py` 的 `_retrieve_and_rerank()` 方法：

```python
# 基于相关性的动态规则注入
if self.rules_retriever:
    rules_nodes = self.rules_retriever.retrieve(question)
    
    # 1. 筛选高相关性规则
    high_relevance_rules = [
        node for node in rules_nodes 
        if node.score >= Settings.RULES_HIGH_RELEVANCE_THRESHOLD
    ]
    
    # 2. 决定注入策略
    if high_relevance_rules:
        rules_to_inject = high_relevance_rules[:Settings.RULES_MAX_INJECT_COUNT]
    elif rules_nodes[0].score >= Settings.RULES_MIN_RELEVANCE_THRESHOLD:
        rules_to_inject = rules_nodes[:Settings.RULES_MIN_INJECT_COUNT]
    else:
        rules_to_inject = []
    
    # 3. 执行注入
    if rules_to_inject:
        for i, rule_node in enumerate(rules_to_inject):
            rule_node.score = 1.0 - (i * 0.01)
        reranked_nodes = rules_to_inject + reranked_nodes
```

## 总结

新的注入策略实现了：

1. ✅ **智能动态**：根据相关性自动调整注入数量（0-8条）
2. ✅ **避免噪音**：低相关性规则不注入
3. ✅ **保证覆盖**：中等相关性至少注入1条
4. ✅ **灵活可调**：通过配置参数调整策略
5. ✅ **详细日志**：便于监控和调试

相比之前的"固定注入3条"，新策略更加智能和高效！
