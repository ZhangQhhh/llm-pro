# åˆ é™¤é¢˜ç›®åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸ºé¢˜åº“ç®¡ç†ç³»ç»Ÿæ·»åŠ äº†åˆ é™¤é¢˜ç›®çš„åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨å‰ç«¯ç•Œé¢åˆ é™¤ä¸éœ€è¦çš„é¢˜ç›®ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘æœ¬åœ°æ–‡ä»¶ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

### 1. **å®‰å…¨ç¡®è®¤æœºåˆ¶**
- åˆ é™¤å‰å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- æ˜ç¡®æç¤º"åˆ é™¤åæ— æ³•æ¢å¤"
- é˜²æ­¢è¯¯æ“ä½œ

### 2. **å³æ—¶åé¦ˆ**
- åˆ é™¤æŒ‰é’®å¸¦loadingçŠ¶æ€
- æ“ä½œæˆåŠŸ/å¤±è´¥å³æ—¶æç¤º
- è‡ªåŠ¨åˆ·æ–°é¢˜ç›®åˆ—è¡¨

### 3. **ç•Œé¢å‹å¥½**
- åˆ é™¤æŒ‰é’®ä½¿ç”¨å±é™©è‰²ï¼ˆçº¢è‰²ï¼‰+ plainæ ·å¼
- ä¸å…¶ä»–æ“ä½œæŒ‰é’®è§†è§‰åŒºåˆ†æ˜æ˜¾
- æŒ‰é’®å¤§å°ç»Ÿä¸€ï¼ˆsize="small"ï¼‰

## å®ç°ç»†èŠ‚

### åç«¯å®ç°

#### 1. æœåŠ¡å±‚å‡½æ•° (`services/mcq_service.py`)

```python
def bank_delete_questions(data: Dict[str, Any]) -> Dict[str, Any]:
    """
    åˆ é™¤é¢˜ç›®
    data: {"ids": ["qid1", "qid2", ...]} æˆ– {"items": [{"id": "qid1"}, ...]}
    """
    ids = data.get("ids") or []
    if not ids and isinstance(data.get("items"), list):
        ids = [str(it.get("id")) for it in (data.get("items") or []) if it.get("id")]
    ids = [str(x).strip() for x in ids if str(x).strip()]
    if not ids:
        return {"ok": False, "msg": "ids ä¸èƒ½ä¸ºç©º"}

    deleted = []
    with _BANK_LOCK:
        bank = _load_bank()
        items = bank.get("items", [])
        idx = _index_by_id(items)
        
        # æ”¶é›†è¦åˆ é™¤çš„é¢˜ç›®
        for _id in ids:
            j = idx.get(_id)
            if j is not None:
                deleted.append(items[j])
        
        # è¿‡æ»¤æ‰è¦åˆ é™¤çš„é¢˜ç›®
        bank["items"] = [it for it in items if str(it.get("id")) not in ids]
        _atomic_save_bank(bank)

    return {"ok": True, "count": len(deleted), "deleted": deleted}
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨çº¿ç¨‹é”ä¿è¯å¹¶å‘å®‰å…¨
- æ”¯æŒæ‰¹é‡åˆ é™¤ï¼ˆè™½ç„¶å‰ç«¯ç›®å‰åªåˆ é™¤å•ä¸ªï¼‰
- è¿”å›è¢«åˆ é™¤çš„é¢˜ç›®ä¿¡æ¯
- åŸå­æ€§æ“ä½œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### 2. è·¯ç”±æ¥å£ (`routes/mcq_public_routes.py`)

```python
@mcq_public_bp.route("/bank/delete", methods=["POST"])
def bank_delete_api():
    """åˆ é™¤é¢˜ç›®"""
    data = request.get_json() or {}
    return jsonify(bank_delete_questions(data))
```

**API è§„èŒƒ**ï¼š
- **è·¯å¾„**: `/mcq_public/bank/delete`
- **æ–¹æ³•**: POST
- **è¯·æ±‚ä½“**: `{"ids": ["qid1", "qid2", ...]}`
- **å“åº”**: `{"ok": true, "count": 1, "deleted": [...]}`

### å‰ç«¯å®ç°

#### 1. æ¨¡æ¿éƒ¨åˆ† (`AdminView.vue`)

```vue
<!-- åˆ é™¤æŒ‰é’® -->
<el-button
  size="small"
  type="danger"
  plain
  @click="deleteQuestion(q.qid)"
  :loading="deletingQuestion[q.qid]"
>
  åˆ é™¤
</el-button>
```

**ä½ç½®**ï¼šåœ¨æ¯ä¸ªé¢˜ç›®å¡ç‰‡çš„æ“ä½œæŒ‰é’®åŒºåŸŸï¼Œä½äº"é©³å›"æŒ‰é’®ä¹‹å

#### 2. çŠ¶æ€ç®¡ç†

```typescript
const deletingQuestion = reactive<Record<string, boolean>>({})
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ reactive å¯¹è±¡è®°å½•æ¯ä¸ªé¢˜ç›®çš„åˆ é™¤çŠ¶æ€
- é”®ä¸ºé¢˜ç›®IDï¼ˆqidï¼‰ï¼Œå€¼ä¸ºå¸ƒå°”å€¼
- æ”¯æŒå¤šä¸ªé¢˜ç›®åŒæ—¶åˆ é™¤ï¼ˆè™½ç„¶å½“å‰åªæ”¯æŒå•ä¸ªï¼‰

#### 3. åˆ é™¤å‡½æ•°

```typescript
const deleteQuestion = async (qid: string) => {
  try {
    await ElMessageBox.confirm('ç¡®è®¤åˆ é™¤è¯¥é¢˜ç›®ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼', 'è­¦å‘Š', {
      confirmButtonText: 'ç¡®å®šåˆ é™¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })
    deletingQuestion[qid] = true
    const resp = await fetch(`${MCQ_BASE_URL}/bank/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: [qid] })
    })
    const data = await resp.json()
    if (data?.ok) {
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      loadQuestions()
    } else {
      throw new Error(data?.msg || 'åˆ é™¤å¤±è´¥')
    }
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error('åˆ é™¤å¤±è´¥ï¼š' + (error?.message || error))
    }
  } finally {
    deletingQuestion[qid] = false
  }
}
```

**æµç¨‹**ï¼š
1. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
2. ç”¨æˆ·ç¡®è®¤åï¼Œè®¾ç½®loadingçŠ¶æ€
3. è°ƒç”¨åç«¯APIåˆ é™¤é¢˜ç›®
4. æ ¹æ®å“åº”æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ¶ˆæ¯
5. æˆåŠŸååˆ·æ–°é¢˜ç›®åˆ—è¡¨
6. æœ€åæ¸…é™¤loadingçŠ¶æ€

## ç”¨æˆ·æ“ä½œæµç¨‹

```
1. ç”¨æˆ·åœ¨é¢˜åº“ç®¡ç†é¡µé¢æ‰¾åˆ°è¦åˆ é™¤çš„é¢˜ç›®
   â†“
2. ç‚¹å‡»é¢˜ç›®å¡ç‰‡ä¸­çš„"åˆ é™¤"æŒ‰é’®
   â†“
3. ç³»ç»Ÿå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼š
   "ç¡®è®¤åˆ é™¤è¯¥é¢˜ç›®ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼"
   â†“
4. ç”¨æˆ·ç‚¹å‡»"ç¡®å®šåˆ é™¤"
   â†“
5. åˆ é™¤æŒ‰é’®æ˜¾ç¤ºloadingçŠ¶æ€
   â†“
6. åç«¯åˆ é™¤é¢˜ç›®å¹¶è¿”å›ç»“æœ
   â†“
7. å‰ç«¯æ˜¾ç¤º"åˆ é™¤æˆåŠŸ"æ¶ˆæ¯
   â†“
8. è‡ªåŠ¨åˆ·æ–°é¢˜ç›®åˆ—è¡¨ï¼Œåˆ é™¤çš„é¢˜ç›®æ¶ˆå¤±
```

## å®‰å…¨æœºåˆ¶

### 1. **å‰ç«¯ç¡®è®¤**
- ä½¿ç”¨ `ElMessageBox.confirm` å¼¹å‡ºç¡®è®¤æ¡†
- æ˜ç¡®è­¦å‘Š"åˆ é™¤åæ— æ³•æ¢å¤"
- ç”¨æˆ·å¿…é¡»ä¸»åŠ¨ç‚¹å‡»"ç¡®å®šåˆ é™¤"

### 2. **åç«¯éªŒè¯**
- æ£€æŸ¥ `ids` å‚æ•°æ˜¯å¦ä¸ºç©º
- ä½¿ç”¨çº¿ç¨‹é”ä¿è¯å¹¶å‘å®‰å…¨
- åŸå­æ€§ä¿å­˜ï¼Œé˜²æ­¢æ•°æ®æŸå

### 3. **é”™è¯¯å¤„ç†**
- å‰ç«¯æ•è·æ‰€æœ‰å¼‚å¸¸å¹¶æ˜¾ç¤ºå‹å¥½æç¤º
- åç«¯è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- ç”¨æˆ·å–æ¶ˆæ“ä½œä¸æ˜¾ç¤ºé”™è¯¯æç¤º

## ç•Œé¢è®¾è®¡

### æŒ‰é’®æ ·å¼
```vue
<el-button
  size="small"          <!-- å°å°ºå¯¸ï¼Œä¸å…¶ä»–æŒ‰é’®ä¸€è‡´ -->
  type="danger"         <!-- å±é™©æ“ä½œï¼Œçº¢è‰² -->
  plain                 <!-- é•‚ç©ºæ ·å¼ï¼Œä¸é‚£ä¹ˆçªå…€ -->
  @click="deleteQuestion(q.qid)"
  :loading="deletingQuestion[q.qid]"  <!-- loadingçŠ¶æ€ -->
>
  åˆ é™¤
</el-button>
```

### è§†è§‰æ•ˆæœ
- **é¢œè‰²**ï¼šçº¢è‰²ï¼ˆdangerï¼‰ï¼Œè¡¨ç¤ºå±é™©æ“ä½œ
- **æ ·å¼**ï¼šplainï¼ˆé•‚ç©ºï¼‰ï¼Œä¸ä¼šè¿‡äºçªå‡º
- **ä½ç½®**ï¼šåœ¨"é©³å›"æŒ‰é’®ä¹‹åï¼Œæ“ä½œåŒºåŸŸæœ€å³ä¾§
- **çŠ¶æ€**ï¼šåˆ é™¤ä¸­æ˜¾ç¤ºloadingåŠ¨ç”»

## æ•°æ®æµ

```
å‰ç«¯ AdminView.vue
    â†“ (ç‚¹å‡»åˆ é™¤æŒ‰é’®)
    â†“ (ç¡®è®¤å¯¹è¯æ¡†)
    â†“ (POST /mcq_public/bank/delete)
åç«¯ routes/mcq_public_routes.py
    â†“ (è°ƒç”¨æœåŠ¡å±‚)
åç«¯ services/mcq_service.py
    â†“ (bank_delete_questions)
    â†“ (åŠ è½½é¢˜åº“)
    â†“ (è¿‡æ»¤é¢˜ç›®)
    â†“ (ä¿å­˜é¢˜åº“)
    â†“ (è¿”å›ç»“æœ)
å‰ç«¯ AdminView.vue
    â†“ (æ˜¾ç¤ºæ¶ˆæ¯)
    â†“ (åˆ·æ–°åˆ—è¡¨)
```

## ä¸å…¶ä»–åŠŸèƒ½çš„å¯¹æ¯”

| åŠŸèƒ½ | æ“ä½œ | å¯é€†æ€§ | ç¡®è®¤æœºåˆ¶ | æŒ‰é’®æ ·å¼ |
|------|------|--------|----------|----------|
| **é€šè¿‡** | ä¿®æ”¹çŠ¶æ€ä¸ºapproved | âœ… å¯é€† | âŒ æ—  | success |
| **é©³å›** | ä¿®æ”¹çŠ¶æ€ä¸ºrejected | âœ… å¯é€† | âœ… è¾“å…¥åŸå›  | danger |
| **åˆ é™¤** | ä»é¢˜åº“ç§»é™¤ | âŒ ä¸å¯é€† | âœ… ç¡®è®¤å¯¹è¯æ¡† | danger plain |

## ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯
1. **é‡å¤é¢˜ç›®**ï¼šä¸Šä¼ æ—¶ä¸å°å¿ƒé‡å¤äº†
2. **é”™è¯¯é¢˜ç›®**ï¼šé¢˜ç›®æœ¬èº«æœ‰ä¸¥é‡é”™è¯¯ï¼Œæ— æ³•ä¿®å¤
3. **è¿‡æ—¶é¢˜ç›®**ï¼šä¸å†é€‚ç”¨çš„æ—§é¢˜ç›®
4. **æµ‹è¯•é¢˜ç›®**ï¼šæµ‹è¯•æ—¶æ·»åŠ çš„ä¸´æ—¶é¢˜ç›®

### ä¸é€‚ç”¨åœºæ™¯
1. **ä¸´æ—¶éšè—**ï¼šåº”ä½¿ç”¨"é©³å›"åŠŸèƒ½
2. **æ‰¹é‡æ¸…ç†**ï¼šç›®å‰åªæ”¯æŒå•ä¸ªåˆ é™¤
3. **æ¡ä»¶åˆ é™¤**ï¼šéœ€è¦æ‰‹åŠ¨é€ä¸ªç¡®è®¤

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. **æ‰¹é‡åˆ é™¤**
```vue
<el-button @click="deleteSelected">æ‰¹é‡åˆ é™¤</el-button>
```
- æ·»åŠ é¢˜ç›®é€‰æ‹©åŠŸèƒ½
- æ”¯æŒä¸€æ¬¡åˆ é™¤å¤šä¸ªé¢˜ç›®
- æ˜¾ç¤ºå°†è¦åˆ é™¤çš„é¢˜ç›®æ•°é‡

### 2. **å›æ”¶ç«™åŠŸèƒ½**
```python
def bank_soft_delete(qid: str):
    # æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè€Œä¸æ˜¯çœŸæ­£åˆ é™¤
    item["deleted"] = True
    item["deleted_at"] = now()
```
- è½¯åˆ é™¤ï¼Œä¿ç•™30å¤©
- æ”¯æŒæ¢å¤è¯¯åˆ çš„é¢˜ç›®
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

### 3. **åˆ é™¤æ—¥å¿—**
```python
def log_deletion(qid: str, user: str):
    # è®°å½•åˆ é™¤æ“ä½œ
    log = {
        "qid": qid,
        "user": user,
        "timestamp": now(),
        "question": question_data
    }
```
- è®°å½•è°åˆ é™¤äº†ä»€ä¹ˆ
- å®¡è®¡è¿½è¸ª
- æ•°æ®æ¢å¤ä¾æ®

### 4. **æƒé™æ§åˆ¶**
```python
@require_role("admin")
def bank_delete_api():
    # åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤
```
- é™åˆ¶åˆ é™¤æƒé™
- é˜²æ­¢è¯¯æ“ä½œ
- æå‡å®‰å…¨æ€§

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. âœ… åˆ é™¤å•ä¸ªé¢˜ç›®
2. âœ… å–æ¶ˆåˆ é™¤æ“ä½œ
3. âœ… åˆ é™¤ååˆ·æ–°åˆ—è¡¨
4. âœ… åˆ é™¤ä¸å­˜åœ¨çš„é¢˜ç›®
5. âœ… å¹¶å‘åˆ é™¤å¤šä¸ªé¢˜ç›®

### ç•Œé¢æµ‹è¯•
1. âœ… åˆ é™¤æŒ‰é’®æ˜¾ç¤ºæ­£ç¡®
2. âœ… LoadingçŠ¶æ€æ­£å¸¸
3. âœ… ç¡®è®¤å¯¹è¯æ¡†æ˜¾ç¤º
4. âœ… æˆåŠŸ/å¤±è´¥æ¶ˆæ¯æ˜¾ç¤º

### å®‰å…¨æµ‹è¯•
1. âœ… ç¡®è®¤å¯¹è¯æ¡†å¿…é¡»ç¡®è®¤
2. âœ… åç«¯éªŒè¯å‚æ•°
3. âœ… çº¿ç¨‹å®‰å…¨
4. âœ… æ•°æ®ä¸€è‡´æ€§

## æ€»ç»“

åˆ é™¤é¢˜ç›®åŠŸèƒ½çš„æ·»åŠ æå¤§åœ°æå‡äº†é¢˜åº“ç®¡ç†çš„ä¾¿åˆ©æ€§ï¼Œç”¨æˆ·ä¸å†éœ€è¦æ‰‹åŠ¨ç¼–è¾‘æœ¬åœ°æ–‡ä»¶æ¥åˆ é™¤é¢˜ç›®ã€‚é€šè¿‡å®Œå–„çš„ç¡®è®¤æœºåˆ¶å’Œé”™è¯¯å¤„ç†ï¼Œç¡®ä¿äº†æ“ä½œçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸ¯ **æ“ä½œç®€å•**ï¼šä¸€é”®åˆ é™¤ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶
- ğŸ”’ **å®‰å…¨å¯é **ï¼šç¡®è®¤æœºåˆ¶ + çº¿ç¨‹é” + åŸå­æ“ä½œ
- ğŸ’¡ **ç”¨æˆ·å‹å¥½**ï¼šå³æ—¶åé¦ˆ + æ¸…æ™°æç¤º
- ğŸš€ **æ€§èƒ½ä¼˜ç§€**ï¼šåŸå­æ“ä½œï¼Œä¸å½±å“å…¶ä»–é¢˜ç›®

è¿™æ˜¯ä¸€ä¸ª**å®ç”¨ã€å®‰å…¨ã€é«˜æ•ˆ**çš„åŠŸèƒ½ï¼
