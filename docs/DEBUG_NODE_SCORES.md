# Debug Node Scores

> 适用于排查“明明应该命中但没出现在 TopN”的场景，快速查看某个问题在检索与重排阶段的节点得分、来源与排名。

## 脚本位置

```
scripts/debug_node_scores.py
```

脚本会复用 `app.create_app()`，因此需要在与正式运行相同的环境中执行（包括 `.env` / 配置项 / 各类服务端依赖）。

## 基本用法

```bash
python scripts/debug_node_scores.py \
  --question "办理登机牌需要哪些资料？"
```

运行后将打印：

- **Retrieval** 段：混合检索（向量 + BM25）阶段的节点，按 RRF 得分排序；
- **Rerank** 段：重排序后的节点（若未加 `--skip-rerank`）；
- 每一行都包含
  - `score`: 当前阶段的得分；
  - `src`: `vector`、`keyword` 或 `vector/keyword`，代表贡献来源；
  - `ranks`: `vec#N` / `bm25#M` 表示在各自检索通道内的原始排名；
  - `preview`: 片段摘要，帮助快速确认文本内容。

## 常用参数

| 参数 | 说明 |
| --- | --- |
| `--question`* | 需要诊断的问题文本，必填。 |
| `--substring` | 只显示文本或文件名包含给定子串的节点（可用于定位特定片段）。 |
| `--node-id` | 按 `node_id` 精确匹配节点，常配合后台日志使用。 |
| `--limit` | 每个阶段最多展示多少条记录，默认 50。 |
| `--include-text` | 输出完整文本（默认只显示预览以减少日志）。 |
| `--skip-rerank` | 仅查看检索阶段的结果，跳过重排。 |

示例：排查包含“登机牌补办”字样但未进入前 10 的片段：

```bash
python scripts/debug_node_scores.py \
  --question "办理登机牌需要哪些资料？" \
  --substring "登机牌补办" \
  --limit 80
```

## 结果解读

- `src=vector` 代表仅由向量检索召回；`src=keyword` 代表仅由 BM25 召回；`src=vector/keyword` 则是双通道都命中。
- `ranks=vec#3,bm25#10` 表示该节点在向量通道排名第 3，在 BM25 通道排名第 10。
- 若 `Retrieval` 段已经存在目标片段，但在 `Rerank` 段中消失，说明被重排模型过滤；可考虑调高 `rerank_top_n` 或优化重排策略。
- 如果两段都没有，可怀疑：切分/索引缺失、检索参数过小、或是问题表达需要改写。

## 故障排查

| 现象 | 可能原因 & 解决办法 |
| --- | --- |
| 脚本报错 “无法初始化应用或未找到 KnowledgeHandler” | 确认已正确设置环境变量、依赖服务（Qdrant、LLM 等）均可用。 |
| 输出为空 | 问题文本无任何命中，可尝试 `--substring` 为空，仅用 `--limit` 查看整体得分分布，或检查知识库是否缺失该内容。 |
| 需要查看多库策略（免签/航司） | 当前脚本会沿用主应用配置，若启用了多库检索，返回结果会自动携带来自不同知识库的片段及其得分。 |

> 提示：脚本只读数据，不会修改索引或配置，可在生产等环境安全运行。

