# 导出报告404错误修复说明

## 问题描述

在 ExamView.vue 中点击"导出成绩报告（DOCX）"按钮时，出现404错误：

```
GET /mcq_public/mcq_public/student/download_report?filename=成绩报告_cb13a57f_1763739625.docx HTTP/1.1" 404 -

Not Found
The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.
```

虽然文件已经在本地生成，但无法下载。

## 问题原因

URL路径中出现了**重复的 `/mcq_public/`**，导致路径错误。

### 错误的URL路径
```
/mcq_public/mcq_public/student/download_report?filename=...
           ^^^^^^^^^^^^ 重复了！
```

### 正确的URL路径
```
/mcq_public/student/download_report?filename=...
```

## 根本原因分析

### 后端返回的URL
```python
# services/exam_service.py (修改前)
return {
    "ok": True,
    "path": filepath,
    "filename": filename,
    "download_url": f"/mcq_public/student/download_report?filename={filename}"
    #                  ^^^^^^^^^^^^ 包含了 blueprint 前缀
}
```

### 前端拼接URL
```javascript
// ExamView.vue
let downloadUrl = data.download_url
if (downloadUrl.startsWith('/')) {
  downloadUrl = `${MCQ_BASE_URL}${downloadUrl}`
  //             ^^^^^^^^^^^^^ MCQ_BASE_URL = '/mcq_public'
}
```

### 拼接结果
```
MCQ_BASE_URL + download_url
= '/mcq_public' + '/mcq_public/student/download_report?filename=...'
= '/mcq_public/mcq_public/student/download_report?filename=...'
  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ 重复了！
```

## 解决方案

修改后端返回的 `download_url`，使用**相对于 blueprint 的路径**，而不是绝对路径。

### 修改后的代码

```python
# services/exam_service.py (修改后)
return {
    "ok": True,
    "path": filepath,
    "filename": filename,
    "download_url": f"/student/download_report?filename={filename}"
    #                  ^^^^^^^ 移除了 /mcq_public 前缀
}
```

### 前端拼接结果
```
MCQ_BASE_URL + download_url
= '/mcq_public' + '/student/download_report?filename=...'
= '/mcq_public/student/download_report?filename=...'
  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ 正确！
```

## 技术细节

### Flask Blueprint 路由

在 Flask 中，blueprint 注册时会添加 URL 前缀：

```python
# app.py
from routes.mcq_public_routes import mcq_public_bp

app.register_blueprint(mcq_public_bp, url_prefix='/mcq_public')
#                                                  ^^^^^^^^^^^^ URL前缀
```

### Blueprint 内的路由

```python
# routes/mcq_public_routes.py
@mcq_public_bp.route("/student/download_report", methods=["GET"])
#                     ^^^^^^^^^^^^^^^^^^^^^^^^^ 相对于 blueprint 的路径
def student_download_report():
    # ...
```

### 完整的URL路径

```
url_prefix + route_path
= '/mcq_public' + '/student/download_report'
= '/mcq_public/student/download_report'
```

## 最佳实践

### 后端返回URL的原则

1. **相对路径优于绝对路径**
   - ✅ 返回：`/student/download_report?filename=...`
   - ❌ 返回：`/mcq_public/student/download_report?filename=...`

2. **让前端决定完整URL**
   - 后端只返回相对于 blueprint 的路径
   - 前端根据配置拼接完整URL

3. **避免硬编码前缀**
   - 不要在多个地方硬编码 `/mcq_public`
   - 如果需要修改前缀，只需在一个地方修改

### 前端处理URL的原则

1. **统一的URL拼接逻辑**
   ```javascript
   // 如果是相对路径，拼接 BASE_URL
   if (url.startsWith('/')) {
     url = `${MCQ_BASE_URL}${url}`
   }
   ```

2. **配置化的 BASE_URL**
   ```javascript
   // config/api/api.ts
   export const MCQ_BASE_URL = '/mcq_public'
   ```

3. **避免重复拼接**
   - 检查URL是否已经包含 BASE_URL
   - 或者统一使用相对路径

## 相关文件

### 修改的文件

1. **`services/exam_service.py`**
   - 函数：`student_export_report_docx()`
   - 修改：`download_url` 从 `/mcq_public/student/download_report` 改为 `/student/download_report`

### 未修改的文件

1. **`llm_fronted/ExamView.vue`**
   - 前端的URL拼接逻辑保持不变
   - 因为逻辑本身是正确的，只是后端返回的URL有问题

2. **`routes/mcq_public_routes.py`**
   - 路由定义保持不变
   - 路由路径本身就是相对于 blueprint 的

## 测试验证

### 测试步骤

1. **开始考试**
   - 登录学生账号
   - 选择试卷并开始考试

2. **完成并提交**
   - 答题
   - 提交答案

3. **导出报告**
   - 点击"导出成绩报告（DOCX）"按钮
   - 检查浏览器网络请求

4. **验证URL**
   - 正确的URL：`/mcq_public/student/download_report?filename=...`
   - 错误的URL：`/mcq_public/mcq_public/student/download_report?filename=...`

### 预期结果

- ✅ 文件成功下载
- ✅ 文件名正确（如：`成绩报告_cb13a57f_1763739625.docx`）
- ✅ 文件内容完整
- ✅ 无404错误

### 检查网络请求

在浏览器开发者工具的 Network 标签中，应该看到：

```
Request URL: http://localhost:5000/mcq_public/student/download_report?filename=成绩报告_cb13a57f_1763739625.docx
Status Code: 200 OK
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
```

## 其他可能的URL问题

### 问题1：CORS错误

如果出现CORS错误，检查后端的CORS配置：

```python
# app.py
from flask_cors import CORS

CORS(app, resources={
    r"/mcq_public/*": {
        "origins": "*",
        "methods": ["GET", "POST", "OPTIONS"],
        "allow_headers": ["Content-Type"]
    }
})
```

### 问题2：文件不存在

如果文件确实不存在，检查：

1. 文件生成逻辑是否正确
2. 文件路径是否正确（`./data/reports/`）
3. 文件权限是否正确

### 问题3：文件名编码问题

如果文件名包含中文，可能需要URL编码：

```python
from urllib.parse import quote

filename = "成绩报告_cb13a57f_1763739625.docx"
download_url = f"/student/download_report?filename={quote(filename)}"
```

但在这个项目中，文件名已经通过 `encodeURIComponent` 在前端编码了，所以后端不需要再次编码。

## 总结

✅ **问题**：URL路径中出现重复的 `/mcq_public/`  
✅ **原因**：后端返回的URL包含了 blueprint 前缀，前端又拼接了一次  
✅ **解决**：修改后端返回相对路径，移除 `/mcq_public` 前缀  
✅ **结果**：文件可以正常下载  

这个问题提醒我们：
- 后端应该返回相对路径，让前端决定完整URL
- 避免在多个地方硬编码URL前缀
- 统一的URL拼接逻辑很重要
