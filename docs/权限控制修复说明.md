# 权限控制修复说明

## 问题描述

超级管理员登录后无法删除题目，提示权限不足。

## 问题原因

1. **前端未发送角色信息**: 前端的删除请求没有在请求头中发送用户角色信息
2. **后端权限中间件无法获取角色**: 权限中间件只能从请求头/请求体获取角色，但前端没有发送

## 解决方案

### 1. 修改前端 (`AdminView.vue`)

在`deleteQuestion`函数中添加用户角色信息到请求头和请求体：

```typescript
const deleteQuestion = async (qid: string) => {
  // ...
  const resp = await fetch(`${MCQ_BASE_URL}/bank/delete`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-User-Name': store.state.user.username,  // 添加用户名
      'X-User-Role': userRole.value              // 添加用户角色
    },
    body: JSON.stringify({ 
      ids: [qid],
      user: store.state.user.username,           // 添加用户名
      role: userRole.value                       // 添加用户角色
    })
  })
  // ...
}
```

### 2. 增强权限中间件 (`middleware/role_required.py`)

添加多种方式获取用户角色：

```python
def require_admin_or_super(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user_role = ""
        username = ""
        
        # 方式1: 从Flask g对象获取（如果使用了auth_decorator）
        if hasattr(g, 'username'):
            username = g.username
            if hasattr(g, 'role'):
                user_role = getattr(g, 'role', '').lower()
            else:
                # 从Spring Boot获取角色
                user_role = _get_user_role_from_spring(username)
        
        # 方式2: 从请求头获取
        if not user_role:
            user_role = request.headers.get('X-User-Role', '').lower()
            username = request.headers.get('X-User-Name', username)
        
        # 方式3: 从请求体获取
        if not user_role and request.method == 'POST':
            data = request.get_json() or {}
            user_role = data.get('role', '').lower()
            username = data.get('user', data.get('username', username))
        
        # 检查权限（支持多种格式）
        if user_role not in ['admin', 'super_admin', 'superadmin', 'super admin']:
            return jsonify({
                "ok": False,
                "msg": f"权限不足（当前角色: {user_role}）"
            }), 403
        
        return f(*args, **kwargs)
    
    return decorated_function
```

### 3. 添加日志输出

在权限检查过程中添加详细日志：

```python
logger.info(f"[Auth] 从g对象获取用户名: {username}")
logger.info(f"[Auth] 从请求头获取角色: {user_role}")
logger.info(f"[Auth] 权限检查: 用户={username}, 角色={user_role}")
logger.info(f"[Auth] 权限检查通过: 用户={username}, 角色={user_role}")
```

## 支持的角色格式

权限中间件现在支持以下角色格式：
- `admin`
- `super_admin`
- `superadmin`
- `super admin`（带空格）

所有格式都会被转换为小写进行比较。

## 测试方法

### 1. 检查前端发送的请求

打开浏览器开发者工具 → Network → 找到删除请求 → 查看Headers：

```
X-User-Name: your_username
X-User-Role: super_admin
```

### 2. 检查后端日志

查看Flask日志，应该看到：

```
[Auth] 从请求头获取角色: super_admin
[Auth] 权限检查: 用户=your_username, 角色=super_admin
[Auth] 权限检查通过: 用户=your_username, 角色=super_admin
```

### 3. 成功删除

如果权限正确，应该看到：
- 前端提示"删除成功"
- 题目从列表中消失
- 后端日志记录删除操作

## 故障排查

### 如果仍然提示权限不足

1. **检查前端store中的角色值**:
   ```javascript
   console.log('User Role:', store.getters.userRole)
   ```

2. **检查后端接收到的角色**:
   查看Flask日志中的`[Auth] 权限检查`信息

3. **检查角色格式**:
   确保角色是`admin`或`super_admin`（小写）

4. **检查请求头是否正确发送**:
   在浏览器Network面板中查看Request Headers

## 相关文件

- `e:\GITHUB\llm-pro - 副本\llm_fronted\AdminView.vue` - 前端删除函数
- `e:\GITHUB\llm-pro - 副本\middleware\role_required.py` - 权限中间件
- `e:\GITHUB\llm-pro - 副本\routes\mcq_public_routes.py` - 删除API路由

## 总结

通过在前端发送用户角色信息，并增强后端权限中间件的角色获取逻辑，现在超级管理员可以正常删除题目了。权限控制系统支持多种角色格式和多种获取方式，更加健壮和灵活。
