# 子问题分解 LLM 判断开关使用指南

## 功能说明

新增 `SUBQUESTION_USE_LLM_JUDGE` 配置项，控制是否使用 LLM 判断问题是否需要分解。

---

## 配置项

### SUBQUESTION_USE_LLM_JUDGE

**位置**：`.env` 文件

**可选值**：
- `true`：智能判断模式（默认）
- `false`：强制分解模式

---

## 两种模式对比

### 模式1：智能判断模式（推荐）

```bash
SUBQUESTION_USE_LLM_JUDGE=true
```

**工作流程**：
1. 检查查询长度和实体数（`should_decompose()`）
2. ✅ 通过基础检查
3. **调用 LLM 判断**是否需要分解
4. LLM 返回：`{"need_decompose": true/false, "sub_questions": [...]}`
5. 根据 LLM 判断决定是否分解

**特点**：
- ✅ LLM 智能判断，避免不必要的分解
- ✅ 单一场景问题不会被分解
- ✅ 节省计算资源
- ❌ 多一次 LLM 调用（~0.5-1s）

**适用场景**：
- 生产环境
- 需要精准控制分解
- 对延迟不敏感

**示例**：

| 问题 | LLM判断 | 是否分解 |
|------|---------|----------|
| "中国护照去哪些国家免签？" | 不需要 | ❌ |
| "中国护照去哪些国家免签，停留时间是多久？" | 需要 | ✅ |
| "某旅客持南非护照入境时触发报警..." | 不需要 | ❌ |

---

### 模式2：强制分解模式

```bash
SUBQUESTION_USE_LLM_JUDGE=false
```

**工作流程**：
1. 检查查询长度和实体数（`should_decompose()`）
2. ✅ 通过基础检查
3. **跳过 LLM 判断**
4. **直接调用 LLM 生成子问题**
5. 强制分解为 2-3 个子问题

**特点**：
- ✅ 所有问题都会分解
- ✅ 减少一次 LLM 调用
- ✅ 延迟更低（~0.5s）
- ❌ 可能过度分解简单问题
- ❌ 浪费计算资源

**适用场景**：
- 测试环境
- 需要强制分解所有问题
- 对延迟敏感

**示例**：

| 问题 | 是否分解 | 子问题 |
|------|----------|--------|
| "中国护照去哪些国家免签？" | ✅ | 1. 哪些国家免签？<br>2. 免签条件是什么？<br>3. 注意事项有哪些？ |
| "去泰国免签吗？" | ✅ | 1. 泰国是否免签？<br>2. 停留时间多久？<br>3. 入境要求是什么？ |

---

## 使用建议

### 推荐配置（生产环境）

```bash
# 启用子问题分解
ENABLE_SUBQUESTION_DECOMPOSITION=true

# 使用自定义引擎
SUBQUESTION_ENGINE_TYPE=custom

# 智能判断模式（推荐）
SUBQUESTION_USE_LLM_JUDGE=true

# 降低长度阈值，让更多问题进入判断
SUBQUESTION_COMPLEXITY_THRESHOLD=30

# 关闭实体检测，简化判断逻辑
SUBQUESTION_ENABLE_ENTITY_CHECK=false
```

**效果**：
- 长度 ≥ 30 字符的问题进入 LLM 判断
- LLM 智能决定是否分解
- 避免过度分解

---

### 测试配置（强制分解）

```bash
# 启用子问题分解
ENABLE_SUBQUESTION_DECOMPOSITION=true

# 使用自定义引擎
SUBQUESTION_ENGINE_TYPE=custom

# 强制分解模式
SUBQUESTION_USE_LLM_JUDGE=false

# 降低长度阈值
SUBQUESTION_COMPLEXITY_THRESHOLD=20

# 关闭实体检测
SUBQUESTION_ENABLE_ENTITY_CHECK=false
```

**效果**：
- 长度 ≥ 20 字符的问题都会分解
- 跳过 LLM 判断，直接生成子问题
- 适合测试分解功能

---

## 日志示例

### 智能判断模式

```
[子问题分解] 智能判断模式 | 查询: 中国护照去哪些国家免签，停留时间是多久？
[子问题分解] 使用LLM: qwen3-32b
[子问题分解] LLM响应完成 | 耗时: 0.68s
[子问题分解] 分解成功 | 子问题数: 2 | 子问题: ['中国护照去哪些国家免签？', '各国免签停留时间是多久？']
```

### 强制分解模式

```
[子问题分解] 强制分解模式 | 查询: 中国护照去哪些国家免签？
[子问题分解] 强制分解成功 | 子问题数: 3 | 子问题: ['哪些国家对中国护照免签？', '免签国家的停留时间是多久？', '免签入境需要什么条件？']
```

---

## 提示词差异

### 智能判断模式提示词

**系统提示词**：
```
你是一名专业的问题分析助手，擅长将复杂问题分解为多个简单的子问题。
你的任务是分析用户的查询，判断是否需要分解，如果需要则生成2-3个独立的子问题。

输出格式：
{"need_decompose": true/false, "sub_questions": ["子问题1", "子问题2"]}
```

**用户提示词**：
```
请分析以下查询是否需要分解为子问题：

中国护照去哪些国家免签，停留时间是多久？

请按照要求的JSON格式输出分析结果。
```

---

### 强制分解模式提示词

**系统提示词**：
```
你是一名专业的问题分析助手，擅长将问题分解为多个简单的子问题。
你的任务是将用户的查询分解为2-3个独立的子问题。

输出格式：
{"sub_questions": ["子问题1", "子问题2", "子问题3"]}
```

**用户提示词**：
```
请将以下查询分解为2-3个子问题：

中国护照去哪些国家免签？

请按照要求的JSON格式输出子问题列表。
```

**关键差异**：
- 智能模式：需要判断 + 可能分解
- 强制模式：直接分解，不判断

---

## 性能对比

| 指标 | 智能判断模式 | 强制分解模式 |
|------|-------------|-------------|
| LLM调用次数 | 2次（判断+生成） | 1次（生成） |
| 平均延迟 | ~1.5s | ~0.8s |
| 分解准确性 | 高 | 中 |
| 资源消耗 | 中 | 低 |
| 过度分解风险 | 低 | 高 |

---

## 切换方法

### 方法1：修改 .env 文件

```bash
# 编辑 .env
vim .env

# 修改配置
SUBQUESTION_USE_LLM_JUDGE=false  # 改为 false

# 重启应用
python app.py
```

### 方法2：环境变量

```bash
# 临时设置
export SUBQUESTION_USE_LLM_JUDGE=false

# 启动应用
python app.py
```

### 方法3：运行时设置

```bash
# 一行命令
SUBQUESTION_USE_LLM_JUDGE=false python app.py
```

---

## 验证方法

### 1. 查看启动日志

```
子问题分解器初始化完成 | 状态: 启用 | 引擎: 自定义流程
```

### 2. 查看分解日志

**智能模式**：
```
[子问题分解] 智能判断模式 | 查询: ...
```

**强制模式**：
```
[子问题分解] 强制分解模式 | 查询: ...
```

### 3. 测试请求

```bash
curl -X POST http://localhost:5000/api/knowledge \
  -H "Content-Type: application/json" \
  -d '{
    "question": "中国护照去哪些国家免签？",
    "enable_thinking": false
  }'
```

观察日志中的分解行为。

---

## 常见问题

### Q1: 强制分解模式下，简单问题也会分解吗？

**A**: 是的。只要通过基础检查（长度 ≥ 阈值），就会强制分解。

**解决方案**：
- 提高 `SUBQUESTION_COMPLEXITY_THRESHOLD`
- 或使用智能判断模式

---

### Q2: 智能判断模式下，为什么有些问题不分解？

**A**: LLM 判断该问题不需要分解（单一场景、已经足够简单等）。

**解决方案**：
- 切换到强制分解模式
- 或调整提示词，让 LLM 更倾向于分解

---

### Q3: 两种模式可以动态切换吗？

**A**: 需要重启应用。配置在启动时加载。

---

### Q4: 哪种模式更好？

**A**: 取决于场景：
- **生产环境**：智能判断模式（精准控制）
- **测试环境**：强制分解模式（快速验证）
- **演示环境**：强制分解模式（展示效果）

---

## 相关文档

- [子问题分解使用指南](./SUBQUESTION_DECOMPOSITION_GUIDE.md)
- [环境变量配置指南](./ENV_CONFIGURATION_GUIDE.md)
- [生产环境部署指南](./PRODUCTION_DEPLOYMENT.md)

---

## 更新日志

- 2025-01-XX: 新增 `SUBQUESTION_USE_LLM_JUDGE` 配置项
- 2025-01-XX: 添加强制分解模式
- 2025-01-XX: 优化提示词和日志
