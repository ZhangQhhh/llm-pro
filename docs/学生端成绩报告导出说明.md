# 学生端成绩报告导出功能说明

## 概述

学生端（ExamView.vue）的"导出成绩报告（DOCX）"功能用于导出单个学生的考试成绩报告。该报告与管理端"导出ZIP"功能中生成的单个DOCX文件格式完全一致。

## 功能流程

### 1. 学生端导出流程

```
学生完成考试 → 提交答案 → 查看成绩 → 点击"导出成绩报告（DOCX）" → 下载个人报告
```

### 2. 管理端批量导出流程

```
管理员选择试卷 → 点击"导出ZIP" → 下载包含所有学生报告的ZIP文件
```

## API 接口

### 学生端导出接口

**接口地址**: `POST /mcq_public/student/export_my_report_docx`

**请求参数**:
- `attempt_id` (string, required): 考试会话ID

**请求方式**: FormData

**返回格式**:
```json
{
  "ok": true,
  "path": "./data/reports/成绩报告_abc12345_1234567890.docx",
  "filename": "成绩报告_abc12345_1234567890.docx",
  "download_url": "/mcq_public/student/download_report?filename=成绩报告_abc12345_1234567890.docx"
}
```

### 下载接口

**接口地址**: `GET /mcq_public/student/download_report`

**请求参数**:
- `filename` (string, required): 文件名

**返回**: DOCX文件流

## 报告内容

每个学生的成绩报告包含以下内容：

### 1. 基本信息
- 学生ID
- 试卷名称
- 开始时间
- 结束时间
- 总分

### 2. 答题详情
对于每道题目：
- 题目序号和题干
- 所有选项
- 标准答案
- 学生答案
- 判定结果（正确/错误）
- 解析（如果有）

## 前端实现

### ExamView.vue 中的实现

```javascript
const exportReport = async () => {
  if (!attemptId.value) {
    ElMessage.warning('缺少会话信息')
    return
  }
  exporting.value = true
  exportMessage.value = '导出中…'
  try {
    // 第一步：调用导出接口生成报告
    const formData = new FormData()
    formData.append('attempt_id', attemptId.value)
    
    const data = await mcqFetch(API_ENDPOINTS.STUDENT.EXPORT_MY_REPORT_DOCX, {
      method: 'POST',
      body: formData
    })

    if (!data.ok) {
      throw new Error(data.detail || '导出失败')
    }

    // 第二步：使用返回的 download_url 下载文件
    if (data.download_url) {
      let downloadUrl = data.download_url
      if (downloadUrl.startsWith('/')) {
        downloadUrl = `${MCQ_BASE_URL}${downloadUrl}`
      }
      
      const link = document.createElement('a')
      link.href = downloadUrl
      link.download = data.filename || '成绩报告.docx'
      link.target = '_blank'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)

      exportMessage.value = '已导出'
      setTimeout(() => { exportMessage.value = '' }, 2000)
      ElMessage.success('导出成功')
    } else {
      throw new Error('未获取到下载链接')
    }
  } catch (error: any) {
    exportMessage.value = '导出失败'
    ElMessage.error('导出失败：' + (error.message || '未知错误'))
    console.error('导出报告错误：', error)
  } finally {
    exporting.value = false
  }
}
```

## 后端实现

### services/exam_service.py

```python
def student_export_report_docx(attempt_id: str) -> Dict[str, Any]:
    """
    导出学生成绩报告（DOCX）
    """
    try:
        import docx
    except Exception as e:
        raise RuntimeError("未安装 python-docx，请先安装：pip install python-docx") from e
    
    try:
        # 1. 查找考试会话
        with _ATTEMPTS_LOCK:
            data = _load_attempts()
            attempts = data.get("attempts", [])
            
            attempt = None
            for a in attempts:
                if a.get("attempt_id") == attempt_id:
                    attempt = a
                    break
            
            if not attempt:
                return {"ok": False, "detail": "考试会话不存在"}
            
            if attempt.get("status") != "completed":
                return {"ok": False, "detail": "考试尚未提交"}
        
        # 2. 生成 DOCX 文档
        doc = docx.Document()
        doc.add_heading("考试成绩报告", level=1)
        
        # 添加基本信息
        doc.add_paragraph(f"学生ID: {attempt.get('student_id', 'anonymous')}")
        doc.add_paragraph(f"试卷: {attempt.get('paper_id', '')}")
        doc.add_paragraph(f"开始时间: {attempt.get('start_time', '')}")
        doc.add_paragraph(f"结束时间: {attempt.get('end_time', '')}")
        doc.add_paragraph(f"总分: {attempt.get('total_score', 0):.2f}")
        doc.add_paragraph("")
        
        # 添加答题详情
        answer_map = {ans["qid"]: ans["chosen_labels"] for ans in attempt.get("answers", [])}
        doc.add_heading("答题详情", level=2)
        questions = attempt.get("questions", [])
        
        for i, q in enumerate(questions, 1):
            qid = q["qid"]
            std_answer = q.get("answer", "")
            my_labels = answer_map.get(qid, [])
            _, is_correct = _calculate_score(q, my_labels)
            
            doc.add_paragraph(f"{i}. {q['stem']}")
            
            for opt in q["options"]:
                doc.add_paragraph(f"  {opt['label']}. {opt['text']}")
            
            doc.add_paragraph(f"标准答案: {std_answer}")
            doc.add_paragraph(f"我的答案: {''.join(my_labels) if my_labels else '(未作答)'}")
            doc.add_paragraph(f"判定: {'正确' if is_correct else '错误'}")
            
            analysis = q.get("explain_original", "")
            if analysis:
                doc.add_paragraph(f"解析: {analysis}")
            
            doc.add_paragraph("")
        
        # 3. 保存文件
        _ensure_dir("./data/reports")
        filename = f"成绩报告_{attempt_id[:8]}_{int(time.time())}.docx"
        filepath = os.path.join("./data/reports", filename)
        doc.save(filepath)
        
        # 4. 返回结果
        return {
            "ok": True,
            "path": filepath,
            "filename": filename,
            "download_url": f"/mcq_public/student/download_report?filename={filename}"
        }
    except Exception as e:
        logger.error(f"[Exam] 导出报告失败: {e}", exc_info=True)
        return {"ok": False, "detail": str(e)}
```

## 与管理端导出的关系

### 相同点
1. **报告格式完全一致**: 学生端导出的单个报告与管理端ZIP中的单个报告格式相同
2. **内容结构相同**: 都包含基本信息和答题详情
3. **使用相同的生成逻辑**: 都使用 `_calculate_score` 函数计算得分

### 不同点
1. **导出范围**:
   - 学生端: 导出单个学生的报告
   - 管理端ZIP: 导出所有学生的报告并打包
   - 管理端DOCX: 导出成绩汇总表

2. **触发方式**:
   - 学生端: 学生自己导出
   - 管理端: 教师/管理员批量导出

3. **文件存储位置**:
   - 学生端: `./data/reports/`
   - 管理端ZIP临时文件: `./data/reports_temp/` (导出后自动清理)
   - 管理端ZIP最终文件: `./data/reports_zip/`

## 使用场景

### 学生端使用场景
1. 学生完成考试后查看成绩
2. 学生需要保存自己的成绩报告
3. 学生需要查看详细的答题解析

### 管理端使用场景
1. 教师需要批量导出所有学生的成绩报告
2. 教师需要查看班级整体成绩情况
3. 教师需要存档所有学生的考试记录

## 文件命名规则

### 学生端单个报告
```
成绩报告_{attempt_id前8位}_{时间戳}.docx
```
示例: `成绩报告_abc12345_1700000000.docx`

### 管理端ZIP中的报告
```
成绩报告_{student_id}_{attempt_id前8位}.docx
```
示例: `成绩报告_student001_abc12345.docx`

### 管理端ZIP文件
```
{试卷名称}_成绩报告_{时间戳}.zip
```
示例: `期末考试_成绩报告_1700000000.zip`

## 注意事项

1. **权限控制**: 学生只能导出自己的成绩报告，不能访问其他学生的报告
2. **状态检查**: 只有已完成的考试才能导出报告
3. **文件清理**: 建议定期清理 `./data/reports/` 目录中的旧文件
4. **并发处理**: 使用锁机制保护考试记录的读取，避免并发问题

## 错误处理

### 常见错误及处理

1. **考试会话不存在**
   - 错误信息: "考试会话不存在"
   - 原因: attempt_id 无效或已被删除
   - 解决: 检查 attempt_id 是否正确

2. **考试尚未提交**
   - 错误信息: "考试尚未提交"
   - 原因: 考试还在进行中
   - 解决: 先提交考试答案

3. **文件生成失败**
   - 错误信息: 具体的异常信息
   - 原因: 磁盘空间不足、权限问题等
   - 解决: 检查服务器磁盘空间和文件权限

## 测试建议

### 功能测试
1. 测试正常导出流程
2. 测试未提交考试时的错误提示
3. 测试无效 attempt_id 的错误处理
4. 测试文件下载是否正常

### 性能测试
1. 测试大量题目（50+）的报告生成速度
2. 测试并发导出请求的处理

### 兼容性测试
1. 测试不同浏览器的文件下载
2. 测试生成的DOCX文件在不同Office版本中的兼容性

## 未来优化方向

1. **自定义模板**: 支持自定义报告模板样式
2. **PDF导出**: 增加PDF格式的报告导出
3. **邮件发送**: 支持将报告直接发送到学生邮箱
4. **报告预览**: 在导出前支持在线预览报告内容
5. **历史记录**: 记录学生的所有导出历史
