# 混合检索权重调优指南

## 🎯 问题背景

修复 BM25 后，系统从"只有向量检索"变成了"向量 + BM25 混合检索"，导致检索结果排序发生变化，部分题目答案不准确。

## 📊 当前检索流程

```
用户查询
    ↓
┌─────────────────────────────────┐
│  1. 向量检索 (语义相似度)       │
│     - 检索 30 条                │
│     - 基于 Embedding 相似度     │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  2. BM25 检索 (关键词匹配)      │
│     - 检索 30 条                │
│     - 基于 TF-IDF + jieba 分词  │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  3. RRF 融合 (加权融合)         │
│     - 向量权重: 0.7             │
│     - BM25 权重: 0.3            │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  4. Reranker 重排序             │
│     - 取 Top 20                 │
└─────────────────────────────────┘
    ↓
   LLM 生成答案
```

## ⚙️ 权重配置

在 `config/settings.py` 中：

```python
# RRF 融合权重配置
RRF_K = 60.0              # RRF 平滑参数（通常不需要改）
RRF_VECTOR_WEIGHT = 0.7   # 向量检索权重（0-1）
RRF_BM25_WEIGHT = 0.3     # BM25 检索权重（0-1）
```

## 🔧 调优策略

### 场景 1：语义理解更重要（当前默认）

**适用**：问题需要理解上下文、同义词、语义关系

```python
RRF_VECTOR_WEIGHT = 0.7   # 向量检索占主导
RRF_BM25_WEIGHT = 0.3     # BM25 辅助
```

**示例问题**：
- "中国公民去泰国需要签证吗？"（"需要签证"和"免签"是语义相关）
- "护照有效期不足6个月怎么办？"（需要理解"有效期"和"剩余时间"的关系）

### 场景 2：关键词匹配更重要

**适用**：问题包含专业术语、特定名称、精确匹配

```python
RRF_VECTOR_WEIGHT = 0.3   # 向量检索辅助
RRF_BM25_WEIGHT = 0.7     # BM25 占主导
```

**示例问题**：
- "什么是APEC商务旅行卡？"（"APEC商务旅行卡"是精确术语）
- "144小时过境免签政策"（"144小时"是精确数字）

### 场景 3：平衡模式

**适用**：混合场景，或不确定哪种更好

```python
RRF_VECTOR_WEIGHT = 0.5   # 向量和 BM25 权重相等
RRF_BM25_WEIGHT = 0.5
```

### 场景 4：只用向量检索（回退到修复前）

**适用**：BM25 导致结果变差，想临时禁用

```python
RRF_VECTOR_WEIGHT = 1.0   # 完全依赖向量检索
RRF_BM25_WEIGHT = 0.0     # 禁用 BM25
```

## 📈 RRF 融合公式

```python
final_score = vector_weight * (1 / (60 + vector_rank)) + 
              bm25_weight * (1 / (60 + bm25_rank))
```

**说明**：
- `vector_rank`: 节点在向量检索结果中的排名（1, 2, 3, ...）
- `bm25_rank`: 节点在 BM25 检索结果中的排名（1, 2, 3, ...）
- 排名越靠前，分数越高
- 权重控制两种检索方式的相对重要性

## 🧪 测试和验证

### 1. 修改配置

编辑 `config/settings.py`：

```python
RRF_VECTOR_WEIGHT = 0.8  # 调整为你想要的值
RRF_BM25_WEIGHT = 0.2
```

### 2. 重启服务

```bash
pkill -f app.py
cd /opt/rag_final_project/code_here/llm_pro
nohup python app.py > app.log 2>&1 &
```

### 3. 测试问题

用之前"做不对"的题目测试，观察结果是否改善。

### 4. 查看检索详情

在日志中可以看到每个节点的：
- `vector_score`: 向量检索原始分数
- `bm25_score`: BM25 检索原始分数
- `vector_rank`: 向量检索排名
- `bm25_rank`: BM25 检索排名
- `initial_score`: RRF 融合后的分数

## 📊 推荐配置

### 通用知识库（默认）
```python
RRF_VECTOR_WEIGHT = 0.7
RRF_BM25_WEIGHT = 0.3
```

### 免签知识库（关键词重要）
```python
RRF_VECTOR_WEIGHT = 0.5
RRF_BM25_WEIGHT = 0.5
```
原因：免签政策包含很多国家名称、时间期限等精确信息

### 航司知识库（关键词重要）
```python
RRF_VECTOR_WEIGHT = 0.4
RRF_BM25_WEIGHT = 0.6
```
原因：航司协议包含很多航空公司名称、协议名称等专有名词

## ⚠️ 注意事项

1. **权重之和不一定要等于 1**
   - 可以设置 `0.8 + 0.5 = 1.3`
   - 但通常保持和为 1 更容易理解

2. **不要设置为 0 + 0**
   - 至少一个权重要大于 0

3. **修改后需要重启服务**
   - 配置在服务启动时加载

4. **观察 Reranker 的影响**
   - RRF 融合后还会经过 Reranker 重排序
   - 最终结果是 Reranker 的输出

## 🔍 诊断工具

### 查看检索详情

```bash
cd /opt/rag_final_project/code_here/llm_pro
python debug_retrieval.py
```

会显示：
- 向量检索结果
- BM25 检索结果
- RRF 融合结果
- 每个节点的分数和排名

## 💡 优化建议

1. **先用默认配置测试**
   - `0.7 / 0.3` 是经验值

2. **根据错误类型调整**
   - 如果语义理解错误 → 增加向量权重
   - 如果关键词匹配错误 → 增加 BM25 权重

3. **A/B 测试**
   - 准备一组测试问题
   - 对比不同权重配置的准确率

4. **考虑分库配置**
   - 不同知识库可能需要不同权重
   - 目前所有库使用相同权重（可扩展）

## 📝 变更日志

- **2025-11-12**: 添加加权 RRF 融合，支持调整向量和 BM25 权重
- **2025-11-12**: 修复 BM25 存储问题，启用真正的混合检索
