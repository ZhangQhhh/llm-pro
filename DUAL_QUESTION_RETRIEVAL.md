# 双问题检索和独立重排序功能

## 功能概述

当用户问题被判定为免签或航司相关问题时，系统会自动：
1. **问题改写**：使用 LLM 将原问题改写为更适合检索免签/航司知识库的表述
2. **双问题检索**：
   - 用**改写后的问题**检索免签库和航司库
   - 用**原始问题**检索通用库
3. **独立重排序**：
   - 专业库（免签/航司）用改写问题重排序，取前10条
   - 通用库用原问题重排序，取前10条
4. **结果合并**：专业库10条 + 通用库10条 = 总计20条返回给LLM

## 工作流程

```
用户问题
    ↓
意图分类 (IntentClassifier.classify_and_rewrite)
    ↓
├─ 免签/航司相关？
│  ├─ 是 → 问题改写
│  │      ↓
│  │   双问题检索 (MultiKBRetriever.retrieve_with_dual_questions)
│  │      ├─ 改写问题 → 检索免签/航司库
│  │      └─ 原问题 → 检索通用库
│  │      ↓
│  │   独立重排序 (_dual_question_retrieve_and_rerank)
│  │      ├─ 专业库用改写问题重排序 → 取10条
│  │      └─ 通用库用原问题重排序 → 取10条
│  │      ↓
│  │   合并结果（20条）
│  │
│  └─ 否 → 单问题检索（原有逻辑）
│         ↓
│      按策略检索 → 重排序 → 返回
```

## 核心代码位置

### 1. 问题改写
- **文件**: `core/intent_classifier.py`
- **方法**: `IntentClassifier.rewrite_question()`
- **提示词**: `prompts.change_questions()`

### 2. 双问题检索
- **文件**: `core/multi_kb_retriever.py`
- **方法**: `MultiKBRetriever.retrieve_with_dual_questions()`
- **返回**: `(专业库节点列表, 通用库节点列表)`

### 3. 独立重排序
- **文件**: `api/knowledge_handler.py`
- **方法**: `KnowledgeHandler._dual_question_retrieve_and_rerank()`
- **逻辑**: 
  - 专业库用 `rewritten_question` 重排序
  - 通用库用 `original_question` 重排序
  - 各取10条后合并

## 触发条件

该功能会在以下情况自动触发：
1. **意图分类器已启用** (`ENABLE_INTENT_CLASSIFIER=true`)
2. **意图分类结果**为以下之一：
   - `visa_free` - 免签相关
   - `airline_visa_free` - 航司+免签相关
   - `both` - 混合问题
3. **问题改写成功**（LLM 返回了改写后的问题）

## 配置参数

### 必需配置
```python
# config/settings.py
ENABLE_INTENT_CLASSIFIER = True  # 必须启用意图分类器
```

### 相关配置
```python
INTENT_CLASSIFIER_TIMEOUT = 5  # 意图分类超时时间（秒）
INTENT_CLASSIFIER_LLM_ID = "qwen3-32b"  # 用于意图分类和改写的LLM

RERANK_TOP_N = 20  # 重排序后返回的文档数量（建议20，支持双库各10条）
```

## 日志示例

```
[智能路由] 意图分类结果: airline_visa_free
[智能路由] 问题已改写: 中国与塞尔维亚之间是否有针对机组人员的免签或签证互免协议？...
[智能路由] 使用双问题检索和独立重排序

[双问题检索] 策略: airline_visa_free
[双问题检索] 原问题: 关于塞尔维亚的机组人员入出境，下列说法正确的有...
[双问题检索] 改写问题: 中国与塞尔维亚之间是否有针对机组人员的免签或签证互免协议？...
[双问题检索] 通用库（原问题）返回 35 条
[双问题检索] 航司库（改写问题）返回 30 条
[双问题检索] 免签库（改写问题）返回 45 条
[双问题检索] 专业库合并: 航司30条 + 免签45条 = 去重后60条

[独立重排序] 检索完成 | 专业库: 60条 | 通用库: 35条
[独立重排序] 专业库重排序完成 | 保留 20 条
[独立重排序] 专业库Top5得分: ['0.9595', '0.9575', '0.9335', '0.9274', '0.7748']
[独立重排序] 通用库重排序完成 | 保留 15 条
[独立重排序] 通用库Top5得分: ['0.8234', '0.7987', '0.7654', '0.7432', '0.7123']
[独立重排序] 最终合并 | 专业库: 10条 + 通用库: 10条 = 总计: 20条
```

## 优势

1. **精准检索**：改写后的问题更符合专业库的表述方式，提高检索准确性
2. **独立评分**：两个库使用不同问题重排序，避免评分偏差
3. **信息丰富**：同时返回专业库和通用库的内容，覆盖面更广
4. **无侵入性**：不影响其他检索策略，只在特定条件下触发
5. **自动降级**：任何环节失败都会回退到原有逻辑

## 注意事项

1. **性能开销**：
   - 需要额外调用 LLM 进行问题改写
   - 需要对两个库分别进行重排序
   - 建议在生产环境监控响应时间

2. **返回数量**：
   - 默认返回20条（专业库10 + 通用库10）
   - 可通过 `rerank_top_n` 参数调整每个库的数量

3. **兼容性**：
   - 完全向后兼容，不影响现有功能
   - 未启用意图分类器时，使用原有逻辑
   - 问题改写失败时，自动降级为单问题检索

## 测试建议

### 测试用例1：塞尔维亚机组人员
```
问题：关于塞尔维亚的机组人员入出境，下列说法正确的有
预期：应该检索到塞尔维亚相关的免签协议和机组人员规定
```

### 测试用例2：普通免签问题
```
问题：中国公民去泰国需要签证吗？
预期：应该检索到中泰免签协议
```

### 测试用例3：非免签问题
```
问题：边检证件过期后流程是什么？
预期：使用单问题检索，不触发改写
```

## 相关文档

- `INTENT_CLASSIFIER_README.md` - 意图分类器详细说明
- `MULTI_KB_RETRIEVAL_STRATEGY.md` - 多库检索策略
- `prompts.py` - 问题改写提示词模板
