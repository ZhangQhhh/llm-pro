<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¤šè½®çŸ¥è¯†å¯¹è¯ï¼ˆå®Œæ•´ç‰ˆ Â· å®½å± Â· å¯æŠ˜å å‚è€ƒä¸æ€è€ƒåˆ†åŒºï¼‰</title>
<style>
/* ----------------- å­—ä½“ï¼ˆè¯·æŒ‰å†…ç½‘å®é™…è·¯å¾„æ›¿æ¢ï¼‰ ----------------- */
@font-face {
  font-family: "Noto Sans SC";
  font-weight: 400;
  src: url('/static/fonts/SourceHanSansSC-Regular.otf') format('opentype');
}
@font-face {
  font-family: "Noto Sans SC";
  font-weight: 600;
  src: url('/static/fonts/SourceHanSansSC-Medium.otf') format('opentype');
}
@font-face {
  font-family: "Noto Serif SC";
  font-weight: 700;
  src: url('/static/fonts/SourceHanSerifCN-Bold.otf') format('opentype');
}

/* ----------------- ä¸»é¢˜å˜é‡ ----------------- */
:root{
  --accentA: #7c3aed;
  --accentB: #06b6d4;
  --muted: #64748b;
  --bg: #f7fbff;
  --card: #ffffff;
}

/* ----------------- å…¨å±€ ----------------- */
html,body{height:100%;margin:0;font-family:"Noto Sans SC",system-ui,"Segoe UI",Roboto,"Microsoft YaHei",sans-serif;background:linear-gradient(180deg,var(--bg),#eef3ff);color:#0f172a;}
.wrap{max-width:1400px;margin:18px auto;padding:18px;box-sizing:border-box;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.brand{display:flex;gap:12px;align-items:center;}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-family:"Noto Serif SC",serif;font-size:20px;}
h1{margin:0;font-family:"Noto Serif SC",serif;font-size:20px;}
.subtitle{font-size:13px;color:var(--muted);margin-top:4px;}
.user-panel{display:flex;gap:10px;align-items:center;}
.btn{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#fff;box-shadow:0 8px 24px rgba(124,58,237,0.14);}
.btn.ghost{background:#fff;border:1px solid #e6eef8;color:#0f172a;box-shadow:none;font-weight:600;}
.token-indicator{font-size:13px;color:var(--muted);}

/* ----------------- ä¸»å¡ç‰‡ ----------------- */
.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.06);position:relative;}
.locked-overlay{position:absolute;inset:0;background:rgba(255,255,255,0.75);backdrop-filter:blur(3px);border-radius:14px;display:flex;align-items:center;justify-content:center;z-index:1000;}

/* æ§ä»¶ */
textarea#questionInput{width:100%;min-height:120px;border-radius:10px;padding:14px;border:1px solid #e6eef8;font-size:15px;resize:vertical;box-sizing:border-box;}
.control-row{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap;}
select,input[type=number]{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;font-size:14px;}
.right-actions{margin-left:auto;display:flex;align-items:center;gap:10px;}

/* ----------------- å›ç­”ä¸ä¾§æ å¸ƒå±€ ----------------- */
.answer-area{display:grid;grid-template-columns:72% 28%;gap:18px;margin-top:18px;}
.conversation{background:#fbfdff;border-radius:12px;border:1px solid #e6eef8;padding:16px;height:78vh;overflow:auto;box-sizing:border-box;}
.sidebar{background:#fff;border-radius:12px;border:1px solid #eef2ff;padding:12px;height:78vh;display:flex;flex-direction:column;box-sizing:border-box;overflow:hidden;}

/* å¯¹è¯æ°”æ³¡ */
.msg{display:flex;gap:10px;margin-bottom:14px;align-items:flex-start;}
.msg.user{justify-content:flex-end;}
.msg .bubble{max-width:92%;padding:12px 14px;border-radius:12px;font-size:15px;line-height:1.7;box-shadow:0 8px 20px rgba(2,6,23,0.04);}
.msg.user .bubble{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#fff;border-bottom-right-radius:4px;}
.msg.assistant .bubble{background:#fff;border:1px solid #eef2ff;color:#0f172a;border-bottom-left-radius:4px;white-space:pre-wrap;word-break:break-word;}

/* æ€è€ƒ/æ­£æ–‡åˆ†åŒºæ ·å¼ï¼ˆåµŒå…¥åˆ°åŠ©æ‰‹æ°”æ³¡ä¸­ï¼‰ */
.assistant-block{display:flex;flex-direction:column;gap:8px;}
.block-section{background:#f8fafc;border-radius:8px;padding:10px;border:1px solid #eef2ff;}
.section-title{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;}
.section-title .label{font-weight:700;color:#0f172a;font-size:13px;}
.section-body{margin-top:8px;font-size:14px;color:#0f172a;white-space:pre-wrap;word-break:break-word;line-height:1.8;}

/* ğŸ”¥ æ­£æ–‡å†…éƒ¨å…ƒç´ ä¼˜åŒ–æ ·å¼ */
.section-body p{margin:1.1em 0;line-height:1.8;}
.section-body p:first-child{margin-top:0;}
.section-body p:last-child{margin-bottom:0;}
.section-body h1,.section-body h2,.section-body h3,.section-body h4,.section-body h5,.section-body h6{margin:1.4em 0 0.7em 0;font-weight:700;line-height:1.4;color:#0f172a;}
.section-body h1{font-size:1.7em;border-bottom:2px solid #e6eef8;padding-bottom:0.3em;}
.section-body h2{font-size:1.4em;border-bottom:1px solid #e6eef8;padding-bottom:0.3em;}
.section-body h3{font-size:1.2em;}
.section-body h4{font-size:1.05em;}
.section-body ul,.section-body ol{margin:0.9em 0;padding-left:1.8em;line-height:1.8;}
.section-body ul{list-style-type:disc;}
.section-body ol{list-style-type:decimal;}
.section-body li{margin:0.5em 0;padding-left:0.3em;}
.section-body li>p{margin:0.3em 0;}
.section-body ul ul,.section-body ol ul{margin:0.4em 0;list-style-type:circle;}
.section-body code{background:#f5f7fa;padding:0.2em 0.4em;border-radius:3px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:0.88em;color:#e91e63;border:1px solid #e6eef8;}
.section-body pre{background:#f5f7fa;border:1px solid #e6eef8;border-radius:6px;padding:1em;margin:1em 0;overflow-x:auto;line-height:1.5;}
.section-body pre code{background:transparent;padding:0;border:none;color:#0f172a;font-size:0.9em;}
.section-body blockquote{margin:1em 0;padding:0.9em 1em;border-left:4px solid var(--accentA);background:#f8f9ff;color:#4a5568;font-style:italic;border-radius:4px;}
.section-body blockquote p{margin:0.4em 0;}
.section-body table{border-collapse:collapse;width:100%;margin:1em 0;font-size:0.92em;}
.section-body th,.section-body td{border:1px solid #e6eef8;padding:0.7em 0.9em;text-align:left;}
.section-body th{background:#f5f7fa;font-weight:700;color:#0f172a;}
.section-body tr:hover{background:#fafbfc;}
.section-body hr{border:none;border-top:2px solid #e6eef8;margin:1.8em 0;}
.section-body a{color:var(--accentA);text-decoration:none;border-bottom:1px solid transparent;transition:border-bottom 0.2s;}
.section-body a:hover{border-bottom:1px solid var(--accentA);}
.section-body strong{font-weight:700;color:#0f172a;}
.section-body em{font-style:italic;color:#4a5568;}
.section-body img{max-width:100%;height:auto;border-radius:6px;margin:0.9em 0;box-shadow:0 2px 6px rgba(0,0,0,0.08);}

/* æŠ˜å æŒ‰é’® */
.toggle-small{font-size:13px;color:var(--accentA);cursor:pointer;border:none;background:transparent;padding:4px 6px;}
.small-muted{font-size:12px;color:var(--muted);}

/* å‚è€ƒæ¥æºé¢æ¿ */
.references-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.references-list{overflow:auto;flex:1;padding-right:6px;}
.reference-item{background:#fff;border:1px solid #eef2ff;border-radius:8px;padding:10px;margin-bottom:10px;font-size:13px;line-height:1.6;}
.reference-meta{font-size:12px;color:var(--muted);margin-bottom:6px;}
.ref-keypassage{margin-top:8px;padding:10px;border-left:3px solid #f59e0b;background:#fff8e6;border-radius:6px;color:#92400e;font-size:13px;}

/* æ›´å¤šæ¥æºæŠ˜å æ§åˆ¶ */
.references-collapsed .references-list{max-height:200px;}
.references-expanded .references-list{max-height:unset;}

/* loader */
.loader{width:30px;height:30px;border-radius:50%;border:4px solid #eef2ff;border-top-color:var(--accentA);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* footer */
.footer{margin-top:12px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;align-items:center;}

/* ç™»å½•æ¨¡æ€ */
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:2000;}
.login-modal{width:460px;max-width:94%;background:#fff;border-radius:12px;padding:18px;box-shadow:0 24px 60px rgba(2,6,23,0.35);}
.login-row{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.login-row input{padding:10px;border-radius:8px;border:1px solid #e6eef8;font-size:14px;}
.login-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}

/* å“åº”å¼ */
@media (max-width:1000px){
  .answer-area{grid-template-columns:1fr;}
  .conversation,.sidebar{height:auto;min-height:360px;}
  .logo{width:46px;height:46px;}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">é—®</div>
      <div>
        <h1>å¤šè½®çŸ¥è¯†å¯¹è¯</h1>
        <div class="subtitle">å®½å± Â· æ”¯æŒå¤šè½® Â· æŠ˜å å‚è€ƒ Â· æ€è€ƒ/æ­£æ–‡åˆ†åŒºï¼ˆå†…ç½‘ï¼Œæ—  CDNï¼‰</div>
      </div>
    </div>

    <div class="user-panel">
      <div class="token-indicator" id="statusText">æœªç™»å½•</div>
      <button class="btn ghost" id="btnLogout" style="display:none">ç™»å‡º</button>
      <button class="btn" id="btnOpenLogin">ç™»å½•</button>
    </div>
  </header>

  <div class="card" id="mainCard">
    <div id="lockedOverlay" class="locked-overlay" style="display:none;">
      <div style="text-align:center;">
        <div style="font-weight:700;font-size:18px;">éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨</div>
        <div class="small-muted" style="margin-top:8px;">è¯·ç‚¹å‡»å³ä¸Šè§’ç™»å½•æŒ‰é’®è¿›è¡Œç™»å½•ï¼ˆç™»å½• API åœ°å€ç•™ç©ºä»¥ä¾¿å†…ç½‘è°ƒè¯•ï¼‰ã€‚</div>
      </div>
    </div>

    <textarea id="questionInput" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼ˆæ”¯æŒå¤šè½®å¯¹è¯ï¼‰ã€‚é¦–æ¬¡å‘é€ä¼šåˆ›å»º sessionï¼Œä¼šè¯ ID ä¿å­˜åœ¨æœ¬åœ°ï¼‰ã€‚"></textarea>

    <div class="control-row">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label class="small-muted">æ¨¡å‹</label>
        <select id="modelSelector">
          <option value="qwen3-32b">qwen3-32b</option>
          <option value="qwen2025">qwen2025</option>
          <option value="gpt-like">gpt-like</option>
        </select>

        <label class="small-muted">å‚è€ƒæ•°</label>
        <input type="number" id="rerankTopNInput" value="10" min="1" max="30" style="width:76px;">

        <label class="small-muted"><input type="checkbox" id="thinkingModeToggle" checked> æ€è€ƒæ¨¡å¼</label>
        <label class="small-muted"><input type="checkbox" id="insertBlockToggle"> ç²¾å‡†æ£€ç´¢</label>
      </div>

      <div class="right-actions">
        <div id="currentSession" class="small-muted">ä¼šè¯ï¼šæ— </div>
        <div id="liveLoader" style="display:none"><div class="loader"></div></div>
        <button id="submitBtn" class="btn" disabled>å‘é€</button>
      </div>
    </div>

    <div class="answer-area" style="margin-top:18px;">
      <div class="conversation" id="conversation">
        <div class="small-muted" id="welcomeNote">æ¬¢è¿ â€” è¯·å…ˆç™»å½•å¹¶å‘é€é—®é¢˜ä»¥å¼€å§‹å¤šè½®å¯¹è¯ã€‚æœåŠ¡å™¨ç«¯å¤šè½®æ¥å£ï¼š<code>/api/knowledge_chat_conversation</code>ï¼ˆSSE æˆ–æµå¼å“åº”ï¼‰ã€‚</div>
      </div>

      <div class="sidebar references-collapsed" id="sidebar">
        <div class="references-header">
          <div style="font-weight:700;">å‚è€ƒæ¥æº</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="small-muted" id="refCount">0 æ¡</div>
            <button id="toggleRefsBtn" class="toggle-small">æ›´å¤šæ¥æº â–¾</button>
          </div>
        </div>

        <div class="references-list" id="references" style="overflow:auto;"></div>

        <div style="margin-top:10px;">
          <button id="clearSessionBtn" class="btn ghost" style="width:100%;">æ¸…ç©ºä¼šè¯</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small-muted">å†…éƒ¨é™æ€èµ„æºä¼˜å…ˆ Â· ä¸ä¾èµ– CDN</div>
      <div class="small-muted">Â© å¤šè½®çŸ¥è¯†å¯¹è¯ç³»ç»Ÿ</div>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-overlay" style="display:none;">
  <div class="login-modal" role="dialog" aria-modal="true">
    <h3>ç³»ç»Ÿç™»å½•</h3>
    <div class="small-muted">ç™»å½•æˆåŠŸååç«¯è¿”å› map.put("token", jwt); map.put("error_msg", "success"); token å°†è¢«ç”¨äº Authorization: Bearer &lt;token&gt;</div>

    <div class="login-row">
      <input id="loginUsername" placeholder="ç”¨æˆ·å / å·¥å·" />
      <input id="loginPassword" type="password" placeholder="å¯†ç " />
    </div>

    <div class="login-actions">
      <button class="btn ghost" id="loginCancel">å–æ¶ˆ</button>
      <button class="btn" id="loginSubmit">ç™»å½•</button>
    </div>

    <div id="loginMsg" style="margin-top:10px;color:#ef4444;display:none;"></div>
  </div>
</div>

<script>
/*
  å®Œæ•´è¯´æ˜ï¼ˆå‰ç«¯è¡Œä¸ºï¼‰ï¼š
  - LOGIN_API ä¸ºç©ºæ—¶ï¼šæ‰§è¡Œæœ¬åœ°æ¨¡æ‹Ÿç™»å½•ï¼ˆç”¨äºå†…ç½‘/å¼€å‘ï¼‰
  - è‹¥è®¾ä¸ºçœŸå®ç™»å½•åœ°å€ï¼Œè¯·ç¡®ä¿åç«¯è¿”å› JSONï¼š{ "token": "jwt...", "error_msg": "success" }
  - CHAT_APIï¼š/api/knowledge_chat_conversation ï¼ˆåç«¯éœ€æ”¯æŒ SSE æˆ–æµå¼è¿”å›ï¼‰
  - SSE data å‰ç¼€æ”¯æŒï¼š
      SESSION:<session_id>
      CONTENT:<chunk>            (ç”¨äºè¡¥å……æ­£æ–‡)
      THINK:<chunk>              (ç”¨äºè¡¥å……æ€è€ƒè¿‡ç¨‹)
      SOURCE:<json>              (json è¡¨ç¤ºå‚è€ƒæ¥æºå¯¹è±¡)
      ERROR:<msg>
      DONE:
    å‰ç«¯å°†æŠŠ THINK å†…å®¹æ”¾åˆ°ã€Œæ€è€ƒè¿‡ç¨‹ã€åˆ†åŒºï¼ŒCONTENT æ”¾åˆ°ã€Œæ­£æ–‡ã€åˆ†åŒºã€‚
*/

const LOGIN_API = ""; // ä¿æŒä¸ºç©ºä»¥ç¬¦åˆè¦æ±‚ï¼ˆè‹¥æœ‰çœŸå®ç™»å½•æ¥å£ï¼Œæ›¿æ¢æ­¤å¤„ï¼‰
const CHAT_API = "/llm/api/knowledge_chat_conversation";
const STORAGE_TOKEN_KEY = "multi_turn_chat_jwt";
const STORAGE_SESSION_KEY = "multi_turn_chat_session_id";
const STORAGE_USER_KEY = "multi_turn_chat_user";

const loginModal = document.getElementById("loginModal");
const btnOpenLogin = document.getElementById("btnOpenLogin");
const btnLogout = document.getElementById("btnLogout");
const loginSubmit = document.getElementById("loginSubmit");
const loginCancel = document.getElementById("loginCancel");
const loginUsername = document.getElementById("loginUsername");
const loginPassword = document.getElementById("loginPassword");
const loginMsg = document.getElementById("loginMsg");
const statusText = document.getElementById("statusText");

const submitBtn = document.getElementById("submitBtn");
const questionInput = document.getElementById("questionInput");
const modelSelector = document.getElementById("modelSelector");
const rerankTopNInput = document.getElementById("rerankTopNInput");
const thinkingModeToggle = document.getElementById("thinkingModeToggle");
const insertBlockToggle = document.getElementById("insertBlockToggle");
const conversation = document.getElementById("conversation");
const references = document.getElementById("references");
const currentSessionEl = document.getElementById("currentSession");
const clearSessionBtn = document.getElementById("clearSessionBtn");
const liveLoader = document.getElementById("liveLoader");
const lockedOverlay = document.getElementById("lockedOverlay");
const welcomeNote = document.getElementById("welcomeNote");
const toggleRefsBtn = document.getElementById("toggleRefsBtn");
const sidebar = document.getElementById("sidebar");
const refCountEl = document.getElementById("refCount");

let jwtToken = localStorage.getItem(STORAGE_TOKEN_KEY) || null;
let sessionId = localStorage.getItem(STORAGE_SESSION_KEY) || null;
let username = localStorage.getItem(STORAGE_USER_KEY) || null;

updateLoginUI();

/* ------------------ ç™»å½•ç›¸å…³ ------------------ */
// ã€ä¿®å¤ã€‘ä½¿ç”¨æ­£ç¡®çš„å˜é‡å btnOpenLogin
btnOpenLogin.addEventListener("click", () => {
  loginMsg.style.display = "none";
  loginModal.style.display = "flex";
  loginUsername.value = username || "";
  loginPassword.value = "";
});
loginCancel.addEventListener("click", () => {
  loginModal.style.display = "none";
});
// ã€ä¿®å¤ã€‘ä½¿ç”¨æ­£ç¡®çš„å˜é‡å btnLogout
btnLogout.addEventListener("click", () => { logout(); });

loginSubmit.addEventListener("click", async () => {
  loginMsg.style.display = "none";
  const user = loginUsername.value.trim();
  const pass = loginPassword.value.trim();
  if (!user || !pass) {
    loginMsg.style.display = "block";
    loginMsg.textContent = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºã€‚";
    return;
  }
  loginSubmit.disabled = true;
  loginSubmit.textContent = "ç™»å½•ä¸­...";
  try {
    let tokenResp;
    if (!LOGIN_API) {
      // æ¨¡æ‹Ÿç™»å½•
      tokenResp = { token: "SIM_JWT_" + btoa(user).slice(0,24), error_msg: "success" };
      await new Promise(r => setTimeout(r, 350));
    } else {
      const resp = await fetch(LOGIN_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: user, password: pass })
      });
      if (!resp.ok) throw new Error("ç™»å½•è¯·æ±‚å¤±è´¥: " + resp.status);
      tokenResp = await resp.json();
    }

    if (!tokenResp || !tokenResp.token || tokenResp.error_msg !== "success") {
      throw new Error((tokenResp && tokenResp.error_msg) ? tokenResp.error_msg : "ç™»å½•è¿”å›æ ¼å¼å¼‚å¸¸");
    }

    jwtToken = tokenResp.token;
    username = user;
    localStorage.setItem(STORAGE_TOKEN_KEY, jwtToken);
    localStorage.setItem(STORAGE_USER_KEY, username);

    loginModal.style.display = "none";
    updateLoginUI();
    appendSystemMessage(`ç™»å½•æˆåŠŸï¼š${username}`);
  } catch (err) {
    console.error("login error", err);
    loginMsg.style.display = "block";
    loginMsg.textContent = "ç™»å½•å¤±è´¥ï¼š" + (err.message || err);
  } finally {
    loginSubmit.disabled = false;
    loginSubmit.textContent = "ç™»å½•";
  }
});

function updateLoginUI() {
  jwtToken = localStorage.getItem(STORAGE_TOKEN_KEY);
  sessionId = localStorage.getItem(STORAGE_SESSION_KEY);
  username = localStorage.getItem(STORAGE_USER_KEY);

  const loggedIn = !!jwtToken;
  statusText.textContent = loggedIn ? `å·²ç™»å½•ï¼š${username || 'ç”¨æˆ·'}` : "æœªç™»å½•";
  btnLogout.style.display = loggedIn ? "inline-block" : "none";
  btnOpenLogin.style.display = loggedIn ? "none" : "inline-block";

  submitBtn.disabled = !loggedIn;
  lockedOverlay.style.display = loggedIn ? "none" : "flex";
  currentSessionEl.textContent = "ä¼šè¯ï¼š" + (sessionId ? sessionId : "æ— ");
}

/* ------------------ ä¼šè¯æ¸…ç©º ------------------ */
clearSessionBtn.addEventListener("click", async () => {
  if (!sessionId) {
    appendSystemMessage("å½“å‰æ²¡æœ‰ä¼šè¯å¯æ¸…ç©ºã€‚");
    // ä»ç„¶æ¸…ç©ºæ˜¾ç¤º
    conversation.innerHTML = '<div class="small-muted" id="welcomeNote">ä¼šè¯å·²æ¸…ç©ºï¼Œè¯·é‡æ–°å‘é€é—®é¢˜å¼€å§‹æ–°çš„ä¼šè¯ã€‚</div>';
    references.innerHTML = '';
    refCountEl.textContent = '0 æ¡';
    return;
  }
  try {
    // å°è¯•åç«¯æ¸…ç©ºï¼ˆå¦‚æœæœ‰å®ç°ï¼‰
    await fetch("/llm/api/conversation/clear", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...(jwtToken ? { "Authorization": "Bearer " + jwtToken } : {}) },
      body: JSON.stringify({ session_id: sessionId })
    });
  } catch (e) {
    // å¿½ç•¥é”™è¯¯
  } finally {
    localStorage.removeItem(STORAGE_SESSION_KEY);
    sessionId = null;
    currentSessionEl.textContent = "ä¼šè¯ï¼šæ— ";
    // æ¸… UI
    conversation.innerHTML = '<div class="small-muted" id="welcomeNote">ä¼šè¯å·²æ¸…ç©ºï¼Œè¯·é‡æ–°å‘é€é—®é¢˜å¼€å§‹æ–°çš„ä¼šè¯ã€‚</div>';
    references.innerHTML = '';
    refCountEl.textContent = '0 æ¡';
    appendSystemMessage("æœ¬åœ°ä¼šè¯å·²æ¸…ç©ºã€‚");
  }
});

/* ------------------ æŠ˜å /å±•å¼€å‚è€ƒæ¥æº ------------------ */
let refsExpanded = false;
toggleRefsBtn.addEventListener("click", () => {
  refsExpanded = !refsExpanded;
  if (refsExpanded) {
    sidebar.classList.remove('references-collapsed');
    sidebar.classList.add('references-expanded');
    toggleRefsBtn.innerText = 'æ”¶èµ· â–´';
  } else {
    sidebar.classList.remove('references-expanded');
    sidebar.classList.add('references-collapsed');
    toggleRefsBtn.innerText = 'æ›´å¤šæ¥æº â–¾';
  }
});

/* ------------------ å‘é€/æ¥æ”¶æµå¼ï¼ˆSSE-likeï¼‰ ------------------ */
submitBtn.addEventListener("click", handleSubmit);
questionInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSubmit(); } });

let abortController = null;
let totalReferences = 0;

async function handleSubmit() {
  const question = questionInput.value.trim();
  if (!question) { alert("é—®é¢˜ä¸èƒ½ä¸ºç©º"); return; }
  if (!jwtToken) { alert("è¯·å…ˆç™»å½•"); return; }

  // UI
  submitBtn.disabled = true;
  liveLoader.style.display = 'inline-block';
  welcomeNote && (welcomeNote.style.display = "none");

  appendUserMessage(question);
  questionInput.value = "";

  const payload = {
    question: question,
    session_id: sessionId || null,
    thinking: !!thinkingModeToggle.checked,
    model_id: modelSelector.value,
    rerank_top_n: Number(rerankTopNInput.value || 10),
    use_insert_block: !!insertBlockToggle.checked
  };

  try {
    abortController && abortController.abort();
    abortController = new AbortController();

    const resp = await fetch(CHAT_API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + jwtToken
      },
      body: JSON.stringify(payload),
      signal: abortController.signal
    });

    if (!resp.ok) {
      throw new Error("æœåŠ¡å™¨è¿”å›é”™è¯¯: " + resp.status);
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    // åˆ›å»ºåŠ©æ‰‹å ä½ï¼ˆå«æ€è€ƒ/æ­£æ–‡åˆ†åŒºï¼‰
    const assistantBubbleEl = appendAssistantContainer();
    totalReferences = 0; // é‡ç½®æœ¬æ¬¡å›ç­”çš„å¼•ç”¨è®¡æ•°
    refCountEl.innerText = `${totalReferences} æ¡`;
    references.innerHTML = ''; // æ¸…ç©ºä¸Šæ¬¡çš„å¼•ç”¨

    // keep track of content
    let thinkingSoFar = "";
    let finalSoFar = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      // SSE-like blocks: split by "\n\n"
      let parts = buffer.split("\n\n");
      buffer = parts.pop();

      for (const part of parts) {
        const trimmed = part.trim();
        if (!trimmed) continue;
        // lines may start with "data:" or raw content; be flexible
        let raw = trimmed;
        if (raw.startsWith("data:")) raw = raw.substring(5).trim();

        // Prefix handling
        if (raw.startsWith("SESSION:")) {
          const sid = raw.substring("SESSION:".length).trim();
          if (sid) {
            sessionId = sid;
            localStorage.setItem(STORAGE_SESSION_KEY, sessionId);
            currentSessionEl.textContent = "ä¼šè¯ï¼š" + sessionId;
          }
        } else if (raw.startsWith("THINK:")) {
          const chunk = raw.substring("THINK:".length);
          thinkingSoFar += chunk;
          updateAssistantThinking(assistantBubbleEl, thinkingSoFar);
        } else if (raw.startsWith("CONTENT:")) {
          const chunk = raw.substring("CONTENT:".length);
          finalSoFar += chunk;
          updateAssistantFinal(assistantBubbleEl, finalSoFar);
        } else if (raw.startsWith("SOURCE:")) {
          const jsonStr = raw.substring("SOURCE:".length).trim();
          try {
            const src = JSON.parse(jsonStr);
            prependReference(src);
            totalReferences += 1;
            refCountEl.innerText = `${totalReferences} æ¡`;
          } catch (e) {
            console.warn("è§£æ SOURCE å¤±è´¥ï¼š", e, jsonStr);
          }
        } else if (raw.startsWith("ERROR:")) {
          const errMsg = raw.substring("ERROR:".length).trim();
          updateAssistantFinal(assistantBubbleEl, "å‘ç”Ÿé”™è¯¯ï¼š" + errMsg);
        } else if (raw.startsWith("DONE:")) {
          // nothing special
        } else {
          // å½“åšæ­£æ–‡ç»§ç»­è¿½åŠ ï¼ˆå…¼å®¹ä¸å¸¦å‰ç¼€çš„æµï¼‰
          finalSoFar += raw;
          updateAssistantFinal(assistantBubbleEl, finalSoFar);
        }
      }
    }

    // æµç»“æŸ
    liveLoader.style.display = 'none';
    submitBtn.disabled = false;
  } catch (err) {
    if (err.name === 'AbortError') {
        console.log('Fetch aborted.');
        appendSystemMessage("è¯·æ±‚å·²ä¸­æ­¢ã€‚");
    } else {
        console.error("è¯·æ±‚å¼‚å¸¸ï¼š", err);
        appendSystemMessage("è¯·æ±‚å¤±è´¥ï¼š" + (err.message || err));
    }
    liveLoader.style.display = 'none';
    submitBtn.disabled = false;
  } finally {
    updateLoginUI();
  }
}

/* ------------------ è¾…åŠ© UI æ“ä½œï¼ˆæ¶ˆæ¯è¿½åŠ ï¼‰ ------------------ */

function appendUserMessage(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerText = text;
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;
}

function appendAssistantContainer() {
  const div = document.createElement("div");
  div.className = "msg assistant";
  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const block = document.createElement("div");
  block.className = "assistant-block";

  const thinkingSection = document.createElement("div");
  thinkingSection.className = "block-section";
  thinkingSection.style.display = thinkingModeToggle.checked ? "block" : "none";

  const thinkingTitle = document.createElement("div");
  thinkingTitle.className = "section-title";
  thinkingTitle.innerHTML = `<span class="label">æ€è€ƒè¿‡ç¨‹</span><button class="toggle-small">æ”¶èµ·</button>`;
  const thinkingBody = document.createElement("div");
  thinkingBody.className = "section-body";
  thinkingBody.style.whiteSpace = "pre-wrap";
  thinkingBody.innerText = "";

  const finalSection = document.createElement("div");
  finalSection.className = "block-section";
  const finalTitle = document.createElement("div");
  finalTitle.className = "section-title";
  finalTitle.innerHTML = `<span class="label">æ­£æ–‡</span><span class="small-muted">ï¼ˆæœ€ç»ˆå›ç­”ï¼‰</span>`;
  const finalBody = document.createElement("div");
  finalBody.className = "section-body";
  finalBody.innerText = "";

  thinkingSection.appendChild(thinkingTitle);
  thinkingSection.appendChild(thinkingBody);
  finalSection.appendChild(finalTitle);
  finalSection.appendChild(finalBody);
  block.appendChild(thinkingSection);
  block.appendChild(finalSection);
  bubble.appendChild(block);
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;

  const tBtn = thinkingTitle.querySelector('button.toggle-small');
  tBtn.addEventListener('click', () => {
    if (thinkingBody.style.display === 'none') {
      thinkingBody.style.display = 'block';
      tBtn.innerText = 'æ”¶èµ·';
    } else {
      thinkingBody.style.display = 'none';
      tBtn.innerText = 'å±•å¼€';
    }
    conversation.scrollTop = conversation.scrollHeight;
  });

  return { thinkingBody, finalBody, thinkingSection };
}

function updateAssistantThinking(container, text) {
  if (!container) return;
  container.thinkingBody.innerText = text;
  conversation.scrollTop = conversation.scrollHeight;
}

function updateAssistantFinal(container, text) {
  if (!container) return;
  if (window.marked) {
    try {
      container.finalBody.innerHTML = window.marked.parse(text);
    } catch (e) {
      container.finalBody.innerText = text;
    }
  } else {
    container.finalBody.innerText = text;
  }
  conversation.scrollTop = conversation.scrollHeight;
}

function appendSystemMessage(text) {
  const div = document.createElement("div");
  div.className = "msg assistant";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.style.background = "linear-gradient(90deg,#eef6ff,#ffffff)";
  bubble.style.color = "#0f172a";
  bubble.innerText = text;
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;
}

/* ------------------ å‚è€ƒæ¥æºæ·»åŠ  ------------------ */
function prependReference(src) {
  const el = document.createElement('div');
  el.className = 'reference-item';

  const title = src.fileName || (`æ¥æº ${src.id || ''}`);
  const meta = `åˆå§‹åˆ†: ${src.initialScore ?? '-'} | é‡æ’åˆ†: ${src.rerankedScore ?? '-'} ${src.canAnswer ? ' | å¯å›ç­” âœ“' : ''}`;

  let html = `<div style="font-weight:700;margin-bottom:6px;">${escapeHtml(title)}</div>`;
  html += `<div class="reference-meta">${escapeHtml(meta)}</div>`;
  if (src.content) {
    html += `<div>${escapeHtml(src.content).replace(/\n/g,'<br>')}</div>`;
  }
  if (src.keyPassage) {
    html += `<div class="ref-keypassage">${escapeHtml(src.keyPassage)}</div>`;
  }
  if (src.url) {
    html += `<div style="margin-top:8px;"><a href="${escapeHtml(src.url)}" target="_blank" rel="noreferrer">æ‰“å¼€æ¥æº</a></div>`;
  }
  el.innerHTML = html;

  references.prepend(el);
}

/* ------------------ å·¥å…·å‡½æ•° ------------------ */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

/* ------------------ é¡µé¢è½½å…¥æ—¶è¡Œä¸º ------------------ */
window.addEventListener('load', () => {
  updateLoginUI();
  if (!jwtToken) {
    setTimeout(() => { loginModal.style.display = 'flex'; }, 200);
  } else {
    appendSystemMessage("æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œå¯ç»§ç»­å¤šè½®å¯¹è¯ã€‚");
  }
});

/* ------------------ ç™»å‡º ------------------ */
function logout() {
  localStorage.removeItem(STORAGE_TOKEN_KEY);
  localStorage.removeItem(STORAGE_SESSION_KEY);
  localStorage.removeItem(STORAGE_USER_KEY);
  jwtToken = null; sessionId = null; username = null;
  updateLoginUI();
  appendSystemMessage("å·²ç™»å‡ºï¼Œå½“å‰ä¼šè¯å¤±æ•ˆã€‚");
}

</script>

</body>
</html>