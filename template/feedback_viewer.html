<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åé¦ˆè®°å½•æŸ¥çœ‹å™¨</title>
    <style>
        @font-face {
          font-family: 'Noto Sans SC'; font-style: normal; font-weight: 400;
          src: url('../static/fonts/SourceHanSansSC-Regular.otf') format('opentype');
        }
        @font-face {
          font-family: 'Noto Sans SC'; font-style: normal; font-weight: 500;
          src: url('../static/fonts/SourceHanSansSC-Medium.otf') format('opentype');
        }
        @font-face {
          font-family: 'Noto Serif SC'; font-style: normal; font-weight: 700;
          src: url('../static/fonts/SourceHanSerifCN-Bold.otf') format('opentype');
        }
        body, html { margin: 0; font-family: "Noto Sans SC", sans-serif; background-color: #fafbfc; }
        .main-container { max-width: 960px; margin: 40px auto; padding: 20px; box-sizing: border-box; }
        h1 { font-family: "Noto Serif SC", serif; font-size: 36px; font-weight: 700; color: #1f2937; margin-bottom: 30px; text-align: center; }
        .info-bar { background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 12px; padding: 15px 25px; margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; font-size: 14px; color: #4b5563; }
        .info-bar strong { color: #1f2937; font-weight: 500; }
        .prompt-box, .answer-box { text-align: left; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; background-color: #fff; margin-top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box; }
        .box-title { margin-top: 0; font-size: 18px; color: #374151; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; }
        #questionDisplay { width: 100%; border-radius: 8px; border: 1px solid #d1d5db; background-color: #f9fafb; padding: 15px; font-size: 16px; color: #374151; resize: none; box-sizing: border-box; line-height: 1.6; font-family: "Noto Sans SC", sans-serif; }
        #answerText { width: 100%; box-sizing: border-box; white-space: pre-wrap; overflow-wrap: break-word; font-size: 15px; line-height: 1.7; color: #374151; min-height: 50px; }
        .thinking-section, .reference-section, .feedback-details-section { margin: 20px 0; border-radius: 12px; padding: 20px; position: relative; }
        .section-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; }
        .section-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; font-size: 14px; font-weight: bold; }
        .section-title { font-size: 16px; font-weight: 600; margin: 0; }
        .thinking-section { background: #f0f9ff; border: 1px solid #bae6fd; }
        .thinking-header { border-bottom: 1px solid #7dd3fc; }
        .thinking-icon { background: #3b82f6; }
        .thinking-title { color: #1e40af; }
        .thinking-content { color: #1e3a8a; font-size: 14px; line-height: 1.6; font-style: italic; background: rgba(255, 255, 255, 0.7); padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .reference-section { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .reference-header { border-bottom: 1px solid #86efac; }
        .reference-icon { background: #10b981; }
        .reference-title { color: #047857; }
        .reference-content { color: #064e3b; }
        .reference-item { margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; border: 1px solid #a7f3d0; }
        .reference-item.selected { border: 2px solid #10b981; background: rgba(16, 185, 129, 0.05); }
        .reference-filename { font-weight: 600; color: #065f46; margin-bottom: 8px; font-size: 15px; }
        .reference-similarity { font-size: 13px; color: #6b7280; margin-bottom: 10px; font-style: italic; }
        .reference-text { color: #374151; font-size: 14px; line-height: 1.6; background: #f9fafb; padding: 12px; border-radius: 6px; border-left: 3px solid #10b981; }
        .key-passage { background: #fef3c7; border-left: 3px solid #f59e0b; padding: 12px; margin-top: 10px; border-radius: 6px; font-size: 13px; color: #92400e; }
        .key-passage-label { font-weight: 600; color: #b45309; margin-bottom: 5px; }
        .normal-content { color: #374151; font-size: 15px; line-height: 1.7; margin: 10px 0; }
        .feedback-details-section { background: #fefce8; border: 1px solid #fde047; }
        .feedback-details-header { border-bottom: 1px solid #facc15; }
        .feedback-details-icon { background: #ca8a04; }
        .feedback-details-title { color: #854d0e; }
        .feedback-details-content p { margin: 0 0 10px 0; font-size: 14px; color: #854d0e; }
        .feedback-details-content p strong { font-weight: 600; min-width: 80px; display: inline-block; }
        .hidden { display: none; }
        .message-container { text-align: center; padding: 50px; font-size: 18px; color: #6b7280; }
    </style>
</head>
<body>
   <div id="appContainer" class="main-container hidden">
        <h1>åé¦ˆè®°å½•æŸ¥çœ‹å™¨</h1>
        <div class="info-bar">
            <div><strong>åé¦ˆID:</strong> <span id="infoId"></span></div>
            <div><strong>æ¨¡å‹ID:</strong> <span id="infoModelId"></span></div>
            <div><strong>åé¦ˆç±»å‹:</strong> <span id="infoFeedbackType"></span></div>
            <div><strong>åé¦ˆæ—¶é—´:</strong> <span id="infoCreatedAt"></span></div>
        </div>
        <div class="prompt-box">
            <h2 class="box-title">ç”¨æˆ·é—®é¢˜</h2>
            <textarea id="questionDisplay" readonly rows="5"></textarea>
        </div>
        <div id="answerBox" class="answer-box">
            <h2 class="box-title">æ¨¡å‹å›ç­”</h2>
            <div id="answerText"></div>
        </div>
        <div id="dislikeDetailsContainer" class="hidden">
             <div class="feedback-details-section">
                <div class="section-header feedback-details-header">
                    <div class="section-icon">âš ï¸</div>
                    <h3 class="section-title">å·®è¯„è¯¦æƒ…</h3>
                </div>
                <div class="feedback-details-content">
                    <p><strong>é”™è¯¯åŸå› :</strong> <span id="dislikeReason"></span></p>
                    <p><strong>å&nbsp;&nbsp;æ˜ &nbsp;&nbsp;äºº:</strong> <span id="dislikeReporterName"></span></p>
                    <p><strong>åæ˜ å•ä½:</strong> <span id="dislikeReporterUnit"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="messageContainer" class="message-container"></div>

<script src="/static/marked.min.js"></script>

<script>
    /**
     * æ ¹æ®ä¼ å…¥çš„åé¦ˆæ•°æ®ï¼Œæ¸²æŸ“æ•´ä¸ªé¡µé¢
     * @param {object} data - ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„ä¸€æ¡è®°å½•
     */
    function displayFeedback(data) {
        // console.log('æ¥æ”¶åˆ°çš„åé¦ˆæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯

        document.getElementById('infoId').textContent = data.feedbackId;
        document.getElementById('infoModelId').textContent = data.modelId;
        document.getElementById('infoCreatedAt').textContent = data.createAt;
        const feedbackTypeSpan = document.getElementById('infoFeedbackType');
        if (data.feedbackType === 'LIKE') {
            feedbackTypeSpan.textContent = 'ğŸ‘ ç‚¹èµ';
            feedbackTypeSpan.style.color = '#10b981';
        } else {
            feedbackTypeSpan.textContent = 'ğŸ‘ ç‚¹è¸©';
            feedbackTypeSpan.style.color = '#ef4444';
        }
        document.getElementById('questionDisplay').value = data.question;

        // ä¿®å¤æ¨¡å‹å›ç­”æ˜¾ç¤º
        const answerContainer = document.getElementById('answerText');
        let html = '';

        // æ£€æŸ¥answeræ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
        if (data.answer) {
            // console.log('æ¨¡å‹å›ç­”å†…å®¹:', data.answer); // è°ƒè¯•ä¿¡æ¯

            const thinkingRegex = /<think>(.*?)<\/think>/gs;
            const thinkMatch = thinkingRegex.exec(data.answer);
            let mainAnswerContent = data.answer;

            if (thinkMatch) {
                const beforeContent = data.answer.slice(0, thinkMatch.index).trim();
                const thinkingContent = thinkMatch[1].trim();
                const afterContent = data.answer.slice(thinkMatch.index + thinkMatch[0].length).trim();
                mainAnswerContent = (beforeContent + '\n' + afterContent).trim();
                html += `<div class="thinking-section"><div class="section-header thinking-header"><div class="section-icon">ğŸ’­</div><h3 class="section-title">æ€è€ƒè¿‡ç¨‹</h3></div><div class="thinking-content">${thinkingContent.replace(/\n/g, "<br>")}</div></div>`;
            }

            if (mainAnswerContent) {
                // æ£€æŸ¥æ˜¯å¦æœ‰markedåº“ï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                if (typeof marked !== 'undefined') {
                    html += `<div class="normal-content">${marked.parse(mainAnswerContent)}</div>`;
                } else {
                    // å¦‚æœæ²¡æœ‰markedåº“ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                    html += `<div class="normal-content">${mainAnswerContent.replace(/\n/g, "<br>")}</div>`;
                }
            }
        } else {
            html += `<div class="normal-content">æ— æ¨¡å‹å›ç­”å†…å®¹</div>`;
        }

        // ä¿®å¤æ¥æºæ˜¾ç¤º
        let sources = [];
        if (data.source && Array.isArray(data.source)) {
            sources = data.source;
            // console.log('æ¥æºæ•°æ®:', sources); // è°ƒè¯•ä¿¡æ¯
        }

        if (sources.length > 0) {
            let sourcesHtml = `<div class="reference-section"><div class="section-header reference-header"><div class="section-icon reference-icon">ğŸ“š</div><h3 class="section-title reference-title">å‚è€ƒå†…å®¹</h3></div><div class="reference-content">`;
            sources.forEach(item => {
                const selectedClass = item.canAnswer ? 'selected' : '';
                sourcesHtml += `<div class="reference-item ${selectedClass}">
                    <div class="reference-filename">[${item.id}] ${item.fileName}</div>
                    <div class="reference-similarity">
                        <span>åˆå§‹æ£€ç´¢åˆ†: ${item.initialScore || 'N/A'}</span> |
                        <span>é‡æ’åºåˆ†: ${item.rerankedScore || 'N/A'}</span>
                        ${item.canAnswer ? ' | <span style="color: #10b981; font-weight: 600;">âœ“ å¯å›ç­”</span>' : ' | <span style="color: #6b7280;">â—‹ ä¸å¯å›ç­”</span>'}
                    </div>
                    <div class="reference-text">"${(item.content || '').replace(/\n/g, "<br>")}"</div>`;
                if (item.keyPassage) {
                    sourcesHtml += `<div class="key-passage"><div class="key-passage-label">ğŸ” å…³é”®æ®µè½ï¼š</div>${item.keyPassage.replace(/\n/g, "<br>")}</div>`;
                }
                sourcesHtml += `</div>`;
            });
            sourcesHtml += `</div></div>`;
            html += sourcesHtml;
        }

        answerContainer.innerHTML = html;

        // ä¿®å¤å·®è¯„è¯¦æƒ…æ˜¾ç¤º
        if (data.feedbackType === 'DISLIKE') {
            // console.log('æ˜¾ç¤ºå·®è¯„è¯¦æƒ…'); // è°ƒè¯•ä¿¡æ¯
            // console.log('åŸå› :', data.reason);
            // console.log('æŠ¥å‘Šäºº:', data.reporterName);
            // console.log('æŠ¥å‘Šå•ä½:', data.reporterUnit);

            document.getElementById('dislikeReason').textContent = data.reason || '(æœªå¡«å†™)';
            document.getElementById('dislikeReporterName').textContent = data.reporterName || '(æœªå¡«å†™)';
            document.getElementById('dislikeReporterUnit').textContent = data.reporterUnit || '(æœªå¡«å†™)';
            document.getElementById('dislikeDetailsContainer').classList.remove('hidden');
        } else {
            // ç¡®ä¿LIKEç±»å‹æ—¶éšè—å·®è¯„è¯¦æƒ…
            document.getElementById('dislikeDetailsContainer').classList.add('hidden');
        }
    }

    /**
     * ä»åç«¯APIè·å–åé¦ˆæ•°æ®å¹¶è°ƒç”¨æ¸²æŸ“å‡½æ•°
     * @param {string | number} feedbackId - è¦è·å–çš„åé¦ˆè®°å½•ID
     */
    async function fetchFeedbackData(feedbackId) {
        const messageContainer = document.getElementById('messageContainer');
        const appContainer = document.getElementById('appContainer');
        messageContainer.textContent = 'æ­£åœ¨åŠ è½½æ•°æ®...';

        const API_ENDPOINT = `/api/feedback/show/${feedbackId}`;

        try {
            const response = await fetch(API_ENDPOINT);

            if (!response.ok) {
                throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            if(!result.success) {
                throw new Error(result.message);
            }

            // ä¿®æ­£ï¼šAPIè¿”å›çš„æ•°æ®åœ¨result.data.feedbackä¸­
            const feedbackData = result.data.feedback;

            messageContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            displayFeedback(feedbackData);

        } catch (error) {
             console.error("è·å–åé¦ˆæ•°æ®å¤±è´¥:", error);
            messageContainer.innerHTML = `<h1>è·å–æ•°æ®å¤±è´¥</h1><p>${error.message}</p>`;
        }
    }

    // --- æ–°å¢çš„è¾…åŠ©å‡½æ•° ---
    function formatSource(sources) {
        if (!sources || !Array.isArray(sources) || sources.length === 0) {
            return '<span style="color: #999;">ç„¡ä¾†æºè³‡æ–™</span>';
        }
        try {
            const sourceHtml = sources.map(source => {
                return `<div style="margin-bottom: 5px; padding: 3px; border-bottom: 1px solid #eee;">
                            <strong>æ–‡ä»¶å:</strong> ${source.fileName || 'N/A'} <br>
                            <small style="color: #666;">ID: ${source.id || 'N/A'}</small>
                        </div>`;
            }).join('');
            return sourceHtml;
        } catch (e) {
            console.error("è§£æSourceå¤±è´¥:", e, sources);
            return '<span style="color: red;">ä¾†æºè³‡æ–™æ ¼å¼éŒ¯èª¤</span>';
        }
    }

    async function fetchAndRenderFeedback() {
        const tbody = document.getElementById('feedback-tbody');
        if (!tbody) return; // å¦‚æœé¡µé¢æ²¡æœ‰è¡¨æ ¼å…ƒç´ ï¼Œè·³è¿‡

        try {
            const response = await fetch('/api/feedback/show/list');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message);
            }

            const feedbacks = result.data.feedbacks;
            tbody.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            feedbacks.forEach(item => {
                const row = `<tr>
                                <td>${item.feedbackId}</td>
                                <td>${item.feedbackType}</td>
                                <td><div class="td-content">${item.question}</div></td>
                                <td><div class="td-content">${item.answer}</div></td>
                                <td>${item.modelId || 'N/A'}</td>
                                <td><div class="td-content">${item.reason || ''}</div></td>
                                <td>${item.reporterName || ''}</td>
                                <td>${item.reporterUnit || ''}</td>
                                <td>${formatSource(item.source)}</td>
                                <td>${item.createAt}</td>
                                <td>${item.isProcessed ? 'æ˜¯' : 'å¦'}</td>
                            </tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="11">åŠ è½½æ•°æ®å¤±è´¥: ${error.message}</td></tr>`;
            console.error('åŠ è½½åé¦ˆæ•°æ®å¤±è´¥:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', fetchAndRenderFeedback);

    // --- é¡µé¢åŠ è½½æ—¶çš„å…¥å£é€»è¾‘ ---
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const feedbackId = urlParams.get('id');

        if (feedbackId) {
            fetchFeedbackData(feedbackId);
        } else {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '<h1>è¯·æä¾›ä¸€ä¸ªåé¦ˆID</h1><p>è¯·åœ¨URLä¸­é€šè¿‡æŸ¥è¯¢å‚æ•°æŒ‡å®šè¦æŸ¥çœ‹çš„åé¦ˆIDï¼Œä¾‹å¦‚ï¼š<code>feedback_viewer.html?id=101</code></p>';
        }
    };
</script>

</body>
</html>
