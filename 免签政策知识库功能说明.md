# 免签政策知识库功能说明

## 功能概述

本系统新增了免签政策知识库功能，能够智能识别用户问题是否与免签政策相关，并根据识别结果自动选择合适的知识库进行检索。

### 核心特性

1. **意图识别**：快速判断用户问题是否与免签政策相关
2. **双知识库架构**：维护独立的通用知识库和免签政策知识库
3. **智能检索策略**：
   - 免签相关问题：同时检索两个知识库，免签库权重更高（6个文档）
   - 非免签问题：只检索通用知识库（10个文档）
4. **无缝集成**：与现有RAG流程完全兼容，不影响原有功能

## 系统架构

```
用户问题
    │
    ▼
[意图识别] ──(非免签)──▶ [通用知识库] ──▶ [重排序] ──▶ [LLM] ──▶ 回答
    │
(免签相关)
    │
    ▼
[并行检索]
    ├── [通用知识库] (4个文档)
    └── [免签知识库] (6个文档)
        │
        ▼
    [结果融合] ──▶ [重排序] ──▶ [LLM] ──▶ 回答
```

## 配置说明

### 1. 环境变量配置（可选）

在 `.env` 文件中可以配置以下参数：

```bash
# 免签政策功能开关
ENABLE_VISA_FREE_FEATURE=true

# 免签知识库集合名称
VISA_FREE_COLLECTION=visa_free_knowledge_base

# 检索数量配置
VISA_FREE_RETRIEVAL_COUNT=6    # 从免签库检索的文档数
GENERAL_RETRIEVAL_COUNT=4      # 从通用库检索的文档数
```

### 2. 目录配置

系统会自动创建以下目录：

- **通用知识库**：`/opt/rag_final_project/knowledge_base`
- **免签知识库**：`/opt/rag_final_project/visa_free_knowledge_base`

### 3. 关键词配置

意图识别使用以下关键词（可在 `config/settings.py` 中修改）：

```python
VISA_FREE_KEYWORDS = [
    "免签", "签证豁免", "落地签", "电子签", "入境政策", 
    "签证", "过境签", "免签证", "签证政策", "入境要求",
    "护照", "停留期", "签证申请", "签证费用", "签证材料"
]
```

## 使用方法

### 1. 准备知识库文件

将免签政策相关的文档放入免签知识库目录：

```bash
/opt/rag_final_project/visa_free_knowledge_base/
├── 中国免签政策.txt
├── 各国签证要求.pdf
├── 入境政策汇总.docx
└── ...
```

### 2. 启动系统

系统启动时会自动：
1. 构建通用知识库索引
2. 构建免签知识库索引（如果启用）
3. 创建意图分类器
4. 创建多知识库检索器

启动日志示例：

```
[INFO] 使用默认模型 'qwen3-32b' 构建通用知识库索引...
[INFO] 【验证】通用知识库索引已创建
[INFO] 免签政策功能已启用，开始构建免签知识库...
[INFO] 【验证】免签政策知识库索引已创建
[INFO] 意图分类器初始化成功
[INFO] 多知识库检索器初始化成功
```

### 3. API调用

使用现有的知识问答API，无需修改调用方式：

```bash
POST /api/knowledge_chat_conversation
Content-Type: application/json

{
    "question": "去泰国需要签证吗？",
    "session_id": "your-session-id",
    "thinking": false,
    "model_id": "qwen3-32b"
}
```

### 4. 系统响应流程

#### 免签相关问题示例

**用户问题**：`"去泰国需要签证吗？"`

系统处理流程：
1. 意图识别：检测到关键词"签证" → 判定为免签相关
2. 并行检索：
   - 免签知识库：检索6个相关文档
   - 通用知识库：检索4个相关文档
3. 结果融合：合并10个文档（免签库文档优先）
4. 重排序：按相关性重新排序
5. LLM生成：基于检索结果生成回答

响应示例：
```
检测到免签相关问题...
正在从免签知识库和通用知识库检索...
已找到相关资料，正在生成回答...
[回答内容]
```

#### 非免签问题示例

**用户问题**：`"如何办理护照？"`

系统处理流程：
1. 意图识别：未匹配到免签关键词 → 判定为非免签问题
2. 单库检索：只从通用知识库检索10个文档
3. 重排序：按相关性排序
4. LLM生成：基于检索结果生成回答

响应示例：
```
正在进行混合检索...
已找到相关资料，正在生成回答...
[回答内容]
```

## 核心组件说明

### 1. 意图分类器 (`services/intent_classifier.py`)

**功能**：快速判断问题是否与免签政策相关

**方法**：
- `is_visa_related(question)`: 基于关键词匹配的快速判断
- `is_visa_related_with_llm(question)`: 基于LLM的精确判断（可选）

**特点**：
- 低延迟：关键词匹配，毫秒级响应
- 高准确率：覆盖常见免签相关术语
- 可扩展：支持LLM增强判断

### 2. 多知识库检索器 (`core/multi_kb_retriever.py`)

**功能**：并行检索多个知识库并融合结果

**方法**：
- `retrieve_from_both()`: 从两个知识库并行检索
- `retrieve_general_only()`: 只从通用知识库检索

**特点**：
- 权重控制：免签库6个文档，通用库4个文档
- 来源标记：自动标记文档来源（`kb_source`字段）
- 结果融合：免签库结果优先排列

### 3. 知识库服务扩展 (`services/knowledge_service.py`)

**新增方法**：
- `build_or_load_visa_free_index()`: 构建免签知识库索引
- `create_visa_free_retriever()`: 创建免签知识库检索器

**特点**：
- 独立管理：两个知识库完全独立
- 统一接口：使用相同的Qdrant客户端
- 自动检测：支持文件变化检测和增量更新

### 4. 知识处理器增强 (`api/knowledge_handler.py`)

**新增逻辑**：
- 意图识别流程
- 多知识库检索分支
- 智能检索策略选择

**特点**：
- 无缝集成：不影响现有功能
- 透明切换：自动选择检索策略
- 日志完善：详细记录处理流程

## 性能优化

### 1. 意图识别优化

- **关键词匹配**：O(n)复杂度，毫秒级响应
- **缓存机制**：可选的LLM判断结果缓存
- **快速失败**：非免签问题快速返回

### 2. 检索优化

- **并行检索**：两个知识库同时查询（可扩展为真正的异步）
- **数量控制**：精确控制每个库的检索数量
- **向量缓存**：Qdrant自动缓存向量索引

### 3. 内存优化

- **按需加载**：免签功能可选，不启用时不占用资源
- **共享资源**：两个知识库共享Embedding模型和Reranker

## 监控和日志

系统会记录以下关键信息：

```python
# 意图识别日志
[INFO] 检测到免签相关问题，匹配关键词: '签证'

# 检索日志
[INFO] 并行检索两个知识库: 免签库(6个) + 通用库(4个)
[INFO] 检索完成: 免签库6个 + 通用库4个 = 总计10个节点

# 重排序日志
[INFO] 多知识库检索找到 10 个节点, 选取前 10 个送入重排
[INFO] 重排序后有 10 个节点, 经过阈值 0.2 过滤后剩下 8 个
```

## 故障排查

### 问题1：免签知识库未生效

**症状**：所有问题都只从通用库检索

**排查步骤**：
1. 检查配置：`ENABLE_VISA_FREE_FEATURE=true`
2. 检查目录：免签知识库目录是否存在且有文件
3. 检查日志：是否有"免签政策知识库索引已创建"
4. 检查关键词：问题是否包含免签相关关键词

### 问题2：意图识别不准确

**症状**：免签问题未被识别或误识别

**解决方案**：
1. 调整关键词列表（`config/settings.py`）
2. 启用LLM增强判断（性能会降低）
3. 收集错误案例，优化关键词库

### 问题3：检索结果质量下降

**症状**：免签问题回答质量不如预期

**解决方案**：
1. 调整检索数量比例（默认6:4）
2. 检查免签知识库文档质量
3. 调整重排序阈值
4. 增加免签知识库文档数量

## 扩展建议

### 1. 支持更多专业知识库

可以参考免签知识库的实现，添加更多专业领域的知识库：

```python
# 在 config/settings.py 中添加
MEDICAL_KB_DIR = "/opt/rag_final_project/medical_knowledge_base"
LEGAL_KB_DIR = "/opt/rag_final_project/legal_knowledge_base"
```

### 2. 动态权重调整

根据问题类型动态调整知识库权重：

```python
def get_dynamic_weights(question_type):
    if question_type == "visa_urgent":
        return {"visa_free": 8, "general": 2}
    elif question_type == "visa_normal":
        return {"visa_free": 6, "general": 4}
    else:
        return {"visa_free": 0, "general": 10}
```

### 3. 意图识别增强

使用机器学习模型进行意图分类：

```python
# 训练意图分类模型
from sklearn.naive_bayes import MultinomialNB

classifier = MultinomialNB()
classifier.fit(training_data, labels)
```

## 总结

免签政策知识库功能通过以下方式提升了系统能力：

1. **专业性**：为免签政策提供专门的知识库
2. **智能性**：自动识别问题类型并选择检索策略
3. **灵活性**：可配置的权重和检索数量
4. **可扩展性**：易于添加更多专业知识库
5. **兼容性**：与现有系统完全兼容

该功能已完全集成到现有RAG系统中，无需修改API调用方式，对用户完全透明。
